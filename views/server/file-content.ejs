<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-Figtree">
  <head>
    <meta charset="UTF-8" />
    <title><%= name %> - <%= server.name %> File</title>

    <!-- Tailwind -->
    <link rel="stylesheet" href="/assets/tailwind.css">

    <!-- Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Monaco Editor -->
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
  </head>

  <body class="min-h-screen flex">
    <!-- Sidebar -->
    <%- include('../components/sidebar', { name: name, user: user }) %>

    <main class="flex-1 p-8 overflow-auto">
      <div class="max-w-6xl mx-auto space-y-6">
        <div
          class="bg-neutral-950 border border-neutral-900 rounded-2xl px-6 py-4 flex items-center justify-between"
        >
          <!-- LEFT INFO -->
          <div class="flex items-start gap-3">
            <!-- Status dot -->
            <span id="status-dot" class="mt-2"></span>
            <div class="leading-tight">
              <p class="text-lg font-semibold text-gray-100">
                <%= server.name %>
              </p>
              <p class="text-sm text-gray-400">
                <%= server.node?.ip || '0.0.0.0' %>:<%= server.port %>
                <span class="mx-1"></span>
                <%= server.node?.name || 'unknown' %>
              </p>
            </div>
          </div>
        </div>
        <div
          class="bg-neutral-950 border border-neutral-800 rounded-xl p-2 flex items-center"
        >
          <!-- LEFT: Current Path -->
          <div
            class="flex items-center gap-1 text-sm font-medium text-gray-200"
          >
            <i data-lucide="folder" class="w-3 h-3"></i>
            <% // location is a QUERY PARAM STRING like "//eula.txt" const
            safePath = (typeof location === 'string' ? location :
            '/').replace(/\/+/g, '/'); const pathParts =
            safePath.split('/').filter(Boolean); let accumulatedPath = ''; %>

            <span class="flex items-center gap-1">
              <a href="/server/files/<%= server.id %>?path=/" class="hover:underline">root</a>

              <% pathParts.forEach((part, index) => { accumulatedPath += '/' +
              part; %>
              <span>/</span>

              <% if (index < pathParts.length - 1) { %>
              <a
                href="/server/files/<%= server.id %>?path=<%= encodeURIComponent(accumulatedPath) %>"
                class="hover:underline text-sm"
              >
                <%= part %>
              </a>
              <% } else { %>
              <span class="text-gray-400 text-sm"><%= part %></span>
              <% } %> <% }) %>
            </span>
          </div>
        </div>

        <!-- Editor Container -->
        <div
          class="bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden"
        >
          <div
            class="border-b border-neutral-800 px-4 py-2 text-sm text-gray-400 flex items-center gap-2"
          >
            <i data-lucide="code"></i> Talorix Editor | Powered by monaco-editor
          </div>

          <div id="editor" class="h-[70vh]"></div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-2">
          <button
            id="saveBtn"
            class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-xl flex items-center gap-2"
          >
            <i data-lucide="save"></i> Save
          </button>
        </div>
      </div>
    </main>

    <script>
      lucide.createIcons();

      const filename = "<%= location.split('/').pop() %>";

      function getLanguageFromFilename(filename) {
        if (!filename.includes(".")) return "plaintext";

        const ext = filename.split(".").pop().toLowerCase();

        const map = {
          js: "javascript",
          ts: "typescript",
          json: "json",
          html: "html",
          css: "css",
          scss: "scss",
          md: "markdown",
          yml: "yaml",
          yaml: "yaml",
          py: "python",
          sh: "shell",
          bash: "shell",
          php: "php",
          go: "go",
          java: "java",
          c: "c",
          cpp: "cpp",
          rs: "rust",
          sql: "sql",
        };

        return map[ext] || "plaintext";
      }

      const language = getLanguageFromFilename(filename);

      require.config({
        paths: { vs: "https://unpkg.com/monaco-editor@0.45.0/min/vs" },
      });

      let editor;

      require(["vs/editor/editor.main"], function () {
        editor = monaco.editor.create(document.getElementById("editor"), {
          value: `<%- JSON.stringify(content).slice(1, -1) %>`,
          language,
          theme: "vs-dark",
          automaticLayout: true,
          fontSize: 14,
          minimap: { enabled: false },
        });
      });
      const saveBtn = document.getElementById("saveBtn");

      saveBtn.addEventListener("click", async () => {
        if (saveBtn.disabled) return; // safety guard

        saveBtn.disabled = true;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "Saving...";

        try {
          const content = editor.getValue();

          const res = await fetch(
            `/server/files/<%= server.id %>/new-file?path=<%= encodeURIComponent(
        location.split("/").slice(0, -1).join("/") || "/"
      ) %>`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                filename: "<%= location.split('/').pop() %>",
                content,
              }),
            }
          );

          if (!res.ok) throw new Error("Save failed");

          alert("File saved successfully");
        } catch (err) {
          console.error(err);
          alert("Failed to save file");
        } finally {
          // ALWAYS re-enable
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        }
      });
    </script>
  </body>
</html>
