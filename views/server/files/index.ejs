<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-neutral-100 font-Figtree">

<head>
  <meta charset="UTF-8" />
  <title>
    <%= name %> - <%= server.name %> Files
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <!-- Tailwind script (included as requested) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    button,
    a {
      transition: all 0.2s ease-in-out;
    }

    .file-name mark {
      transition: background-color 0.15s ease, color 0.15s ease;
      padding-left: 2px;
      padding-right: 2px;
      border-radius: 2px;
    }

    /* small helper for sliding bottom bar */
    .blow-up-enter {
      transform: translateY(120%);
      opacity: 0;
    }

    .blow-up-enter-active {
      transform: translateY(0);
      opacity: 1;
      transition: transform 220ms ease, opacity 220ms ease;
    }

    .blow-up-leave {
      transform: translateY(0);
      opacity: 1;
    }

    .blow-up-leave-active {
      transform: translateY(120%);
      opacity: 0;
      transition: transform 180ms ease, opacity 180ms ease;
    }
  </style>
</head>

<body class="min-h-screen flex">
  <!-- Sidebar -->
  <%- include('../../components/sidebar', { name: name, user: user }) %>

    <main class="flex-1 p-8 overflow-auto">
      <div class="max-w-6xl mx-auto space-y-6">
        <div class="bg-neutral-950 border border-neutral-900 rounded-2xl px-6 py-4 flex items-center justify-between">
          <!-- LEFT INFO -->
          <div class="flex items-start gap-3">
            <!-- Status dot -->
            <span id="status-dot" class="mt-2"></span>
            <div class="leading-tight">
              <p class="text-lg font-semibold text-gray-100">
                <%= server.name %>
              </p>
              <p class="text-sm text-gray-400">
                <%= server.node?.ip || '0.0.0.0' %>:<%= server.port %>
                    <span class="mx-1"></span>
                    <%= server.node?.name || 'unknown' %>
              </p>
            </div>
          </div>
        </div>
          <div class="bg-neutral-950 border border-neutral-800 rounded-xl p-2 flex items-center">
            <!-- LEFT: Current Path -->
            <div class="flex items-center gap-1 text-sm font-medium text-gray-200">
              <i data-lucide="folder" class="w-3 h-3"></i>
              <% const pathParts=path.split('/').filter(Boolean); let accumulatedPath='' ; %>
                <span class="flex items-center gap-1">
                  <a href="?path=/" class="hover:underline">root</a>
                  <% pathParts.forEach((part, index)=> { accumulatedPath += '/' +
                    part; %>
                    <span>/</span>
                    <% if (index < pathParts.length - 1) { %>
                      <a href="?path=<%= encodeURIComponent(accumulatedPath) %>" class="hover:underline text-sm">
                        <%= part %>
                      </a>
                      <% } else { %>
                        <span class="text-gray-400 text-sm">
                          <%= part %>
                        </span>
                        <% } %>
                          <% }) %>
                </span>
            </div>

            <!-- RIGHT side actions + search -->
            <div class="ml-auto flex items-center gap-2 flex-wrap">
              <button id="newFileBtn"
                class="font-semibold px-3 py-1.5 bg-gray-100 text-stone-900 hover:bg-neutral-300 rounded-md flex items-center gap-1.5 text-sm shadow hover:shadow-md">
                <i data-lucide="file" class="w-4 h-4"></i> New File
              </button>

              <button id="newFolderBtn"
                class="font-semibold px-3 py-1.5 bg-gray-100 text-stone-900 hover:bg-neutral-300 rounded-md flex items-center gap-1.5 text-sm shadow hover:shadow-md">
                <i data-lucide="folder-plus" class="w-4 h-4"></i> New Folder
              </button>

              <button id="uploadFileBtn"
                class="font-semibold px-3 py-1.5 bg-gray-100 text-stone-900 hover:bg-neutral-300 rounded-md flex items-center gap-1.5 text-sm shadow hover:shadow-md">
                <i data-lucide="upload" class="w-4 h-4"></i> Upload File
              </button>

              <input type="file" id="uploadFileInput" class="hidden" multiple />

              <!-- Selection toggle + count -->
              <!--button id="toggleSelectBtn"
                class="flex items-center gap-2 px-3 py-1.5 border border-neutral-800 rounded-md text-sm hover:bg-neutral-900"
                title="Toggle multi-select">
                <i data-lucide="check-square" class="w-4 h-4"></i>
                <span id="selectBtnLabel">Select</span>
                <span id="selectedCountBadge"
                  class="ml-1 px-2 py-0.5 rounded-full text-xs bg-neutral-800 text-neutral-300 hidden">0</span>
              </button-->

              <!-- Search -->
              <div class="relative">
                <i data-lucide="search" class="absolute left-2 top-1/2 -translate-y-1/2 text-neutral-400 w-3 h-3"></i>
                <input id="searchInput" type="text" placeholder="Search..."
                  class="pl-7 pr-2 py-1.5 text-sm bg-neutral-900 border border-neutral-800 rounded-md text-gray-100 placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-neutral-700" />
              </div>
            </div>
          </div>

          <div class="bg-neutral-950 border border-neutral-900 rounded-lg overflow-hidden">
            <table class="w-full table-auto text-left border-collapse">
              <thead class="text-neutral-400 uppercase text-xs border-b border-neutral-800">
                <tr>
                  <th class="px-4 py-2 w-12">
                    <input id="selectAllCheckbox" type="checkbox" class="w-4 h-4 rounded border border-neutral-700 bg-neutral-900 accent-neutral-300 hover:border-neutral-500 focus:ring-2 focus:ring-neutral-600 focus:ring-offset-2 focus:ring-offset-neutral-950 transition" />
                  </th>
                  <th class="px-4 py-2">Name</th>
                  <th class="px-4 py-2">Size</th>
                  <th class="px-4 py-2">Created</th>
                  <th class="px-4 py-2">Actions</th>
                </tr>
              </thead>
              <tbody id="filesTbody">
                <% const sortedFiles=files.sort((a,b)=> (a.type === 'folder' &&
                  b.type !== 'folder') ? -1 : (a.type !== 'folder' && b.type ===
                  'folder') ? 1 : 0); sortedFiles.forEach(file => { %>
                  <tr class="file-row border-b border-neutral-800 hover:bg-neutral-900/50 transition-colors"
                    data-name="<%= (file.name || '').toLowerCase() %>" data-type="<%= file.type %>"
                    data-path="<%= path === '/' ? '' : path + '/' %><%= file.name %>">
                    <!-- NEW: checkbox cell -->
                    <td class="px-4 py-2">
                      <input type="checkbox" class="row-checkbox w-4 h-4 rounded border border-neutral-700 bg-neutral-900 accent-neutral-300 hover:border-neutral-500 focus:ring-2 focus:ring-neutral-600 focus:ring-offset-2 focus:ring-offset-neutral-950 transition" />
                    </td>

                    <td class="px-4 py-2 flex items-center gap-2">
                      <% if (file.type==='folder' ) { %>
                        <!-- Folder: navigate -->
                        <a href="?path=<%= encodeURIComponent(path + '/' + file.name) %>"
                          class="text-neutral-100 hover:text-neutral-300 hover:underline flex items-center gap-2 font-medium">
                          <i data-lucide="folder-closed"></i>
                          <span class="file-name">
                            <%= file.name %>
                          </span>
                        </a>

                        <% } else { const isJar=file.name.toLowerCase().endsWith('.jar'); const
                          ext=file.name.includes('.') ? file.name.split('.').pop().toLowerCase() : '' ; const
                          fileIconsMap={ js:'code', ts:'code', json:'file-braces', html:'code', css:'file-css',
                          scss:'file-css', md:'file-text', py:'file-text', sh:'terminal', txt:'file-text',
                          jar:'archive', default:'file' }; const fileIcon=fileIconsMap[ext] || fileIconsMap.default; %>
                          <% if (!isJar) { %>
                            <!-- File: click opens editor -->
                            <a href="/server/files/<%= server.id %>/content?location=<%= encodeURIComponent(path + '/' + file.name) %>"
                              class="flex items-center gap-2 text-neutral-100 hover:text-neutral-300 hover:underline cursor-pointer">
                              <i data-lucide="<%= fileIcon %>"></i>
                              <span class="file-name">
                                <%= file.name %>
                              </span>
                            </a>
                            <% } else { %>
                              <!-- JAR: not editable -->
                              <span class="flex items-center gap-2 text-neutral-400 cursor-not-allowed">
                                <i data-lucide="<%= fileIcon %>"></i>
                                <span class="file-name">
                                  <%= file.name %>
                                </span>
                              </span>
                              <% } %>
                                <% } %>
                    </td>

                    <td class="px-4 py-2 capitalize">
                      <%= formatSize(file.size) %>
                    </td>
                    <td class="px-4 py-2">
                      <%= new Date(file.createdAt).toLocaleString() %>
                    </td>
                    <td class="px-4 py-2 relative">
                      <button
                        class="dropdownBtn px-3 py-1 rounded-xl text-neutral-100 shadow hover:shadow-lg transition">
                        <i data-lucide="more-vertical"></i>
                      </button>
                      <div
                        class="dropdownMenu transition-all scale-95 opacity-0 absolute right-0 mt-1 bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg hidden flex flex-col z-50 min-w-[120px]">
                        <form method="POST"
                          action="/server/files/<%= server.id %>/<%= file.type %>/delete?location=<%= encodeURIComponent(path + '/' + file.name) %>"
                          onsubmit="return confirm('Delete <%= file.name %>?');">
                          <button type="submit" class="text-left px-4 py-2 hover:bg-red-700 rounded-xl text-red-500">
                            Delete
                          </button>
                        </form>
                        <button class="renameBtn text-left px-4 py-2 hover:bg-neutral-800 rounded-xl"
                          data-type="<%= file.type %>" data-name="<%= file.name %>"
                          data-path="<%= path === '/' ? '' : path + '/' %><%= file.name %>">
                          Rename
                        </button>
                      </div>
                    </td>
                  </tr>
                  <% }) %>

                    <!-- No results row (hidden by default) -->
                    <tr id="noResultsRow" class="hidden">
                      <td colspan="5" class="px-4 py-6 text-neutral-500 italic">
                        No files match your search.
                      </td>
                    </tr>
              </tbody>
            </table>
          </div>
      </div>
    </main>

    <!-- Rename/Create Modal -->
    <div id="modalOverlay"
      class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
      <div id="modalPanel" role="dialog" aria-modal="true" aria-labelledby="modalTitle"
        class="relative z-10 max-w-lg w-full mx-4 rounded-lg bg-neutral-900 text-neutral-100 shadow-xl ring-1 ring-black/10 overflow-hidden transform transition-all duration-200 ease-out scale-95 opacity-0">
        <div class="p-6">
          <div class="flex items-start gap-4">
            <div class="flex-1">
              <h2 id="modalTitle" class="text-lg font-semibold">New File</h2>
              <p class="mt-1 text-sm text-neutral-400">
                Enter a name for your file or folder.
              </p>
            </div>
          </div>

          <div class="mt-4 flex flex-col gap-3">
            <input id="modalInput"
              class="w-full p-3 rounded-2xl bg-neutral-800 border border-neutral-700 text-neutral-100"
              placeholder="Name" />
            <textarea id="modalContent"
              class="w-full p-3 rounded-2xl bg-neutral-800 border border-neutral-700 hidden h-32 text-neutral-100"
              placeholder="Content (for file)"></textarea>
          </div>

          <div class="mt-6 flex justify-end gap-3">
            <button id="modalCancel"
              class="px-4 py-2 rounded-lg text-sm text-stone-500 hover:text-gray-300 hover:bg-neutral-800">
              Cancel
            </button>
            <button id="modalConfirm"
              class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm bg-gray-100 hover:bg-red-300 text-stone-900">
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex flex-col items-center justify-center z-50 p-6">
      <h2 class="text-2xl font-bold mb-4 text-white">Uploading Files...</h2>
      <div class="w-full max-w-lg bg-neutral-800 rounded-xl overflow-hidden h-6 mb-2">
        <div id="uploadBar" class="bg-green-500 h-6 w-0"></div>
      </div>
      <p id="uploadStatus" class="text-white font-medium"></p>
    </div>

    <!-- DELETE PROGRESS MODAL -->
    <div id="deleteProgressModal"
      class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-60 p-6" aria-hidden="true">
      <div class="w-full max-w-2xl bg-neutral-950 rounded-2xl p-6 shadow-lg">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h3 id="deleteProgressTitle" class="text-lg font-semibold text-gray-100">Deleting files</h3>
            <p id="deleteProgressSub" class="text-sm text-neutral-400 mt-1">Queued files will be deleted one-by-one.</p>
          </div>
          <div>
            <button id="deleteProgressClose" class="text-sm px-3 py-1 rounded-md hover:bg-neutral-800">Close</button>
          </div>
        </div>

        <div class="mt-4">
          <div class="w-full bg-neutral-800 rounded-full h-4 overflow-hidden">
            <div id="deleteProgressBar" class="h-4 w-0 bg-gray-100 transition-all"></div>
          </div>
          <div class="mt-3 flex items-center justify-between text-sm text-neutral-300">
            <span id="deleteProgressLabel">0 / 0</span>
            <span id="deleteProgressCurrent" class="italic">Waiting to start...</span>
          </div>
        </div>

        <div class="mt-5 flex justify-end gap-2">
          <button id="deleteProgressCancel"
            class="px-4 py-2 rounded-lg text-sm bg-neutral-800 hover:bg-neutral-700">Abort</button>
        </div>
      </div>
    </div>

    <!-- Sliding (blowing) action bar -->
   <div id="actionBar"
  class="fixed inset-x-0 bottom-6 z-50 translate-y-32 opacity-0 pointer-events-none transition-all duration-300 flex justify-center">
  
  <div
    class="w-full max-w-3xl mx-4 bg-neutral-900 border border-neutral-800 rounded-2xl px-4 py-3 shadow-lg flex items-center justify-between gap-4">

    <div class="flex items-center gap-3">
      <div class="flex flex-col">
        <span id="actionSelectedCount" class="text-sm font-semibold text-gray-100">
          0 selected
        </span>
        <span id="actionSelectedList" class="text-xs text-neutral-400 hidden"></span>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button id="deleteSelectedBtn"
        class="flex items-center gap-2 whitespace-nowrap px-6 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white shadow">
        <i data-lucide="trash-2" class="w-4 h-4"></i>
        Delete Files
      </button>

      <button id="clearSelectionBtn"
        class="px-3 py-2 rounded-lg bg-neutral-800 hover:bg-neutral-700 text-neutral-200">
        Clear
      </button>
    </div>

  </div>
</div>


    <script>
      lucide.createIcons();
      function escapeHtml(s) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return String(s).replace(/[&<>"']/g, (m) => map[m]);
      }


      (function () {
        // --- File search/filter --- (kept unchanged except selector change)
        const searchInput = document.getElementById("searchInput");
        const tbody = document.getElementById("filesTbody");
        const rows = Array.from(tbody.querySelectorAll("tr.file-row"));
        const noResultsRow = document.getElementById("noResultsRow");
        const DEBOUNCE_MS = 200;

        function escapeRegExp(str) {
          return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        }
        function highlightMatch(el, query) {
          const nameSpan = el.querySelector(".file-name");
          if (!nameSpan) return;
          const raw = nameSpan.textContent || "";
          if (!query) {
            nameSpan.innerHTML = escapeHtml(raw);
            return;
          }
          try {
            const re = new RegExp("(" + escapeRegExp(query) + ")", "ig");
            nameSpan.innerHTML = escapeHtml(raw).replace(
              re,
              '<mark class="bg-yellow-400/20 text-yellow-300 rounded px-0.5">$1</mark>'
            );
          } catch {
            nameSpan.innerHTML = escapeHtml(raw);
          }
        }

        function parseQuery(q) {
          const res = { text: "", ext: null, type: null };
          if (!q) return res;
          q = q.trim();
          const tokens = q.split(/\s+/);
          const remaining = [];
          tokens.forEach((tok) => {
            const lower = tok.toLowerCase();
            if (lower.startsWith("ext:")) res.ext = lower.slice(4);
            else if (lower.startsWith("type:")) res.type = lower.slice(5);
            else remaining.push(tok);
          });
          res.text = remaining.join(" ");
          return res;
        }

        function filterRows(rawQuery) {
          const q = parseQuery(rawQuery);
          const queryText = (q.text || "").toLowerCase();
          let visibleCount = 0;

          rows.forEach((row) => {
            const name = (row.dataset.name || "").toLowerCase();
            const type = (row.dataset.type || "").toLowerCase();
            let extMatch = true;
            if (q.ext) {
              const dotIndex = name.lastIndexOf(".");
              const ext = dotIndex !== -1 ? name.slice(dotIndex + 1) : "";
              extMatch = ext === q.ext;
            }
            let typeCheck = true;
            if (q.type) typeCheck = type === q.type;
            let textMatch = true;
            if (queryText) textMatch = name.includes(queryText);
            const show = extMatch && typeCheck && textMatch;

            if (show) {
              row.classList.remove("hidden");
              row.classList.remove("opacity-0");
              if (queryText) highlightMatch(row, queryText);
              else highlightMatch(row, null);
              visibleCount++;
            } else {
              row.classList.add("hidden");
            }
          });

          if (visibleCount === 0) noResultsRow.classList.remove("hidden");
          else noResultsRow.classList.add("hidden");
        }

        let timer = null;
        function onInput() {
          clearTimeout(timer);
          timer = setTimeout(() => filterRows(searchInput.value || ""), DEBOUNCE_MS);
        }

        if (searchInput) {
          searchInput.addEventListener("input", onInput);
          searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              searchInput.value = "";
              filterRows("");
            } else if (e.key === "Enter") {
              const first = tbody.querySelector(
                "tr.file-row:not(.hidden) .file-name"
              );
              if (first) first.scrollIntoView({ block: "nearest", behavior: "smooth" });
            }
          });
        }
      })();

      // --- Modal logic --- (unchanged)
      const modalOverlay = document.getElementById("modalOverlay");
      const modalPanel = document.getElementById("modalPanel");
      const modalTitle = document.getElementById("modalTitle");
      const modalInput = document.getElementById("modalInput");
      const modalContent = document.getElementById("modalContent");
      const modalConfirm = document.getElementById("modalConfirm");
      const modalCancel = document.getElementById("modalCancel");

      let modalMode = null;
      let modalTarget = null;

      function showModal() {
        modalOverlay.classList.remove("hidden");
        requestAnimationFrame(() => {
          modalPanel.classList.remove("scale-95", "opacity-0");
          modalPanel.classList.add("scale-100", "opacity-100");
        });
      }

      function hideModal() {
        modalPanel.classList.remove("scale-100", "opacity-100");
        modalPanel.classList.add("scale-95", "opacity-0");
        setTimeout(() => modalOverlay.classList.add("hidden"), 200);
      }

      function openModal(type) {
        modalMode = type;
        modalTarget = null;
        modalTitle.textContent = type === "file" ? "New File" : "New Folder";
        modalInput.value = "";
        modalContent.value = "";
        modalConfirm.dataset.type = type;
        showModal();
      }

      function openRenameModal(type, name, relPath) {
        modalMode = "rename";
        modalTarget = { type, name, path: relPath };
        modalTitle.textContent = `Rename ${type}`;
        modalInput.value = name;
        modalContent.classList.add("hidden");
        modalConfirm.dataset.type = type;
        showModal();
      }

      modalCancel.onclick = hideModal;
      document.getElementById("newFileBtn").onclick = () => openModal("file");
      document.getElementById("newFolderBtn").onclick = () => openModal("folder");

      modalConfirm.onclick = () => {
        if (!modalInput.value.trim()) return alert("Name required");
        if (modalMode === "rename" && modalTarget) {
          const form = document.createElement("form");
          form.method = "POST";
          form.action = `/server/files/<%= server.id %>/${modalTarget.type}/rename`;
          form.innerHTML = `
        <input type="hidden" name="location" value="${modalTarget.path}">
        <input type="hidden" name="newName" value="${modalInput.value}">
      `;
          document.body.appendChild(form);
          form.submit();
        } else {
          const type = modalConfirm.dataset.type;
          const form = document.createElement("form");
          form.method = "POST";
          form.action = `/server/files/<%= server.id %>/${type === "file" ? "new-file" : "new-folder"
            }?path=<%= encodeURIComponent(path) %>`;
          form.innerHTML = `
        <input type="hidden" name="filename" value="${modalInput.value}">
        ${type === "file"
              ? `<input type="hidden" name="content" value="${modalContent.value}">`
              : ""
            }
      `;
          document.body.appendChild(form);
          form.submit();
        }
      };

      // --- Dropdown buttons --- (kept)
      document.querySelectorAll(".dropdownBtn").forEach((btn) => {
        const menu = btn.nextElementSibling;
        btn.onclick = (e) => {
          e.stopPropagation();
          document.querySelectorAll(".dropdownMenu").forEach((m) => {
            if (m !== menu && !m.classList.contains("hidden")) {
              m.classList.add("scale-95", "opacity-0");
              setTimeout(() => m.classList.add("hidden"), 150);
            }
          });
          if (menu.classList.contains("hidden")) {
            menu.classList.remove("hidden");
            requestAnimationFrame(() => {
              menu.classList.remove("scale-95", "opacity-0");
              menu.classList.add("scale-100", "opacity-100");
            });
          } else {
            menu.classList.add("scale-95", "opacity-0");
            setTimeout(() => menu.classList.add("hidden"), 150);
          }
        };
      });

      document.addEventListener("click", () => {
        document.querySelectorAll(".dropdownMenu").forEach((menu) => {
          if (!menu.classList.contains("hidden")) {
            menu.classList.add("scale-95", "opacity-0");
            setTimeout(() => menu.classList.add("hidden"), 150);
          }
        });
      });

      document.querySelectorAll(".renameBtn").forEach((btn) => {
        btn.onclick = () => {
          openRenameModal(btn.dataset.type, btn.dataset.name, btn.dataset.path);
          const menu = btn.closest(".dropdownMenu");
          menu.classList.add("scale-95", "opacity-0");
          setTimeout(() => menu.classList.add("hidden"), 150);
        };
      });

      // --- Upload logic --- (unchanged)
      const uploadBtn = document.getElementById("uploadFileBtn");
      const uploadInput = document.getElementById("uploadFileInput");
      const uploadModal = document.getElementById("uploadModal");
      const uploadBar = document.getElementById("uploadBar");
      const uploadStatus = document.getElementById("uploadStatus");

      let uploadQueue = [];

      uploadBtn.onclick = () => uploadInput.click();
      uploadInput.onchange = (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        enqueueFiles(files);
      };

      function enqueueFiles(files) {
        uploadQueue.push(...files);
        if (uploadQueue.length === files.length) startUploadQueue();
      }

      async function startUploadQueue() {
        if (!uploadQueue.length) return location.reload();
        showUploadModal();
        const file = uploadQueue.shift();
        uploadStatus.textContent = `Uploading ${file.name}...`;
        try {
          await uploadFile(file);
        } catch (err) {
          console.error(err);
          alert(`Failed to upload ${file.name}: ${err.message}`);
        }
        uploadBar.style.width = "0%";
        startUploadQueue();
      }

      function uploadFile(file) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          const formData = new FormData();
          formData.append("file", file);
          xhr.upload.addEventListener("progress", (e) => {
            if (e.lengthComputable) {
              const percent = (e.loaded / e.total) * 100;
              uploadBar.style.width = percent + "%";
            }
          });
          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) resolve();
            else reject(new Error(`Server responded with status ${xhr.status}`));
          };
          xhr.onerror = () => reject(new Error("Upload failed"));
          xhr.open(
            "POST",
            `/server/files/<%= server.id %>/upload?path=<%= encodeURIComponent(path) %>`
          );
          xhr.send(formData);
        });
      }

      function showUploadModal() {
        uploadModal.classList.remove("hidden");
      }

      function hideUploadModal() {
        uploadModal.classList.add("hidden");
        uploadStatus.textContent = "";
      }


      (function () {
        const selectedBadge = document.getElementById('selectedCountBadge');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const actionBar = document.getElementById('actionBar');
        const actionSelectedCount = document.getElementById('actionSelectedCount');
        const actionSelectedList = document.getElementById('actionSelectedList');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');

        const deleteProgressModal = document.getElementById('deleteProgressModal');
        const deleteProgressBar = document.getElementById('deleteProgressBar');
        const deleteProgressLabel = document.getElementById('deleteProgressLabel');
        const deleteProgressCurrent = document.getElementById('deleteProgressCurrent');
        const deleteProgressClose = document.getElementById('deleteProgressClose');
        const deleteProgressCancel = document.getElementById('deleteProgressCancel');

        let abortController = null;

        /* -------------------- helpers -------------------- */

        function getSelectedRows() {
          return Array.from(document.querySelectorAll('tr.file-row')).filter(row => {
            const cb = row.querySelector('.row-checkbox');
            return cb && cb.checked && !row.classList.contains('hidden');
          });
        }

        function showActionBar() {
          actionBar.style.pointerEvents = 'auto';
          actionBar.classList.remove('translate-y-32', 'opacity-0');
          actionBar.classList.add('translate-y-0', 'opacity-100');
        }

        function hideActionBar() {
          actionBar.style.pointerEvents = 'none';
          actionBar.classList.remove('translate-y-0', 'opacity-100');
          actionBar.classList.add('translate-y-32', 'opacity-0');
        }

        function clearSelection() {
          document.querySelectorAll('.row-checkbox').forEach(cb => {
            cb.checked = false;
          });
          if (selectAllCheckbox) selectAllCheckbox.checked = false;
          updateSelectedUI();
        }

        function updateSelectedUI() {
          const selectedRows = getSelectedRows();
          const count = selectedRows.length;

          if (selectedBadge) {
            if (count === 0) {
              selectedBadge.classList.add('hidden');
              selectedBadge.textContent = '0';
            } else {
              selectedBadge.classList.remove('hidden');
              selectedBadge.textContent = String(count);
            }
          }

          actionSelectedCount.textContent = `${count} selected`;

          if (count > 0 && count <= 5) {
            actionSelectedList.textContent = selectedRows
              .map(r => r.dataset.path)
              .join(', ');
            actionSelectedList.classList.remove('hidden');
          } else {
            actionSelectedList.classList.add('hidden');
          }

          if (count > 0) showActionBar();
          else hideActionBar();
        }

        /* -------------------- checkbox init (FIXED) -------------------- */

        document.querySelectorAll('.row-checkbox').forEach(cb => {
          // ðŸ”¥ IMPORTANT: do NOT hide them
          cb.classList.remove('opacity-0', 'pointer-events-none');
          cb.addEventListener('change', updateSelectedUI);
        });

        /* -------------------- select all -------------------- */

        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener('change', (e) => {
            const on = e.target.checked;
            document.querySelectorAll('tr.file-row:not(.hidden)').forEach(row => {
              const cb = row.querySelector('.row-checkbox');
              if (cb) cb.checked = on;
            });
            updateSelectedUI();
          });
        }

        /* -------------------- clear button -------------------- */

        clearSelectionBtn.addEventListener('click', clearSelection);

        /* -------------------- delete selected -------------------- */

        deleteSelectedBtn.addEventListener('click', async () => {
          const selectedRows = getSelectedRows();
          if (!selectedRows.length) return;

          if (!confirm(`Delete ${selectedRows.length} item(s)? This will run sequentially.`)) {
            return;
          }

          const queue = selectedRows.map(r => ({
            type: r.dataset.type,
            path: r.dataset.path,
            name: r.querySelector('.file-name')?.textContent.trim() || r.dataset.path,
            row: r
          }));

          await runDeleteQueue(queue);
        });

        /* -------------------- delete queue -------------------- */

        async function runDeleteQueue(queue) {
          deleteProgressModal.classList.remove('hidden');
          deleteProgressBar.style.width = '0%';
          deleteProgressLabel.textContent = `0 / ${queue.length}`;
          deleteProgressCurrent.textContent = 'Starting...';

          abortController = new AbortController();
          let completed = 0;

          for (const item of queue) {
            if (abortController.signal.aborted) break;

            deleteProgressCurrent.textContent = `Deleting ${item.name}`;

            try {
              await deleteSingleItem(item, abortController.signal);
              item.row?.remove();
            } catch (err) {
              console.error('Delete failed:', err);
            }

            completed++;
            deleteProgressBar.style.width =
              Math.round((completed / queue.length) * 100) + '%';
            deleteProgressLabel.textContent = `${completed} / ${queue.length}`;
          }

          deleteProgressCurrent.textContent = 'Done';
          abortController = null;
          clearSelection();
          setTimeout(deleteProgressModal.classList.add('hidden'), 1500)
        }

        function deleteSingleItem(item, signal) {
          const serverId = '<%= server.id %>';
          const params = new URLSearchParams({ location: item.path });

          return fetch(
            `/server/files/${encodeURIComponent(serverId)}/${encodeURIComponent(item.type)}/delete?${params}`,
            {
              method: 'POST',
              credentials: 'same-origin',
              signal
            }
          ).then(res => {
            if (!res.ok) throw new Error('Delete failed');
          });
        }

        /* -------------------- modal controls -------------------- */

        deleteProgressClose.addEventListener('click', () => {
          if (!abortController) deleteProgressModal.classList.add('hidden');
        });

        deleteProgressCancel.addEventListener('click', () => {
          if (abortController && confirm('Abort deletion queue?')) {
            abortController.abort();
          }
        });

      })();
      // --- Keyboard find shortcut (Ctrl/Cmd+F) --- (kept)
      document.addEventListener("keydown", (e) => {
        const isMac = navigator.platform.toUpperCase().includes("MAC");
        const isFindShortcut = isMac
          ? e.metaKey && e.key === "f"
          : e.ctrlKey && e.key === "f";

        if (!isFindShortcut) return;
        const activeTag = document.activeElement?.tagName?.toLowerCase();
        const isTyping =
          activeTag === "input" ||
          activeTag === "textarea" ||
          document.activeElement?.isContentEditable;

        if (isTyping && document.activeElement.id !== "searchInput") return;
        e.preventDefault();
        const searchInput = document.getElementById("searchInput");
        if (!searchInput) return;
        searchInput.focus();
        searchInput.select();
      });

      // --- Right-click context menu --- (kept)
      (function () {
        const serverId = '<%= server.id %>';
        const currentPath = '<%= path %>';
        const relPrefix = currentPath === '/' ? '' : currentPath + '/';

        const contextMenu = document.createElement('div');
        contextMenu.id = 'context-menu';
        contextMenu.className =
          'dropdownMenu transition-all scale-95 opacity-0 bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg hidden flex flex-col z-50 min-w-[140px] fixed';
        contextMenu.style.right = 'auto';
        contextMenu.style.left = '0px';
        contextMenu.style.top = '0px';
        contextMenu.style.padding = '6px 0';
        document.body.appendChild(contextMenu);

        function hideAllMenus() {
          document.querySelectorAll('.dropdownMenu').forEach((m) => {
            if (!m.classList.contains('hidden')) {
              m.classList.add('scale-95', 'opacity-0');
              setTimeout(() => m.classList.add('hidden'), 150);
            }
          });
        }

        function showContextMenuAt(x, y) {
          hideAllMenus();
          contextMenu.classList.remove('hidden');
          contextMenu.style.left = x + 'px';
          contextMenu.style.top = y + 'px';
          requestAnimationFrame(() => {
            contextMenu.classList.remove('scale-95', 'opacity-0');
            contextMenu.classList.add('scale-100', 'opacity-100');
          });
          requestAnimationFrame(() => {
            const rect = contextMenu.getBoundingClientRect();
            const PAD = 8;
            let left = rect.left;
            let top = rect.top;
            if (rect.right > window.innerWidth) left = Math.max(PAD, window.innerWidth - rect.width - PAD);
            if (rect.bottom > window.innerHeight) top = Math.max(PAD, window.innerHeight - rect.height - PAD);
            contextMenu.style.left = left + 'px';
            contextMenu.style.top = top + 'px';
          });
          if (window.lucide) lucide.createIcons();
        }

        function hideContextMenu() {
          if (contextMenu.classList.contains('hidden')) return;
          contextMenu.classList.remove('scale-100', 'opacity-100');
          contextMenu.classList.add('scale-95', 'opacity-0');
          setTimeout(() => contextMenu.classList.add('hidden'), 150);
        }

        function buildMenuFor(row) {
          const name = row.querySelector('.file-name')?.textContent?.trim() || '';
          const type = row.dataset.type || 'file';
          const relPath = (currentPath === '/' ? '' : currentPath + '/') + name;
          const safeName = escapeHtml(name);
          const deleteUrl = '/server/files/' + encodeURIComponent(serverId) + '/' + encodeURIComponent(type) + '/delete?location=' + encodeURIComponent(relPath);

          contextMenu.innerHTML = `
        <form method="POST" action="${deleteUrl}" onsubmit="return confirm('Delete ${safeName}?');" style="margin:0">
          <button type="submit" class="text-left px-4 py-2 hover:bg-red-700 rounded-xl text-red-500">Delete</button>
        </form>
        <button class="renameBtn text-left px-4 py-2 hover:bg-neutral-800 rounded-xl" data-type="${escapeHtml(type)}" data-name="${escapeHtml(name)}" data-path="${escapeHtml(relPath)}">Rename</button>
      `;

          const renameBtn = contextMenu.querySelector('.renameBtn');
          if (renameBtn) {
            renameBtn.onclick = (ev) => {
              ev.stopPropagation();
              openRenameModal(renameBtn.dataset.type, renameBtn.dataset.name, renameBtn.dataset.path);
              hideContextMenu();
            };
          }
        }

        document.addEventListener('contextmenu', (e) => {
          const row = e.target.closest('tr.file-row');
          if (!row) return;
          e.preventDefault();
          buildMenuFor(row);
          showContextMenuAt(e.clientX, e.clientY);
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('#context-menu')) hideContextMenu();
        });
        window.addEventListener('blur', hideContextMenu);
        window.addEventListener('resize', hideContextMenu);
        window.addEventListener('scroll', hideContextMenu, true);
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') hideContextMenu();
        });
      })();
    </script>

</body>

</html>