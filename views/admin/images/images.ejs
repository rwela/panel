<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-Figtree">
  <head>
    <meta charset="UTF-8" />
    <title><%= name %> - Images</title>
    <link rel="stylesheet" href="/assets/tailwind.css">
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="min-h-screen flex">
    <%- include('../../components/sidebar', { name, user }) %>

    <main class="flex-1 p-8 overflow-auto">
      <div class="max-w-6xl mx-auto space-y-6">
        <div
          class="bg-neutral-950 border border-neutral-900 p-6 rounded-2xl flex justify-between items-center"
        >
          <h1 class="text-3xl font-bold flex items-center gap-2">
  <i data-lucide="image" class="w-6 h-6"></i> Docker Images
</h1>
          <div class="flex gap-2">
            <a
              href="/admin/images/new"
              class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-xl font-medium"
              >+ New Image</a
            >

            <!-- Upload JSON button -->
            <label
              for="json-upload"
              class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-xl font-medium cursor-pointer"
            >
              Upload Image
            </label>
            <input
              type="file"
              id="json-upload"
              accept=".json"
              class="hidden"
              onchange="uploadJSON()"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <% images.forEach(img => { %>
          <div onclick="window.location.href='/admin/image/<%= img.id %>'"
            class="cursor-pointer bg-neutral-950 border border-neutral-800 rounded-2xl p-6 flex flex-col justify-between"
          >
            <div>
              <h2 class="text-xl font-semibold mb-2"><%= img.name %></h2>
              <p class="text-gray-400 text-sm mb-1">
                <strong>Docker Image:</strong> <%= img.dockerImage %>
              </p>
              <p class="text-gray-400 text-sm mb-1"><%= img.description %></p>
              <p class="text-gray-400 text-sm mb-1">
                <strong>ENVs:</strong> <%= JSON.stringify(img.envs) %>
              </p>
              <% if (img.files.length) { %>
              <p class="text-gray-400 text-sm"><strong>Files:</strong></p>
              <ul class="list-disc list-inside text-gray-400 text-sm">
                <% img.files.forEach(file => { %>
                <li>
                  <a
                    href="<%= file.url %>"
                    class="text-indigo-400 hover:underline"
                    ><%= file.filename %></a
                  >
                </li>
                <% }) %>
              </ul>
              <% } %>
            </div>
            <div class="mt-4 flex justify-end gap-2">
              <!-- Delete Button -->
              <button
                onclick="deleteImage('<%= img.id %>')"
                class="flex items-center gap-2 bg-red-600 hover:bg-red-700 px-3 py-1 rounded-xl text-sm"
              >
                <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
              </button>

              <!-- Export Button -->
              <a
                href="/admin/images/export/<%= img.id %>"
                target="_blank"
                class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-xl text-sm"
              >
                <i data-lucide="download" class="w-4 h-4"></i> Export
              </a>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      lucide.createIcons();

      async function deleteImage(id) {
        if (!confirm("Are you sure you want to delete this image?")) return;
        try {
          const res = await axios.post(`/admin/images/delete/${id}`);
          if (res.data.success) location.reload();
        } catch (err) {
          alert("Failed to delete image");
        }
      }

      // Upload JSON file and create image
      async function uploadJSON() {
        const input = document.getElementById("json-upload");
        if (!input.files || !input.files[0])
          return alert("Select a JSON file first");

        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = async function (e) {
          try {
            const data = JSON.parse(e.target.result);

            // Destructure and provide defaults
            const {
              dockerImage,
              name,
              description = "",
              envs = {},
              files = [],
            } = data;
            if (!dockerImage || !name)
              return alert("JSON must include dockerImage and name");

            const res = await axios.post("/admin/images/new", {
              dockerImage,
              name,
              description,
              envs,
              files,
            });

            if (res.data.success) {
              alert("Image Uploaded successfully!");
              location.reload();
            } else {
              alert("Failed to create image");
            }
          } catch (err) {
            alert("Invalid JSON file");
            console.error(err);
          }
        };

        reader.readAsText(file);
      }
    </script>
  </body>
</html>
