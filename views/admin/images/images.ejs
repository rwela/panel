<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-Figtree">
  <head>
    <meta charset="UTF-8" />
    <title><%= name %> - Images</title>
    <link rel="stylesheet" href="/assets/tailwind.css">
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="min-h-screen flex">
    <%- include('../../components/sidebar', { name, user }) %>

    <main class="flex-1 p-8 overflow-auto">
      <div class="max-w-6xl mx-auto space-y-6">
        <div
          class="bg-neutral-950 border border-neutral-900 p-6 rounded-2xl flex justify-between items-center"
        >
          <h1 class="text-3xl font-bold flex items-center gap-2">
  <i data-lucide="image" class="w-6 h-6"></i> Docker Images
</h1>
          <div class="flex gap-2">
            <a
              href="/admin/images/new"
              class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-xl font-medium"
              >+ New Image</a
            >

            <!-- Upload JSON button -->
            <label
              for="json-upload"
              class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-xl font-medium cursor-pointer"
            >
              Upload Image
            </label>
            <input
              type="file"
              id="json-upload"
              accept=".json"
              class="hidden"
              onchange="uploadJSON()"
            />
          </div>
        </div>

       <div class="bg-neutral-950 border border-neutral-900 rounded-lg overflow-hidden">
  <table class="w-full table-auto text-left border-collapse">
    <thead class="text-neutral-400 uppercase text-xs border-b border-neutral-800">
      <tr>
        <th class="px-4 py-2">Name</th>
        <th class="px-4 py-2">Docker Image</th>
        <!--th class="px-4 py-2">Description</th-->
        <th class="px-4 py-2">ENVs</th>
        <th class="px-4 py-2">Files</th>
        <th class="px-4 py-2 text-right">Actions</th>
      </tr>
    </thead>

    <tbody>
      <% if (images && images.length > 0) { %>
        <% images.forEach(img => { %>
          <tr onclick="window.location.href='/admin/image/<%= img.id %>'" class="cursor-pointer border-b border-neutral-800 hover:bg-neutral-900/50 transition-colors">

            <!-- Name -->
            <td class="px-4 py-3 font-semibold text-gray-100">
              <%= img.name %>
            </td>

            <!-- Docker Image -->
            <td class="px-4 py-3 text-gray-400">
              <%= img.dockerImage %>
            </td>

            <!-- Description -->
            <!--td class="px-4 py-3 text-gray-400">
              <%= img.description %>
            </td-->

            <!-- ENVs -->
            <td class="px-4 py-3 text-gray-400">
              <%= JSON.stringify(img.envs) %>
            </td>

            <!-- Files -->
            <td class="px-4 py-3 text-gray-400">
              <% if (img.files.length > 0) { %>
                <ul class="list-disc list-inside">
                  <% img.files.forEach(file => { %>
                    <li>
                      <a href="<%= file.url %>" class="text-indigo-400 hover:underline">
                        <%= file.filename %>
                      </a>
                    </li>
                  <% }) %>
                </ul>
              <% } else { %>
                <span class="text-neutral-500 italic">No files</span>
              <% } %>
            </td>

            <!-- Actions -->
            <td class="px-4 py-3 text-right flex justify-end gap-2">

              <!-- Delete -->
              <button
                onclick="deleteImage('<%= img.id %>')"
                class="px-3 py-1 text-xs font-semibold rounded-lg bg-red-600 hover:bg-red-700"
              >
                Delete
              </button>

              <!-- Export -->
              <a
                href="/admin/images/export/<%= img.id %>"
                target="_blank"
                class="px-3 py-1 text-xs font-semibold rounded-lg bg-blue-600 hover:bg-blue-700"
              >
                Export
              </a>

            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="6" class="px-4 py-6 text-neutral-500 italic text-center">
            No images found.
          </td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>

      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      lucide.createIcons();

      async function deleteImage(id) {
        if (!confirm("Are you sure you want to delete this image?")) return;
        try {
          const res = await axios.post(`/admin/images/delete/${id}`);
          if (res.data.success) location.reload();
        } catch (err) {
          alert("Failed to delete image");
        }
      }

      // Upload JSON file and create image
      async function uploadJSON() {
        const input = document.getElementById("json-upload");
        if (!input.files || !input.files[0])
          return alert("Select a JSON file first");

        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = async function (e) {
          try {
            const data = JSON.parse(e.target.result);

            // Destructure and provide defaults
            const {
              dockerImage,
              name,
              description = "",
              envs = {},
              files = [],
            } = data;
            if (!dockerImage || !name)
              return alert("JSON must include dockerImage and name");

            const res = await axios.post("/admin/images/new", {
              dockerImage,
              name,
              description,
              envs,
              files,
            });

            if (res.data.success) {
              alert("Image Uploaded successfully!");
              location.reload();
            } else {
              alert("Failed to create image");
            }
          } catch (err) {
            alert("Invalid JSON file");
            console.error(err);
          }
        };

        reader.readAsText(file);
      }
    </script>
  </body>
</html>
