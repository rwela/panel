<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-Figtree">
  <head>
    <meta charset="UTF-8" />
    <title><%= name %> - Nodes</title>
    <link rel="stylesheet" href="/assets/tailwind.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .input {
        width: 100%;
        background: #0a0a0a;
        border: 1px solid #262626;
        padding: 0.5rem 0.75rem;
        border-radius: 0.75rem;
        transition: border 0.2s, background 0.2s;
      }

      .input:focus {
        outline: none;
        border-color: #6366f1;
        background: #111111;
      }

      @keyframes heartbeat {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0.6; }
        100% { transform: scale(1); opacity: 1; }
      }

      .heartbeat {
        animation: heartbeat 2s infinite;
      }

      /* Modal animations */
      .modal-enter {
        opacity: 0;
        transform: scale(0.9);
      }
      .modal-enter-active {
        opacity: 1;
        transform: scale(1);
        transition: opacity 0.25s ease, transform 0.25s ease;
      }
      .modal-leave {
        opacity: 1;
        transform: scale(1);
      }
      .modal-leave-active {
        opacity: 0;
        transform: scale(0.9);
        transition: opacity 0.25s ease, transform 0.25s ease;
      }
    </style>
  </head>
  <body class="min-h-screen flex">
    <%- include('../../components/sidebar', { name, user }) %>

    <main class="flex-1 p-8 overflow-auto">
      <div class="max-w-6xl mx-auto space-y-6">
        <div class="bg-neutral-950 border border-neutral-900 p-6 rounded-2xl flex justify-between items-center">
          <div>
  <h1 class="text-3xl font-bold flex items-center gap-2">
    <i data-lucide="cpu" class="w-6 h-6"></i> Nodes
  </h1>
  <p class="text-gray-400">Manage all connected nodes</p>
</div>

          <button onclick="openCreateModal()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-xl font-medium transition">
            + Create Node
          </button>
        </div>
<div class="bg-neutral-950 border border-neutral-900 rounded-lg overflow-hidden">
  <table class="w-full table-auto text-left border-collapse">
    <thead class="text-neutral-400 uppercase text-xs border-b border-neutral-800">
      <tr>
        <th class="px-4 py-2">Name</th>
        <th class="px-4 py-2">IP / Port</th>
        <th class="px-4 py-2">CPU</th>
        <th class="px-4 py-2">RAM</th>
        <th class="px-4 py-2">Version</th> <!-- NEW -->
        <th class="px-4 py-2 text-right">Status / Actions</th>
      </tr>
    </thead>

    <tbody>
      <% if (nodes && nodes.length > 0) { %>
        <% nodes.forEach(node => { %>
          <tr class="border-b border-neutral-800 hover:bg-neutral-900/50 transition-colors">

            <!-- Name -->
            <td class="px-4 py-3 font-semibold text-gray-100 flex items-center gap-2">
              <% if (node.status === "online") { %>
                <i data-lucide="heart-pulse" class="w-5 h-5 text-green-400 heartbeat" data-node-id="<%= node.id %>" title="Loading version..."></i>
              <% } else if (node.status === "dockernotrunning") { %>
                <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-400"></i>
              <% } else { %>
                <i data-lucide="x-circle" class="w-5 h-5 text-red-400"></i>
              <% } %>
              <%= node.name %>
            </td>

            <!-- IP / Port -->
            <td class="px-4 py-3 text-gray-400">
              <%= node.ip %>:<%= node.port %>
            </td>

            <!-- CPU -->
            <td class="px-4 py-3 text-gray-400">
              <%= node.core %> Cores
            </td>

            <!-- RAM -->
            <td class="px-4 py-3 text-gray-400">
              <%= node.ram %> MB
            </td>

            <!-- Version -->
            <td class="px-4 py-3 text-gray-400">
              <span class="node-version bg-neutral-950 border border-neutral-800 px-2 mb-2 font-mono rounded-md" data-node-id="<%= node.id %>">Loading...</span>
            </td>

            <!-- Status / Actions -->
            <td class="px-4 py-3 text-right flex justify-end gap-2">

              <a href="/admin/node/<%= node.id %>" class="px-3 py-1 text-xs font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700">
                Manage
              </a>

              <a href="/admin/node/<%= node.id %>/edit" class="px-3 py-1 text-xs font-semibold rounded-lg bg-neutral-800 hover:bg-neutral-700">
                Edit
              </a>

              <form action="/admin/node/<%= node.id %>/delete" method="post" onsubmit="return confirm('Delete node "<%= node.name %>"?');">
                <button type="submit" class="px-3 py-1 text-xs font-semibold rounded-lg bg-red-600 hover:bg-red-700">
                  Delete
                </button>
              </form>

            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="6" class="px-4 py-6 text-neutral-500 italic text-center">
            No nodes found.
          </td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>
      </div>
    </main>
<!-- Create Node Modal -->
<div id="createModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-neutral-950 border border-neutral-900 p-8 w-full max-w-lg transform scale-95 opacity-0 rounded-2xl shadow-2xl">
    <h2 class="text-2xl font-semibold mb-6">Create Node</h2>
    <div class="space-y-4">
      <input id="n-name" placeholder="Node Name" class="input w-full" />
      <input id="n-ip" placeholder="IP (or localhost)" class="input w-full" />
      <input id="n-port" placeholder="Port" class="input w-full" />
      <input id="n-ram" placeholder="RAM (MB)" class="input w-full" />
      <input id="n-core" placeholder="CPU Cores" class="input w-full" />
    </div>
    <div class="flex justify-end gap-3 mt-8">
      <button onclick="closeCreateModal()" class="px-5 py-2 bg-red-600 text-white transition rounded-lg hover:bg-red-700">Cancel</button>
      <button onclick="createNode()" class="px-5 py-2 bg-white text-neutral-950 transition rounded-lg hover:bg-gray-200">Create</button>
    </div>
  </div>
</div>


    <script>
      lucide.createIcons();

      const modal = document.getElementById("createModal");
      const modalContent = modal.querySelector("div");

      function openCreateModal() {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        setTimeout(() => {
          modalContent.classList.add("modal-enter-active");
          modalContent.classList.remove("scale-95", "opacity-0");
        }, 10);
      }

      function closeCreateModal() {
        modalContent.classList.remove("modal-enter-active");
        modalContent.classList.add("modal-leave-active");
        setTimeout(() => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          modalContent.classList.remove("modal-leave-active");
          modalContent.classList.add("scale-95", "opacity-0");
        }, 250);
      }

      async function createNode() {
        const body = {
          name: document.getElementById("n-name").value,
          ip: document.getElementById("n-ip").value,
          port: document.getElementById("n-port").value,
          ram: document.getElementById("n-ram").value,
          core: document.getElementById("n-core").value,
        };

        const res = await fetch("/admin/node/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (res.ok) location.reload();
        else alert("Failed to create node");
      }
       document.querySelectorAll('.heartbeat').forEach(icon => {
    const nodeId = icon.dataset.nodeId;
    if (!nodeId) return;

    fetch(`/admin/node/ver/${nodeId}`)
      .then(res => res.json())
      .then(data => {
        if (data.version) {
          icon.title = `Version: ${data.version}`;
          // also update the Version column
          const versionEl = document.querySelector(`.node-version[data-node-id="${nodeId}"]`);
          if (versionEl) versionEl.textContent = data.version;
        } else {
          icon.title = 'Version unknown';
        }
      })
      .catch(() => {
        icon.title = 'Version fetch failed';
      });
  });
    </script>
  </body>
</html>
