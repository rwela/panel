<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-space-grotesk">

<head>
  <meta charset="UTF-8" />
  <title>
    <%= name %> - Dashboard
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <link rel="icon" type="image/x-icon" href="<%= config.logo %>">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="min-h-screen flex">
  <!-- Sidebar -->
  <%- include('../components/sidebar', { name: name, user: user }) %>

    <main class="flex-1 p-8 overflow-auto">
      <div class="max-w-7xl mx-auto space-y-6">
        <!-- Welcome Banner -->
        <div class="bg-neutral-950 border border-neutral-900 p-6 rounded-2xl shadow-lg">
          <h1 class="text-3xl font-bold">
            ðŸ‘‹ Welcome back, <%= user.username %>!
          </h1>
          <p class="text-gray-400 mt-1">Here's your server overview.</p>
        </div>


        <!-- Servers in network-style rows -->
        <div class="bg-neutral-950 border border-neutral-900 rounded-lg overflow-hidden">
          <table class="w-full table-auto text-left border-collapse">
            <thead class="text-neutral-400 uppercase text-xs border-b border-neutral-800">
              <tr>
                <th class="px-4 py-2">Name</th>
                <th class="px-4 py-2">Node</th>
                <th class="px-4 py-2">IP</th>
                <th class="px-4 py-2 text-right flex justify-end items-center gap-2">
                  Status / Actions
                  <% if (user.admin) { %>
                    <% if (req.query.admin==="true" ) { %>
                      <a href="/dashboard"
                        class="inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-lg bg-neutral-900 hover:bg-neutral-950 text-gray-100 transition">
                        <i data-lucide="user" class="w-3 h-3"></i>
                        Your Servers
                      </a>
                      <% } else { %>
                        <a href="/dashboard?admin=true"
                          class="inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-lg bg-neutral-900 hover:bg-neutral-950 text-gray-100 transition">
                          <i data-lucide="server" class="w-3 h-3"></i>
                          Other Servers
                        </a>
                        <% } %>
                          <% } %>
                </th>
              </tr>
            </thead>

            <tbody>
              <% if (servers && servers.length> 0) { %>
                <% servers.forEach(server=> { %>
                  <tr class="border-b border-neutral-800 hover:bg-neutral-900/50 transition-colors">
                    <td class="px-4 py-3 font-semibold text-gray-100 flex items-center gap-2">
                      <i data-lucide="server" class="w-5 h-5"></i>
                      <%= server.name %>
                        <span id="server-<%= server.id %>-uptime"
                          class="ml-2 inline-block px-2 py-0.5 text-xs font-semibold text-gray-100 bg-neutral-800 rounded-full">
                          --:--:--
                        </span>
                        <% if (server.suspended) { %>
                          <span
                            class="ml-2 inline-block px-2 py-0.5 text-xs font-semibold text-red-100 bg-red-600 rounded-full">
                            Suspended
                          </span>
                          <% } %>
                    </td>
                    <td class="px-4 py-3 text-gray-400">
                      <%= server.node?.name || 'Unknown' %>
                    </td>
                    <td class="px-4 py-3 text-gray-400">
                      <%= server.node?.ip %>:<%= server.port %>
                    </td>
                    <td class="px-4 py-3 text-right flex justify-end gap-2">
                      <span id="server-<%= server.id %>-status" class="flex items-center gap-2 text-gray-400">
                        <i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Loading...
                      </span>
                      <% if (!server.suspended) { %>
                        <a href="/server/manage/<%= server.id %>"
                          class="px-3 py-1 text-xs font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition">
                          Manage
                        </a>
                        <% } else { %>
                          <span class="px-3 py-1 text-xs font-semibold rounded-lg bg-red-600 cursor-not-allowed">
                            Suspended
                          </span>
                          <% } %>
                    </td>
                  </tr>
                  <script>
                    (function () {
                      const serverId = "<%= server.id %>";
                      const statusEl = document.getElementById(`server-${serverId}-status`);
                      const uptimeEl = document.getElementById(`server-${serverId}-uptime`);
                      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
                      const ws = new WebSocket(`${protocol}://${window.location.hostname}${window.location.port ? ':' + window.location.port : ''}/stats/${serverId}`);

                      let uptimeSeconds = 0; // local counter

                      function formatUptime(seconds) {
                        const h = Math.floor(seconds / 3600);
                        const m = Math.floor((seconds % 3600) / 60);
                        const s = seconds % 60;
                        const parts = [];
                        if (h) parts.push(`${h}h`);
                        if (m) parts.push(`${m}m`);
                        parts.push(`${s}s`);
                        return parts.join(" ");
                      }

                      ws.onmessage = (evt) => {
                        try {
                          const data = JSON.parse(evt.data);
                          const stats = data.stats;
                          uptimeSeconds = data.uptimeSeconds || uptimeSeconds; // sync with server

                          // Update server status
                          if ((stats.memory_stats?.usage || 0) > 1) {
                            statusEl.className = "flex items-center gap-2 text-emerald-400";
                            statusEl.innerHTML = `<i data-lucide="server" class="w-4 h-4"></i> Online`;
                          } else {
                            statusEl.className = "flex items-center gap-2 text-red-700";
                            statusEl.innerHTML = `<i data-lucide="server-off" class="w-4 h-4"></i> Offline`;
                          }

                          lucide.createIcons();
                        } catch (err) {
                          console.error(`Error updating server ${serverId}:`, err);
                        }
                      };

                      // Increment uptime locally every second
                      setInterval(() => {
                        if (statusEl.textContent.includes("Online")) {
                          uptimeSeconds++;
                        } else {
                          uptimeSeconds = 0;
                        }
                        uptimeEl.textContent = formatUptime(uptimeSeconds);
                      }, 1000);
                    })();
                  </script>


                  <% }) %>
                    <% } else { %>
                      <tr>
                        <td colspan="4" class="px-4 py-6 text-neutral-500 italic text-center">
                          No servers added yet.
                        </td>
                      </tr>
                      <% } %>
            </tbody>
          </table>
        </div>

      </div>
    </main>

    <script>
      lucide.createIcons();
    </script>
</body>

</html>