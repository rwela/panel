<!DOCTYPE html>
<html lang="en" class="h-full bg-black text-white font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= name %> - <%= server.name %>
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    .font-mono {
      font-family: 'JetBrains Mono', monospace;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #000;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    /* Terminal Scrollbar */
    #logContainer::-webkit-scrollbar {
      width: 4px;
    }

    #logContainer::-webkit-scrollbar-track {
      background: transparent;
    }

    #logContainer::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 2px;
    }

    /* Terminal Selection */
    .terminal::selection,
    .terminal *::selection {
      background-color: rgba(255, 255, 255, 0.2);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
</head>

<body class="flex h-full w-full overflow-hidden">

  <%- include('../components/sidebar', { name: name, user: user }) %>

    <main class="relative flex-1 overflow-y-auto bg-black">
      <div class="mx-auto max-w-7xl px-6 py-12 md:px-12">

        <!-- Header Area -->
        <div class="mb-8 flex flex-col justify-between gap-6 md:flex-row md:items-end animate-fade-in-up">
          <div>
            <div class="flex items-center gap-3">
              <h1 class="text-3xl font-bold tracking-tight text-white md:text-4xl">
                <%= server.name %>
              </h1>
              <!-- Status Badge -->
              <span id="written-status2"
                class="rounded-full bg-neutral-900 px-3 py-1 text-xs font-semibold text-neutral-400 border border-neutral-800 transition-colors">
                Connecting...
              </span>
            </div>

            <div class="mt-2 flex items-center gap-4 text-sm text-neutral-400">
              <div class="flex items-center gap-2 cursor-pointer hover:text-white transition-colors"
                onclick="navigator.clipboard.writeText('<%= server.ip || '0.0.0.0' %>:<%= server.port %>'); alert('Copied IP!');">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="h-4 w-4">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S12 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S12 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
                </svg>
                <span class="font-mono">
                  <%= server.ip || '0.0.0.0' %>:<%= server.port %>
                </span>
              </div>
              <span class="text-neutral-700">|</span>
              <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="h-4 w-4">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M5.25 14.25h13.5m-13.5 0a3 3 0 01-3-3m3 3a3 3 0 100 6h13.5a3 3 0 100-6m-16.5-3a3 3 0 013-3h13.5a3 3 0 013 3m-19.5 0a4.5 4.5 0 01.9-2.7L5.737 5.1a3.375 3.375 0 012.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 01.9 2.7m0 0a3 3 0 01-3 3m0 3h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008zm-3 6h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008z" />
                </svg>
                <span>
                  <%= server.node?.name || 'Local Node' %>
                </span>
              </div>
              <span class="text-neutral-700">|</span>
              <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="h-4 w-4">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span id="uptime">0h 0m 0s</span>
              </div>
            </div>
          </div>

          <!-- Power Controls -->
          <div id="power-actions" class="flex items-center gap-3">
            <button data-action="start" disabled
              class="flex items-center gap-2 rounded-xl bg-emerald-900/20 border border-emerald-900/50 px-5 py-2.5 text-sm font-bold text-emerald-500 transition-all hover:bg-emerald-900/40 hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-5 w-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
              </svg>
              Start
            </button>
            <button data-action="restart" disabled
              class="flex items-center gap-2 rounded-xl bg-neutral-800 border border-neutral-700 px-5 py-2.5 text-sm font-bold text-white transition-all hover:bg-neutral-700 hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-5 w-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
              </svg>
              Restart
            </button>
            <button data-action="stop" disabled
              class="flex items-center gap-2 rounded-xl bg-red-900/20 border border-red-900/50 px-5 py-2.5 text-sm font-bold text-red-500 transition-all hover:bg-red-900/40 hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-5 w-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
              </svg>
              Stop
            </button>
          </div>
        </div>

        <!-- Node Down Alert -->
        <div id="systemnodedown"
          class="mb-6 hidden rounded-xl border border-red-900/50 bg-red-950/20 p-4 text-red-200 animate-slide-in-right">
          <div class="flex items-center gap-3">
            <svg class="animate-spin h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <span class="font-medium">Lost connection to the node. Attempting to reconnect...</span>
          </div>
        </div>

        <!-- Main Layout Grid -->
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">

          <!-- Terminal (Takes up 2 cols on Large screens) -->
          <div
            class="flex flex-col rounded-2xl border border-neutral-900 bg-[#0e0e0e] lg:col-span-2 overflow-hidden h-[500px] animate-scale-in delay-100 shadow-2xl">
            <!-- Terminal Header -->
            <div class="flex items-center justify-between border-b border-neutral-900 bg-neutral-950 px-4 py-2">
              <div class="flex items-center gap-2">
                <div class="h-3 w-3 rounded-full bg-red-500/20 border border-red-500/50"></div>
                <div class="h-3 w-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                <div class="h-3 w-3 rounded-full bg-green-500/20 border border-green-500/50"></div>
                <span class="ml-2 text-xs font-medium text-neutral-500">Console</span>
              </div>
              <!-- Status Dot (Hidden logic handled by JS) -->
              <span id="status-dot" class="hidden"></span>
            </div>

            <!-- Terminal Content -->
            <div class="relative flex-1 bg-[#0e0e0e] overflow-hidden">
              <div id="loading-overlay"
                class="absolute inset-0 z-10 flex items-center justify-center bg-[#0e0e0e]/90 transition-opacity duration-300">
                <div class="flex flex-col items-center gap-3">
                  <svg class="h-8 w-8 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                  </svg>
                  <span class="text-sm text-neutral-500">Connecting Socket...</span>
                </div>
              </div>
              <div id="terminal" class="h-full w-full bg-[#0e0e0e] pl-2 pt-2"></div>
              <div id="logContainer" class="hidden"></div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-neutral-900 bg-neutral-950 p-2">
              <div
                class="flex items-center gap-2 rounded-lg bg-[#0e0e0e] border border-neutral-900 px-3 py-2 focus-within:border-neutral-700 transition-colors">
                <span class="text-emerald-500 font-bold">âžœ</span>
                <input id="cmdInput" type="text" placeholder="Type a command..."
                  class="flex-1 bg-transparent text-sm text-white placeholder-neutral-600 outline-none font-mono" />
                <button id="sendBtn"
                  class="p-1 text-neutral-400 hover:text-white transition-colors hover:scale-110 active:scale-95">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="h-5 w-5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Right Column: Graphs & Stats -->
          <div class="flex flex-col gap-6 lg:h-[500px]">

            <!-- Usage Chart -->
            <div
              class="flex-1 rounded-2xl border border-neutral-900 bg-neutral-950 p-6 flex flex-col animate-scale-in delay-200 shadow-xl">
              <h3 class="mb-4 text-sm font-bold uppercase tracking-wider text-neutral-500">Resource Usage</h3>
              <div class="relative flex-1 w-full min-h-[200px]">
                <canvas id="usageChart"></canvas>
              </div>
              <div class="mt-4 flex items-center justify-around text-xs font-medium">
                <div class="flex items-center gap-2 text-indigo-400">
                  <div class="h-2 w-2 rounded-full bg-indigo-500"></div> CPU
                </div>
                <div class="flex items-center gap-2 text-purple-400">
                  <div class="h-2 w-2 rounded-full bg-purple-500"></div> RAM
                </div>
                <div class="flex items-center gap-2 text-red-400">
                  <div class="h-2 w-2 rounded-full bg-red-500"></div> Disk
                </div>
              </div>
            </div>

          </div>

        </div>

      </div>
    </main>

    <!-- Modals -->

    <!-- Confirm Modal -->
    <div id="confirm-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
      <div id="confirm-panel"
        class="w-full max-w-md transform rounded-2xl border border-neutral-900 bg-black p-6 shadow-2xl transition-all scale-95 opacity-0">
        <div class="flex items-start gap-4">
          <div id="confirm-icon-wrapper"
            class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-yellow-900/20 text-yellow-500">
            <svg id="confirm-icon-svg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
              stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.008v.008H12v-.008z" />
            </svg>
          </div>
          <div>
            <h3 id="confirm-title" class="text-lg font-bold text-white">Confirm Action</h3>
            <p id="confirm-message" class="mt-1 text-sm text-neutral-400">Are you sure?</p>
            <p id="confirm-details" class="mt-2 text-xs text-neutral-500"></p>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button id="confirm-cancel"
            class="rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2 text-sm font-bold text-neutral-300 hover:bg-neutral-800">Cancel</button>
          <button id="confirm-action"
            class="flex items-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-sm font-bold text-white hover:bg-red-700">
            Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- EULA Modal -->
    <% if (image && Array.isArray(image.features) && image.features.includes('EULA')) { %>
      <div id="eula-modal"
        class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
        <div id="eula-panel"
          class="w-full max-w-lg transform rounded-2xl border border-neutral-900 bg-black p-6 shadow-2xl transition-all scale-95 opacity-0">
          <h2 class="mb-2 text-lg font-bold text-white">Minecraft EULA Agreement</h2>
          <p class="mb-6 text-sm text-neutral-400">You must accept the EULA to run this server. By clicking "Accept",
            you agree to Mojang's EULA.</p>
          <div class="flex justify-end gap-3">
            <button id="eula-decline"
              class="rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2 text-sm font-bold text-neutral-300 hover:bg-neutral-800">Decline</button>
            <button id="eula-accept"
              class="rounded-lg bg-green-600 px-4 py-2 text-sm font-bold text-white hover:bg-green-700">Accept
              EULA</button>
          </div>
        </div>
      </div>
      <% } %>


        <!-- Logic Scripts -->
        <script>
          // --- Configuration ---
          const serverId = "<%= server.id %>";
          const containerId = "<%= server.idt %>";
          const totalDiskGB = parseFloat("<%= server.disk %>");
          const protocol = window.location.protocol === "https:" ? "wss" : "ws";

          // --- DOM Elements ---
          const logContainer = document.getElementById("logContainer");
          const statusEl2 = document.getElementById("written-status2");
          const loadingOverlay = document.getElementById("loading-overlay");
          const uptimeEl = document.getElementById("uptime");
          const statusDot = document.getElementById('status-dot'); // Hidden but used for logic

          // --- State ---
          let serverRunning = false;
          let diskUsageGB = 0;

          // --- Helpes ---
          function stripAnsiCodes(str) { return str.replace(/\x1b\[[0-9;]*m/g, ""); }

          function ansiToHtml(msg) {
            // Minimal ANSI parser for colors
            const colorMap = {
              30: "black", 31: "#ef4444", 32: "#10b981", 33: "#f59e0b", 34: "#3b82f6",
              35: "#d946ef", 36: "#06b6d4", 37: "#f3f4f6", 90: "#6b7280",
              91: "#f87171", 92: "#34d399", 93: "#fbbf24", 94: "#60a5fa",
              95: "#e879f9", 96: "#22d3ee", 97: "white"
            };

            return msg.replace(/\x1b\[([0-9;]+)m/g, (match, codes) => {
              const parts = codes.split(";");
              let style = "";
              for (const p of parts) {
                if (p === "1") style += "font-weight:bold;";
                else if (colorMap[p]) style += `color:${colorMap[p]};`;
              }
              return style ? `<span style="${style}">` : "</span>";
            })
              .replace(/\x1b\[m/g, "</span>")
              .replace(/\x1b\[0m/g, "</span>") // reset explicitly
              .replace(/\x1b\[[0-9;]*[A-Za-z]/g, "") // strip other ANSI codes (cursor, clear, etc)
              .replace(/\n/g, "<br>");
          }

          function addLog(type, message) {
            const line = document.createElement("div");
            line.className = "whitespace-pre-wrap break-all"; // Tailwind util
            // If type is power/system, maybe colorize prefix?
            line.innerHTML = ansiToHtml(message);
            logContainer.appendChild(line);
            logContainer.scrollTop = logContainer.scrollHeight;
          }

          // --- Terminal Init ---
          const term = new Terminal({
            theme: {
              background: '#0e0e0e',
              foreground: '#d4d4d4',
              cursor: '#ffffff',
              selectionBackground: 'rgba(255, 255, 255, 0.3)',
              black: '#000000',
              red: '#cd3131',
              green: '#0dbc79',
              yellow: '#e5e510',
              blue: '#2472c8',
              magenta: '#bc3fbc',
              cyan: '#11a8cd',
              white: '#e5e5e5',
              brightBlack: '#666666',
              brightRed: '#f14c4c',
              brightGreen: '#23d18b',
              brightYellow: '#f5f543',
              brightBlue: '#3b8eea',
              brightMagenta: '#d670d6',
              brightCyan: '#29b8db',
              brightWhite: '#e5e5e5'
            },
            fontFamily: 'JetBrains Mono, monospace',
            fontSize: 13,
            cursorBlink: true,
            cursorStyle: 'bar',
            disableStdin: true, // Read-only from this socket, input handled via cmd bar
            convertEol: true,
          });

          const fitAddon = new FitAddon.FitAddon();
          term.loadAddon(fitAddon);
          term.open(document.getElementById('terminal'));
          fitAddon.fit();

          // Resize observer to keep terminal fitting
          new ResizeObserver(() => fitAddon.fit()).observe(document.getElementById('terminal'));

          // Banner
          term.writeln('\x1b[1;32mWelcome to the console!\x1b[0m');
          term.writeln('Connecting to socket...');

          function termWrite(msg) {
            // Handle CRLF for proper line endings if backend sends only LF
            if (msg.includes && !msg.includes('\r')) {
              term.write(msg.replace(/\n/g, '\r\n'));
            } else {
              term.write(msg);
            }
          }

          // --- WebSockets ---
          let consoleWs, statsWs;

          let lastMsg = null;
          let lastMsgTime = 0;

          function connectConsole() {
            if (consoleWs && (consoleWs.readyState === WebSocket.OPEN || consoleWs.readyState === WebSocket.CONNECTING)) return;
            consoleWs = new WebSocket(`${protocol}://${window.location.hostname}:${window.location.port}/console/${serverId}`);

            consoleWs.onmessage = (evt) => {
              // Hide loading/error banner
              document.getElementById("systemnodedown").classList.add("hidden");

              let data;
              try { data = JSON.parse(evt.data); }
              catch {
                termWrite(evt.data); // Raw fallback
                return;
              }

              if (data.event === "cmd" || data.event === "error") {
                let msg = data.payload;
                if (typeof msg === 'string') {
                  termWrite(msg);
                } else {
                  termWrite(JSON.stringify(msg));
                }
              } else if (data.event && data.event.startsWith("power")) {
                termWrite(`\r\n\x1b[1;33m[System] ${data.payload}\x1b[0m\r\n`);
              } else if (data.event === "stats" || data.event === "status") {
                // Ignore stats/status updates in console to prevent spam
              } else {
                if (data.payload) {
                  const p = typeof data.payload === 'string' ? data.payload : JSON.stringify(data.payload);

                  // Simple deduplication for exact duplicates within 200ms
                  const now = Date.now();
                  if (p === lastMsg && (now - lastMsgTime) < 200) {
                    return;
                  }
                  lastMsg = p;
                  lastMsgTime = now;

                  termWrite(p);
                }
              }
            };

            consoleWs.onclose = () => {
              termWrite('\r\n\x1b[1;31m[System] Disconnected. Reconnecting...\x1b[0m\r\n');
              document.getElementById("systemnodedown").classList.remove("hidden");
              setTimeout(connectConsole, 2000);
            };
          }

          function connectStats() {
            if (statsWs && statsWs.readyState === WebSocket.OPEN) return;
            statsWs = new WebSocket(`${protocol}://${window.location.hostname}:${window.location.port}/stats/${serverId}`);

            statsWs.onmessage = (evt) => {
              // Got stats -> connection alive
              if (loadingOverlay) {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => loadingOverlay.classList.add('hidden'), 300);
              }

              try {
                const stats = JSON.parse(evt.data);
                updateStatsUI(stats);
              } catch (e) { }
            };

            statsWs.onclose = () => setTimeout(connectStats, 2000);
          }

          connectConsole();
          connectStats();

          // --- Stats Update Logic ---
          let uptimeSeconds = 0;

          function updateStatsUI(payload) {
            const stats = payload.stats || payload;
            if (!stats || !stats.cpu_stats) return;

            // Calc CPU
            const cpuDelta = stats.cpu_stats.cpu_usage.total_usage - stats.precpu_stats.cpu_usage.total_usage;
            const systemDelta = stats.cpu_stats.system_cpu_usage - stats.precpu_stats.system_cpu_usage;
            const cpuPercent = systemDelta > 0 ? (cpuDelta / systemDelta) * stats.cpu_stats.online_cpus * 100 : 0;

            // Calc RAM
            const ramPercent = stats.memory_stats.limit > 0 ? (stats.memory_stats.usage / stats.memory_stats.limit) * 100 : 0;

            // Update Charts
            pushChartData(usageChart, 0, cpuPercent);
            pushChartData(usageChart, 1, ramPercent);
            usageChart.update('none'); // Perf opt

            // Status Logic
            const isOnline = ramPercent > 0; // Rough heuristic used in original

            // Update Buttons
            const btns = document.querySelectorAll('#power-actions button');
            btns.forEach(btn => {
              const action = btn.dataset.action;
              btn.disabled = false;

              if (isOnline && action === 'start') btn.disabled = true;
              if (!isOnline && (action === 'stop' || action === 'restart')) btn.disabled = true;
            });

            // Update Badge
            if (isOnline) {
              statusEl2.textContent = "Online";
              statusEl2.className = "rounded-full bg-emerald-900/20 px-3 py-1 text-xs font-semibold text-emerald-400 border border-emerald-900/50 transition-colors";
              serverRunning = true;
            } else {
              statusEl2.textContent = "Offline";
              statusEl2.className = "rounded-full bg-red-900/20 px-3 py-1 text-xs font-semibold text-red-500 border border-red-900/50 transition-colors";
              serverRunning = false;
            }

            // Update uptime
            if (isOnline) uptimeSeconds = (payload.uptimeSeconds || uptimeSeconds) + 1; // Approx
            else uptimeSeconds = 0;

            if (isOnline) {
              const h = Math.floor(uptimeSeconds / 3600);
              const m = Math.floor((uptimeSeconds % 3600) / 60);
              uptimeEl.textContent = `${h}h ${m}m`;
            } else {
              uptimeEl.textContent = "Offline";
            }
          }

          // --- Chart Setup ---
          const ctx = document.getElementById('usageChart').getContext('2d');
          const usageChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: Array(20).fill(''),
              datasets: [
                {
                  label: 'CPU',
                  data: Array(20).fill(0),
                  borderColor: '#6366f1', // Indigo
                  tension: 0.4,
                  pointRadius: 0,
                  borderWidth: 2
                },
                {
                  label: 'RAM',
                  data: Array(20).fill(0),
                  borderColor: '#a855f7', // Purple
                  tension: 0.4,
                  pointRadius: 0,
                  borderWidth: 2
                },
                {
                  label: 'Disk',
                  data: Array(20).fill(0),
                  borderColor: '#ef4444', // Red
                  tension: 0.4,
                  pointRadius: 0,
                  borderWidth: 2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } }, // Custom legend used
              scales: {
                y: { beginAtZero: true, max: 100, grid: { color: '#333' }, ticks: { color: '#666' } },
                x: { display: false }
              },
              animation: false
            }
          });

          function pushChartData(chart, datasetIndex, val) {
            chart.data.datasets[datasetIndex].data.push(val);
            chart.data.datasets[datasetIndex].data.shift();
          }

          // --- Disk Update Loop ---
          setInterval(async () => {
            if (!serverRunning) return;
            try {
              const res = await fetch(`/server/size/${serverId}`, { method: "POST" });
              const data = await res.json();
              const usedBytes = data.size || 0;
              const totalBytes = totalDiskGB * 1024 * 1024 * 1024;
              const percent = totalBytes > 0 ? (usedBytes / totalBytes) * 100 : 0;

              pushChartData(usageChart, 2, percent);
              usageChart.update('none');
            } catch { }
          }, 2000);

          // --- Command Input ---
          document.getElementById("sendBtn").onclick = sendCmd;
          document.getElementById("cmdInput").onkeydown = (e) => { if (e.key === 'Enter') sendCmd(); };

          function sendCmd() {
            const input = document.getElementById("cmdInput");
            const cmd = input.value.trim();
            if (!cmd || !consoleWs || consoleWs.readyState !== WebSocket.OPEN) return;

            consoleWs.send(JSON.stringify({ event: "cmd", payload: { containerId, command: cmd } }));
            addLog("CMD", `\u001b[1m> ${cmd}\u001b[0m`);
            input.value = "";
          }

          // --- Power Actions & Modal ---
          const confirmModal = document.getElementById("confirm-modal");
          const confirmPanel = document.getElementById("confirm-panel");
          let pendingAction = null;

          document.querySelectorAll('#power-actions button').forEach(btn => {
            btn.onclick = () => {
              const action = btn.dataset.action;
              if (action === 'start') {
                sendPower(action);
              } else {
                openConfirm(action);
              }
            };
          });

          function openConfirm(action) {
            pendingAction = action;
            const title = document.getElementById("confirm-title");
            const msg = document.getElementById("confirm-message");
            const details = document.getElementById("confirm-details");
            const iconWrapper = document.getElementById("confirm-icon-wrapper");
            const confirmBtn = document.getElementById("confirm-action");

            if (action === 'stop') {
              title.textContent = "Stop Server?";
              msg.textContent = "This will forcefully terminate the process.";
              iconWrapper.className = "flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-red-900/20 text-red-500";
              confirmBtn.className = "flex items-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-sm font-bold text-white hover:bg-red-700";
            } else {
              title.textContent = "Restart Server?";
              msg.textContent = "The server will go offline briefly.";
              iconWrapper.className = "flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-yellow-900/20 text-yellow-500";
              confirmBtn.className = "flex items-center gap-2 rounded-lg bg-yellow-600 px-4 py-2 text-sm font-bold text-black hover:bg-yellow-500";
            }

            confirmModal.classList.remove("hidden");
            confirmModal.classList.add("flex");
            // Trigger reflow
            void confirmModal.offsetWidth;
            confirmPanel.classList.remove("scale-95", "opacity-0");
            confirmPanel.classList.add("scale-100", "opacity-100");
          }

          function closeConfirm() {
            confirmPanel.classList.remove("scale-100", "opacity-100");
            confirmPanel.classList.add("scale-95", "opacity-0");
            setTimeout(() => {
              confirmModal.classList.add("hidden");
              confirmModal.classList.remove("flex");
              pendingAction = null;
            }, 200);
          }

          document.getElementById("confirm-cancel").onclick = closeConfirm;
          document.getElementById("confirm-action").onclick = () => {
            if (pendingAction) sendPower(pendingAction);
            closeConfirm();
          };

          function sendPower(action) {
            if (!consoleWs || consoleWs.readyState !== WebSocket.OPEN) return;
            // Clear terminal on start
            if (action === 'start' || action === 'restart') logContainer.innerHTML = "";

            consoleWs.send(JSON.stringify({ event: `power:${action}`, payload: { containerId } }));
          }

    // --- EULA (If applicable) ---
    <% if (image && Array.isArray(image.features) && image.features.includes('EULA')) { %>
       const eulaModal = document.getElementById("eula-modal");
            const eulaPanel = document.getElementById("eula-panel");

            async function checkEula() {
              try {
                const res = await fetch(`/server/features/${serverId}/eula/currentState`);
                if (res.ok) {
                  const data = await res.json();
                  if (!data.eulaAccepted) {
                    eulaModal.classList.remove("hidden");
                    eulaModal.classList.add("flex"); // Ensure flex
                    setTimeout(() => {
                      eulaPanel.classList.remove("scale-95", "opacity-0");
                      eulaPanel.classList.add("scale-100", "opacity-100");
                    }, 10);
                  }
                }
              } catch { }
            }
            checkEula();

            document.getElementById("eula-accept").onclick = async () => {
              await fetch(`/server/features/${serverId}/eula/accept`, { method: "POST", headers: { "Content-Type": "application/json" } });
              eulaPanel.classList.remove("scale-100", "opacity-100");
              eulaPanel.classList.add("scale-95", "opacity-0");
              setTimeout(() => eulaModal.classList.add("hidden"), 200);
            };

            document.getElementById("eula-decline").onclick = () => {
              alert("You must accept the EULA to use this server.");
            };
    <% } %>

        </script>
</body>

</html>