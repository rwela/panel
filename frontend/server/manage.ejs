<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-space-grotesk">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    <%= name %> - <%= server.name %>
  </title>

  <link rel="stylesheet" href="/assets/tailwind.css">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* Combined log container styles */
    #logContainer {
      scroll-behavior: smooth;
      font-family: 'Space Grotesk', sans-serif;
      overflow-y: auto;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #logContainer::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body class="min-h-screen flex">
  <!-- Sidebar -->
  <%- include('../components/sidebar', { name: name, user: user }) %>

    <main class="flex-1 p-8 overflow-auto">
      <div class="max-w-6xl mx-auto space-y-6">

        <!-- Header card -->
        <div class="bg-neutral-950 border border-neutral-900 rounded-2xl px-6 py-4 flex items-center justify-between">
          <!-- LEFT INFO -->
          <div class="flex items-start gap-3">
            <!-- Status dot -->
            <span id="status-dot" class="mt-2"></span>

            <div class="leading-tight">
              <p class="text-lg font-semibold text-gray-100">
                <%= server.name %> <span id="uptime"
                    class="inline-flex items-center rounded-full bg-stone-500/10 px-2 py-0.5 text-xs font-medium text-stone-400">
                    0h 0m 0s
                  </span>
              </p>
              <p class="flex items-center gap-2 text-sm text-gray-400">
                <i data-lucide="globe" class="w-4 h-4 text-gray-500"></i>
                <span class="cursor-pointer " onclick="navigator.clipboard.writeText('<%= server.ip || '0.0.0.0' %>:<%= server.port %>'); 
             alert('Copied to clipboard!')">
                  <%= server.ip || '0.0.0.0' %>:<%= server.port %>
                      <span class="mx-1">•</span>
                      <%= server.node?.name || 'unknown' %>
                </span>
              </p>
            </div>
          </div>

          <!-- RIGHT ACTIONS -->
          <div id="power-actions" class="flex items-center gap-3 text-sm font-medium">
            <button data-action="start"
              class="flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-900/40 text-emerald-400 hover:bg-emerald-900/60 disabled:opacity-40 disabled:cursor-not-allowed">
              <i data-lucide="play" class="w-4 h-4"></i>
              Start
            </button>

            <button data-action="restart"
              class="flex items-center gap-2 px-4 py-2 rounded-xl bg-neutral-800 text-gray-300 hover:bg-neutral-700 disabled:opacity-40 disabled:cursor-not-allowed">
              <i data-lucide="rotate-cw" class="w-4 h-4"></i>
              Restart
            </button>

            <button data-action="stop"
              class="flex items-center gap-2 px-4 py-2 rounded-xl bg-red-900/40 text-red-400 hover:bg-red-900/60 disabled:opacity-40 disabled:cursor-not-allowed">
              <i data-lucide="square" class="w-4 h-4"></i>
              Stop
            </button>
          </div>
        </div>
        <!-- Node down banner -->
        <div id="systemnodedown" class="bg-red-700 text-gray-100 p-4 rounded-2xl flex items-center gap-3 mb-4 hidden">
          <svg class="animate-spin w-5 h-5 text-red-100" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span>System is having trouble connecting to the node. Please
            wait...</span>
        </div>

        <!-- Custom Terminal + Charts -->
        <style>
          /* Terminal styling */
          .terminal {
            padding: 1rem;
            border-radius: 0.5rem;
          }

          /* Custom selection color for the terminal */
          .terminal::selection {
            background-color: rgba(15, 15, 15, 0.5);
            /* bg-neutral-900/50 approx */
            color: inherit;
            /* Keep text color the same */
          }

          /* For Firefox */
          .terminal::-moz-selection {
            background-color: rgba(15, 15, 15, 0.5);
            color: inherit;
          }
        </style>

        <div class="flex gap-4 h-96">
          <!-- Terminal -->
          <div id="terminal"
            class="flex-1 bg-[#080808] border border-[#d4d4d4]/20 rounded-2xl flex flex-col overflow-hidden relative">
            <!-- Loading spinner inside terminal -->
            <div id="loading-overlay" class="absolute inset-0 z-10 flex items-center justify-center bg-[#080808]/80">
              <i data-lucide="loader" class="animate-spin w-8 h-8 text-gray-100"></i>
            </div>

            <!-- Terminal log -->
            <div id="logContainer" class="terminal flex-1 p-4 text-[#d4d4d4] text-sm space-y-1 relative"></div>
            <!-- Input -->
            <div class="flex items-center bg-[#080808] border border-[#d4d4d4]/20 rounded">
              <!-- Input wrapper -->
              <div class="relative flex-1">
                <i data-lucide="chevron-right"
                  class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[#d4d4d4]/80"></i>
                <input id="cmdInput" type="text" placeholder="Type a command..."
                  class="w-full bg-neutral-950 border-none rounded px-10 py-2 text-neutral-300 focus:outline-none focus:ring-2 focus:ring-[#d4d4d4]/50" />
              </div>
              <button id="sendBtn"
                class="bg-gray-100 text-stone-900 px-4 py-2 rounded font-semibold hover:bg-gray-300 transition active:scale-95 flex items-center gap-2">
                <i data-lucide="send" class="w-5 h-5 text-[#080808]"></i>
                <span>Send</span>
              </button>

            </div>

          </div>
        </div>

        <!-- Charts -->
        <div class="flex gap-4 h-96 w-full">
          <div class="bg-neutral-950 border border-neutral-800 rounded-2xl p-6 space-y-4 flex-1">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-semibold text-white">Server Usage</h2>
              <span id="written-status2"
                class="inline-flex items-center rounded-full bg-stone-500/10 px-2 py-0.5 text-xs font-medium text-stone-400">
                Loading
              </span>
            </div>

            <!-- Chart container -->
            <div class="mt-4 h-64 w-full">
              <canvas id="usageChart" class="h-full w-full"></canvas>
            </div>

            <!-- Mini legend like your friend -->
            <div class="flex items-center gap-6 mt-4 text-xs text-white/60">
              <div class="flex items-center gap-2">
                <div class="h-2 w-2 rounded-full bg-blue-500"></div> CPU
              </div>
              <div class="flex items-center gap-2">
                <div class="h-2 w-2 rounded-full bg-purple-500"></div> RAM
              </div>
              <div class="flex items-center gap-2">
                <div class="h-2 w-2 rounded-full bg-red-500"></div> Disk
              </div>
            </div>
          </div>
        </div>


      </div>
      <!-- Modal wrapper -->
      <div id="confirm-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <!-- Overlay -->
        <div id="confirm-overlay"
          class="absolute inset-0 bg-neutral-950/80 backdrop-blur-sm transition-opacity duration-200"></div>

        <!-- Modal panel -->
        <div id="confirm-panel" role="dialog" aria-modal="true" aria-labelledby="confirm-title"
          class="relative z-10 max-w-lg w-full mx-4 rounded-2xl bg-neutral-950 text-gray-100 shadow-xl ring-1 ring-black/10 overflow-hidden transform transition-all duration-200 ease-out scale-95 opacity-0 border border-neutral-900">
          <div class="p-6">
            <div class="flex items-start gap-4">
              <i id="confirm-icon" data-lucide="alert-triangle" class="w-8 h-8 text-yellow-600"></i>
              <div class="flex-1">
                <h2 id="confirm-title" class="text-lg font-semibold">
                  Confirm action
                </h2>
                <p id="confirm-message" class="mt-1 text-sm text-neutral-300">
                  Are you sure you want to proceed? This action cannot be
                  undone.
                </p>
              </div>
            </div>

            <div id="confirm-details" class="mt-4 text-xs text-neutral-300"></div>

            <div class="mt-6 flex justify-end gap-3">
              <button id="confirm-cancel" class="px-4 py-2 rounded-lg text-neutral-800 bg-gray-100 hover:bg-gray-200">
                Cancel
              </button>
              <button id="confirm-action"
                class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm bg-red-600 hover:bg-red-700 text-white">
                <i id="confirm-action-icon" data-lucide="trash" class="w-4 h-4"></i>
                Confirm
              </button>
            </div>
          </div>
        </div>
      </div>
      <% if (image && Array.isArray(image.features) && image.features.includes('EULA')) { %>
        <div id="eula-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
          <!-- Overlay -->
          <div id="eula-overlay"
            class="absolute inset-0 bg-neutral-950/80 backdrop-blur-sm transition-opacity duration-200"></div>

          <!-- Modal panel -->
          <div id="eula-panel" role="dialog" aria-modal="true" aria-labelledby="eula-title"
            class="relative z-10 max-w-lg w-full mx-4 rounded-2xl bg-neutral-950 text-gray-100 shadow-xl ring-1 ring-black/10 overflow-hidden transform transition-all duration-200 ease-out scale-95 opacity-0 border border-neutral-900">
            <div class="p-6">
              <div class="flex flex-col gap-4">
                <h2 id="eula-title" class="text-lg font-semibold">Accept EULA</h2>
                <p class="text-sm text-neutral-300">
                  To start this server, you must accept the Minecraft EULA.
                </p>

                <div class="flex justify-end gap-3 mt-4">
                  <button id="eula-decline" class="px-4 py-2 rounded-lg text-neutral-800 bg-gray-100 hover:bg-gray-200">
                    Decline
                  </button>
                  <button id="eula-accept"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm bg-green-600 hover:bg-green-700 text-white">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Accept
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <% } %>


          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script>
            let itsopendawg = false;

            function checkLoadingComplete() {
              if (itsopendawg) {
                // no need for stats ws since if console online = stats online aswell
                const overlay = document.getElementById("loading-overlay");
                overlay.style.opacity = "0";

                setTimeout(() => {
                  overlay.classList.add("hidden");
                }, 500);
              }
            }
            // --- DOM refs ---
            const logContainer = document.getElementById("logContainer");

            // 20-point sliding window for charts
            const labels = Array.from({ length: 20 }, (_, i) => i - 19);

            // Show/hide the "node down" banner
            function nodeoff(isVisible) {
              const banner = document.getElementById("systemnodedown");
              banner.classList.toggle("hidden", !isVisible);
            }

            const logColors = {
              INFO: "#d4d4d4",
              WARN: "#f59e0b",
              ERROR: "#ef4444",
              SYSTEM: "#10b981",
              POWER: "#fbbf24",
              COMMAND: "#3b82f6",
              DAEMON: "#8b5cf6",
            };

            function hexToAlpha(hex, alpha) {
              const r = parseInt(hex.slice(1, 3), 16);
              const g = parseInt(hex.slice(3, 5), 16);
              const b = parseInt(hex.slice(5, 7), 16);
              return `rgba(${r},${g},${b},${alpha})`;
            }

            function stripAnsiCodes(str) {
              return str.replace(/\x1b\[[0-9;]*m/g, "");
            }

            function ansiToHtml(msg) {
              // Keep only SGR (m) sequences for color/bold — other sequences removed
              msg = msg.replace(
                /\x1b\[([0-9;?]*)([A-Za-z])/g,
                (match, codes, command) => {
                  return command === "m" ? match : "";
                }
              );

              const colorMap = {
                30: "black",
                31: "red",
                32: "green",
                33: "orange",
                34: "blue",
                35: "magenta",
                36: "cyan",
                37: "white",
                90: "gray",
                91: "lightcoral",
                92: "lightgreen",
                93: "yellow",
                94: "lightblue",
                95: "violet",
                96: "lightcyan",
                97: "white",
              };

              return msg
                .replace(/\x1b\[([0-9;]+)m/g, (match, codes) => {
                  const parts = codes.split(";");
                  let color = null;
                  let bold = false;
                  for (const p of parts) {
                    if (p === "1") bold = true;
                    else if (colorMap[p]) color = colorMap[p];
                  }
                  if (color)
                    return `<span style="color:${color};${bold ? "font-weight:bold" : ""
                      }">`;
                  return "</span>";
                })
                .replace(/\x1b\[m/g, "</span>")
                .replace(/\r/g, "")
                .replace(/\n/g, "<br>");
            }

            function parseServerMessage(msg) {
              msg = msg.replace(/^[>=\.]+ ?/g, "").trim();
              const timestampRegex = /^\[(\d{2}:\d{2}:\d{2}) (\w+)\]:\s*(.*)$/;
              const tsMatch = msg.match(timestampRegex);
              if (tsMatch) {
                return { type: tsMatch[2].toUpperCase(), text: msg };
              }

              const typeRegex = /^(\w+)\s+(.*)$/;
              const typeMatch = msg.match(typeRegex);
              if (
                typeMatch &&
                [
                  "INFO",
                  "WARN",
                  "ERROR",
                  "SYSTEM",
                  "DAEMON",
                  "COMMAND",
                  "POWER",
                ].includes(typeMatch[1].toUpperCase())
              ) {
                return { type: typeMatch[1].toUpperCase(), text: msg };
              }

              return { type: "INFO", text: msg };
            }

            function addLog(type, message) {
              const logLine = document.createElement("div");
              logLine.classList.add("whitespace-pre-wrap", "break-all", "leading-tight");

              const text = document.createElement("span");
              text.classList.add("font-mono");
              text.innerHTML = ansiToHtml(message);

              logLine.appendChild(text);
              logContainer.appendChild(logLine);

              logContainer.scrollTop = logContainer.scrollHeight;
            }

            // --- WebSockets ---
            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            const serverId = "<%= server.id %>";
            const containerId = "<%= server.idt %>";
            let consoleWs;

            function ccws() {
              if (consoleWs && consoleWs.readyState === WebSocket.OPEN) return;
              consoleWs = new WebSocket(
                `${protocol}://${window.location.hostname}${window.location.port ? ":" + window.location.port : ""
                }/console/${serverId}`
              );

              consoleWs.onmessage = (evt) => {
                let data;
                try {
                  data = JSON.parse(evt.data);
                } catch (err) {
                  let fallback = parseServerMessage(evt.data);
                  fallback.text = fallback.text.replace(/>....+/g, '');
                  fallback.text = fallback.text.replace(/\x1b=/g, '');
                  addLog(fallback?.type || "LOG", `${fallback?.text}`);
                  return;
                }

                let parsedPayload;
                if (typeof data.payload === "string")
                  parsedPayload = parseServerMessage(data.payload);
                else return; // ignore non-string payloads for logs

                nodeoff(false);

                try {
                  if (data.event === "cmd" || data.event === "error") {
                    addLog(parsedPayload.type, parsedPayload.text);
                  } else if (data.event && data.event.startsWith("power")) {
                    addLog("POWER", data.payload);
                  } else {
                    addLog("INFO", `Unhandled event: ${data.event}`);
                  }
                } catch (err) {
                  console.error("Error processing message:", err, evt.data);
                }
              };

              consoleWs.onclose = () => {
                addLog(
                  "",
                  "\u001b[31m[talorix] \x1b[0mDisconnected from WebSocket. Attempting to Reconnect in 2 seconds"
                );
                nodeoff(true);

                setTimeout(() => ccws(), 2000);
              };

              consoleWs.onerror = () => addLog("ERROR", "WebSocket error");
            }
            ccws();
            let statsWs;
            function csws() {
              if (statsWs && statsWs.readyState === WebSocket.OPEN) return;
              statsWs = new WebSocket(
                `${protocol}://${window.location.hostname}${window.location.port ? ":" + window.location.port : ""
                }/stats/${serverId}`
              );

              statsWs.onmessage = (evt) => {
                nodeoff(false);
                itsopendawg = true;
                checkLoadingComplete();
                try {
                  const stats = JSON.parse(evt.data);
                  updateStatus(stats);
                } catch (err) {
                  console.error("Invalid stats data:", evt.data);
                }
              };

              statsWs.onclose = () => {
                addLog(
                  "DAEMON",
                  "\u001b[31m[talorix] \x1b[0mDisconnected from Stats WebSocket. Reconnecting in 2 seconds"
                );
                setTimeout(() => csws(), 2000);
              };

              statsWs.onerror = () => addLog("ERROR", "Stats WebSocket error");
            }

            csws();

            function sendConsoleCommand(cmd) {
              if (
                !cmd ||
                typeof consoleWs === "undefined" ||
                consoleWs.readyState !== WebSocket.OPEN
              ) {
                addLog("ERROR", "Cannot send command: WebSocket not connected or empty command.");
                return;
              }

              consoleWs.send(
                JSON.stringify({
                  event: "cmd",
                  payload: { containerId, command: cmd },
                })
              );

              addLog("COMMAND", cmd);
            }

            // Attach it to your send button
            document.getElementById("sendBtn").addEventListener("click", () => {
              const input = document.getElementById("cmdInput");
              const cmd = input.value.trim();
              sendConsoleCommand(cmd);
              input.value = "";
            });

            document
              .getElementById("cmdInput")
              .addEventListener("keydown", (e) => {
                if (e.key === "Enter") document.getElementById("sendBtn").click();
              });

            // Confirmation modal
            const modal = document.getElementById("confirm-modal");
            const overlay = document.getElementById("confirm-overlay");
            const confirmTitle = document.getElementById("confirm-title");
            const confirmMessage = document.getElementById("confirm-message");
            const confirmDetails = document.getElementById("confirm-details");
            const confirmIcon = document.getElementById("confirm-icon");
            const confirmActionBtn = document.getElementById("confirm-action");
            const confirmActionIcon = document.getElementById(
              "confirm-action-icon"
            );
            const cancelBtn = document.getElementById("confirm-cancel");
            const confirmPanel = document.getElementById("confirm-panel");

            let pendingAction = null;

            function openConfirm(action) {
              pendingAction = action;

              if (action === "stop") {
                confirmTitle.textContent = "Confirm STOP";
                confirmMessage.textContent =
                  "Are you sure you want to STOP the container? Stopping will terminate the running process.";
                confirmDetails.textContent =
                  "You can start the container again afterwards if needed.";
                confirmIcon.setAttribute("data-lucide", "x-circle");
                confirmIcon.classList.remove("text-yellow-600");
                confirmIcon.classList.add("text-red-600");
                confirmActionBtn.classList.remove(
                  "bg-yellow-600",
                  "hover:bg-yellow-700"
                );
                confirmActionBtn.classList.add("hover:bg-red-700", "bg-red-600");
                confirmActionIcon.setAttribute("data-lucide", "x");
              } else if (action === "restart") {
                confirmTitle.textContent = "Confirm RESTART";
                confirmMessage.textContent =
                  "Are you sure you want to RESTART the container? The service will briefly go offline.";
                confirmDetails.textContent =
                  "This will stop and then start the container automatically.";
                confirmIcon.setAttribute("data-lucide", "rotate-cw");
                confirmIcon.classList.remove("text-red-600");
                confirmIcon.classList.add("text-yellow-600");
                confirmActionBtn.classList.remove(
                  "bg-red-600",
                  "hover:bg-red-700"
                );
                confirmActionBtn.classList.add(
                  "bg-yellow-600",
                  "hover:bg-yellow-700"
                );
                confirmActionIcon.setAttribute("data-lucide", "refresh-cw");
              } else {
                confirmTitle.textContent = "Confirm action";
                confirmMessage.textContent = "Are you sure?";
                confirmIcon.setAttribute("data-lucide", "alert-triangle");
                confirmActionIcon.setAttribute("data-lucide", "check");
              }

              modal.classList.remove("hidden");

              requestAnimationFrame(() => {
                confirmPanel.classList.remove("scale-95", "opacity-0");
                confirmPanel.classList.add("scale-100", "opacity-100");
              });

              if (window.lucide) lucide.createIcons();
              document.documentElement.style.overflow = "hidden";
              confirmActionBtn.focus();
            }

            function closeConfirm() {
              confirmPanel.classList.remove("scale-100", "opacity-100");
              confirmPanel.classList.add("scale-95", "opacity-0");

              setTimeout(() => {
                modal.classList.add("hidden");
                document.documentElement.style.overflow = "";
                pendingAction = null;
              }, 200);
            }
            let diskUsageGB = 0;
            let diskUsageMB = 0;
            let diskUsageKB = 0;
            let totalDiskGB = parseFloat("<%= server.disk %>");
            let serverRunning = false; // track server state
            async function updateDiskUsage() {
              if (!serverRunning) {
                return;
              };
              try {
                const res = await fetch(`/server/size/${serverId}`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                });

                const data = await res.json();
                const usageBytes = data.size || 0;

                const totalDiskBytes = totalDiskGB * 1024 * 1024 * 1024;

                const diskPercent =
                  totalDiskBytes > 0
                    ? (usageBytes / totalDiskBytes) * 100
                    : 0;

                const diskDataset = usageChart.data.datasets[2];

                diskDataset.data.push(diskPercent);
                diskDataset.data.shift();
                usageChart.update();

              } catch (err) {
                console.error("Failed to fetch disk usage:", err);
              }
            }

            updateDiskUsage();
            setInterval(updateDiskUsage, 1000);
            function sendPowerCommand(action) {
              // Prevent starting/restarting if disk is full
              if (
                (action === "start" || action === "restart") &&
                diskUsageGB >= totalDiskGB
              ) {
                addLog("POWER", "Cannot start/restart: server disk is full!");
                return;
              }

              try {
                if (action === "start" || action === "restart") {
                  logContainer.innerHTML = ""
                }
                if (action === "stop") {
                  sendConsoleCommand('<%= server.image.stopCmd %>');
                  return;
                }
                if (
                  typeof consoleWs !== "undefined" &&
                  consoleWs.readyState === WebSocket.OPEN
                ) {
                  consoleWs.send(
                    JSON.stringify({
                      event: `power:${action}`,
                      payload: { containerId },
                    })
                  );
                  // Track server running state
                  if (action === "start" || action === "restart")
                    serverRunning = true;
                  if (action === "stop") logContainer.innerHTML = ""; serverRunning = false;
                } else {
                  addLog(
                    "ERROR",
                    "WebSocket not connected. Cannot send power command."
                  );
                }
              } catch (err) {
                addLog(
                  "ERROR",
                  "Failed to send power command: " +
                  (err && err.message ? err.message : err)
                );
              }
            }

            document
              .querySelectorAll("#power-actions button[data-action]")
              .forEach((btn) => {
                btn.addEventListener("click", () => {
                  const action = btn.getAttribute("data-action");
                  if (action === "stop" || action === "restart") {
                    openConfirm(action);
                    return;
                  }
                  if (
                    typeof consoleWs !== "undefined" &&
                    consoleWs.readyState === WebSocket.OPEN
                  ) {
                    consoleWs.send(
                      JSON.stringify({
                        event: `power:${action}`,
                        payload: { containerId },
                      })
                    );
                  } else {
                    addLog(
                      "ERROR",
                      "WebSocket not connected. Cannot send power command."
                    );
                  }
                });
              });

            confirmActionBtn.addEventListener("click", async () => {
              if (!pendingAction) {
                closeConfirm();
                return;
              }

              await sendPowerCommand(pendingAction);
              closeConfirm();
            });

            cancelBtn.addEventListener("click", closeConfirm);
            overlay.addEventListener("click", closeConfirm);

            window.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && !modal.classList.contains("hidden"))
                closeConfirm();
            });
            const usageChart = new Chart(document.getElementById('usageChart'), {
              type: 'line',
              data: {
                labels, // your existing 20-point sliding window
                datasets: [
                  {
                    label: 'CPU Usage (%)',
                    data: Array(20).fill(0),
                    borderColor: '#3b82f6', // blue
                    borderWidth: 2,
                    tension: 0.4, // smooth monotone-like curve
                    pointRadius: 0, // hide points
                    fill: false, // no fill
                  },
                  {
                    label: 'RAM Usage (%)',
                    data: Array(20).fill(0),
                    borderColor: '#8b5cf6', // purple
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0,
                    fill: false,
                  },
                  {
                    label: 'Disk Usage (%)',
                    data: Array(20).fill(0),
                    borderColor: '#ef4444', // red
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0,
                    fill: false,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                  mode: 'index',
                  intersect: false,
                },
                plugins: {
                  legend: {
                    labels: {
                      color: '#e5e7eb', // gray-200
                      usePointStyle: true,
                      pointStyle: 'circle',
                      padding: 20,
                    },
                  },
                  tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    callbacks: {
                      label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`,
                    },
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                      color: '#9ca3af', // gray-400
                      callback: (v) => `${v}%`,
                    },
                    grid: {
                      color: 'rgba(255,255,255,0.05)', // subtle
                      drawBorder: false,
                    },
                  },
                  x: {
                    ticks: {
                      color: '#9ca3af',
                    },
                    grid: {
                      display: false, // clean look
                      drawBorder: false,
                    },
                  },
                },
              },
            });


            function updateStatus(payload) {
              const stats = payload.stats || payload;

              if (
                !stats ||
                !stats.cpu_stats ||
                !stats.precpu_stats ||
                !stats.memory_stats
              ) {
                console.error("Invalid stats data:", payload);
                return;
              }

              // ----- CPU % -----
              const cpuDelta =
                stats.cpu_stats.cpu_usage.total_usage -
                stats.precpu_stats.cpu_usage.total_usage;

              const systemDelta =
                stats.cpu_stats.system_cpu_usage -
                stats.precpu_stats.system_cpu_usage;

              const cpuPercent =
                systemDelta > 0
                  ? (cpuDelta / systemDelta) *
                  stats.cpu_stats.online_cpus *
                  100
                  : 0;

              // ----- RAM % -----
              const ramPercent =
                stats.memory_stats.limit > 0
                  ? (stats.memory_stats.usage / stats.memory_stats.limit) * 100
                  : 0;

              // Update merged chart
              usageChart.data.datasets[0].data.push(cpuPercent);
              usageChart.data.datasets[0].data.shift();

              usageChart.data.datasets[1].data.push(ramPercent);
              usageChart.data.datasets[1].data.shift();

              usageChart.update();

              const online = ramPercent > 0;
              const statusEl2 = document.getElementById('written-status2');
              const statusDot = document.getElementById('status-dot');
              function formatUptime(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                const parts = [];
                if (h) parts.push(`${h}h`);
                if (m) parts.push(`${m}m`);
                parts.push(`${s}s`);
                return parts.join(" ");
              }
              let uptimeSeconds = 0;
              const data = payload;
              uptimeSeconds = data.uptimeSeconds || uptimeSeconds;
              setInterval(() => {
                if (statusEl2.textContent.includes("Running")) {
                  uptimeSeconds++;
                } else {
                  uptimeSeconds = 0;
                }
                document.getElementById('uptime').textContent = formatUptime(uptimeSeconds);
              }, 1000);
              if (statusDot) {
                statusDot.innerHTML = online
                  ? `<span class="relative inline-flex h-3 w-3 items-center justify-center"><span class="absolute h-3 w-3 rounded-full bg-emerald-500 opacity-35"></span><span class="relative h-1.5 w-1.5 rounded-full bg-emerald-500"></span></span>`
                  : `<span class="relative inline-flex h-3 w-3 items-center justify-center"><span class="absolute h-3 w-3 rounded-full bg-gray-400 opacity-35"></span><span class="relative h-1.5 w-1.5 rounded-full bg-gray-400"></span></span>`;
              }
              if (online) {
                statusEl2.textContent = 'Running';
                statusEl2.classList.remove('bg-red-500/10', 'text-red-400');
                statusEl2.classList.remove('bg-stone-500/10', 'text-stone-400');
                statusEl2.classList.add('bg-green-500/10', 'text-green-400');
              } else {
                statusEl2.textContent = 'Offline';
                statusEl2.classList.remove('bg-stone-500/10', 'text-stone-400');
                statusEl2.classList.remove('bg-green-500/10', 'text-green-400');
                statusEl2.classList.add('bg-red-500/10', 'text-red-400');
              }
              document
                .querySelectorAll('#power-actions button[data-action]')
                .forEach((btn) => {
                  const action = btn.getAttribute('data-action');


                  btn.disabled = false;
                  btn.classList.remove('opacity-50', 'cursor-not-allowed');


                  if (online && action === 'start') {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                  }


                  if (!online && (action === 'stop' || action === 'restart')) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                  }
                });
            }

           <% if (image && Array.isArray(image.features) && image.features.includes('EULA')) { %>
  const eulaModal = document.getElementById("eula-modal");
              const eulaPanel = document.getElementById("eula-panel");
              const eulaOverlay = document.getElementById("eula-overlay");
              const eulaAcceptBtn = document.getElementById("eula-accept");
              const eulaDeclineBtn = document.getElementById("eula-decline");

              async function checkEula() {
                try {
                  const res = await fetch(`/server/features/<%= server.id %>/eula/currentState`);
                  if (!res.ok) {
                    return;
                  }
                  const data = await res.json();

                  if (!data.eulaAccepted) {
                    openEulaModal();
                  }
                } catch (err) {
                  console.error("Failed to check EULA state:", err);
                }
              }

              function openEulaModal() {
                eulaModal.classList.remove("hidden");
                requestAnimationFrame(() => {
                  eulaPanel.classList.remove("scale-95", "opacity-0");
                  eulaPanel.classList.add("scale-100", "opacity-100");
                });
                document.documentElement.style.overflow = "hidden";
              }

              function closeEulaModal() {
                eulaPanel.classList.remove("scale-100", "opacity-100");
                eulaPanel.classList.add("scale-95", "opacity-0");
                setTimeout(() => {
                  eulaModal.classList.add("hidden");
                  document.documentElement.style.overflow = "";
                }, 200);
              }

              eulaAcceptBtn.addEventListener("click", async () => {
                try {
                  const res = await fetch(`/server/features/<%= server.id %>/eula/accept`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                  });
                  const data = await res.json();
                  if (data.success) closeEulaModal();
                  else alert("Failed to accept EULA: " + data.message);
                } catch (err) {
                  console.error("Error accepting EULA:", err);
                }
              });

              eulaDeclineBtn.addEventListener("click", () => {
                closeEulaModal();
                alert("You must accept the EULA to start the server.");
              });

              eulaOverlay.addEventListener("click", closeEulaModal);

              window.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && !eulaModal.classList.contains("hidden")) {
                  closeEulaModal();
                }
              });

              checkEula();
  <% } %>
          if (window.lucide) lucide.createIcons();
          </script>
          </div>
    </main>
</body>

</html>