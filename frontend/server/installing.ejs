<!DOCTYPE html>
<html lang="en" class="h-full bg-black text-white font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Installing - <%= server.name %> - <%= name %></title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.95);
        opacity: 1;
      }
      50% {
        transform: scale(1.05);
        opacity: 0.7;
      }
      100% {
        transform: scale(0.95);
        opacity: 1;
      }
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .pulse-ring {
      animation: pulse-ring 2s ease-in-out infinite;
    }

    .float-animation {
      animation: float 3s ease-in-out infinite;
    }

    @keyframes progress-bar {
      0% {
        width: 0%;
      }
      100% {
        width: 100%;
      }
    }

    .progress-bar {
      animation: progress-bar 2s ease-in-out infinite;
    }
    
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #000;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }
  </style>
</head>

<body class="flex h-full w-full overflow-hidden">

  <%- include('../components/sidebar', { name: name, user: user }) %>

  <main class="relative flex-1 overflow-y-auto bg-black">
    <div class="mx-auto max-w-4xl px-6 py-12 md:px-12">

      <!-- Installation Container -->
      <div class="flex min-h-[600px] flex-col items-center justify-center">
        
        <!-- Icon Container -->
        <div class="relative mb-8">
          <!-- Pulsing rings -->
          <div class="absolute inset-0 rounded-full bg-neutral-800/30 pulse-ring"></div>
          <div class="absolute inset-0 rounded-full bg-neutral-800/20 pulse-ring" style="animation-delay: 0.5s;"></div>
          
          <!-- Main icon -->
          <div class="relative flex h-32 w-32 items-center justify-center rounded-full bg-neutral-900 border border-neutral-800 float-animation">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-16 w-16 text-gray-100">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 01-3-3m3 3a3 3 0 100 6h13.5a3 3 0 100-6m-16.5-3a3 3 0 013-3h13.5a3 3 0 013 3m-19.5 0a4.5 4.5 0 01.9-2.7L5.737 5.1a3.375 3.375 0 012.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 01.9 2.7m0 0a3 3 0 01-3 3m0 3h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008zm-3 6h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008z" />
            </svg>
          </div>
        </div>

        <!-- Status Text -->
        <h1 class="mb-2 text-3xl font-bold tracking-tight text-white md:text-4xl">
          Installing Server
        </h1>
        <p class="mb-8 text-center text-neutral-400 max-w-md">
          Please wait while we set up <span class="text-white font-semibold"><%= server.name %></span>. This may take a few minutes.
        </p>

        <!-- Progress Bar -->
        <div class="w-full max-w-md mb-8">
          <div class="h-2 w-full overflow-hidden rounded-full bg-neutral-900 border border-neutral-800">
            <div class="h-full bg-gradient-to-r from-neutral-700 to-gray-100 progress-bar"></div>
          </div>
        </div>

        <!-- Current Status -->
        <div class="rounded-xl border border-neutral-800 bg-neutral-950 px-6 py-4 text-center">
          <div class="flex items-center justify-center gap-3">
            <svg class="animate-spin h-5 w-5 text-gray-100" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <span id="status-text" class="text-sm font-medium text-gray-100">
              Checking installation status...
            </span>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="mt-8 text-center text-xs text-neutral-500">
          <p>Server ID: <span class="font-mono text-neutral-400"><%= server.id %></span></p>
        </div>

      </div>

    </div>
  </main>

  <script>
    const serverId = "<%= server.id %>";
    const statusText = document.getElementById("status-text");
    let checkCount = 0;
    const maxChecks = 8200; // Approx 2 hours 

    const statusMessages = [
      "Setting up server environment...",
      "Installing necessary packages...",
      "Configuring server settings...", 
      "Finalizing installation...",
      "Almost there, just a moment..."
    ];

    function updateStatusMessage() {
      const messageIndex = Math.floor(checkCount / 10) % statusMessages.length;
      statusText.textContent = statusMessages[messageIndex];
    }

    async function checkServerState() {
      try {
        const response = await fetch(`/server/state/${serverId}`);
        if (!response.ok) throw new Error('Failed to fetch server state');
        
        const data = await response.json();
        checkCount++;

        if (data.state === 'running') {
          statusText.textContent = "Installation complete! Redirecting...";
          setTimeout(() => {
            window.location.href = `/server/manage/${serverId}`;
          }, 1000);
          return;
        }

        if (data.state === 'failed' || checkCount >= maxChecks) {
          statusText.textContent = "Installation failed. Redirecting to dashboard...";
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 2000);
          return;
        }
        if (data.state === 'not_found') {
          statusText.textContent = "Server not found. Redirecting to dashboard...";
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 2000);
          return;
        }
        updateStatusMessage();
        setTimeout(checkServerState, 1000);
      } catch (error) {
        console.error('Error checking server state:', error);
        checkCount++;

        if (checkCount >= maxChecks) {
          statusText.textContent = "Unable to verify installation. Redirecting to dashboard...";
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 2000);
          return;
        }

        // Retry
        setTimeout(checkServerState, 1000);
      }
    }
    checkServerState();
  </script>

</body>

</html>