<!DOCTYPE html>
<html lang="en" class="h-full bg-black text-white font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= name %> - <%= server.name %> Files
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    .font-mono {
      font-family: 'JetBrains Mono', monospace;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #000;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    mark {
      @apply bg-yellow-500/30 text-yellow-200 rounded-sm px-0.5;
    }

    /* Transitions */
    .fade-enter-active,
    .fade-leave-active {
      transition: opacity 0.2s;
    }

    .fade-enter-from,
    .fade-leave-to {
      opacity: 0;
    }

    .slide-up-enter-active,
    .slide-up-leave-active {
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .slide-up-enter-from,
    .slide-up-leave-to {
      transform: translateY(100%);
      opacity: 0;
    }
  </style>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preload" href="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js" as="script">
</head>

<body class="flex h-full w-full overflow-hidden">

  <%- include('../../components/sidebar', { name: name, user: user }) %>

    <main class="relative flex-1 overflow-y-auto bg-black">
      <div class="mx-auto max-w-7xl px-6 py-12 md:px-12 animate-fade-in-up">

        <!-- Header -->
        <div class="mb-8 flex flex-col justify-between gap-6 md:flex-row md:items-end">
          <div>
            <h1 class="text-3xl font-bold tracking-tight text-white md:text-4xl">File Manager</h1>
            <p class="mt-2 text-neutral-400">Manage your server's files and directories.</p>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-2">
            <button id="newFileBtn"
              class="flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2 text-sm font-bold text-white hover:bg-neutral-800 hover:scale-105 active:scale-95 transition-all">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
              </svg>
              New File
            </button>
            <button id="newFolderBtn"
              class="flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2 text-sm font-bold text-white hover:bg-neutral-800 hover:scale-105 active:scale-95 transition-all">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 10.5v6m3-3H9m4.06-7.19l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
              </svg>
              New Folder
            </button>
            <button id="uploadFileBtn"
              class="flex items-center gap-2 rounded-lg bg-white px-4 py-2 text-sm font-bold text-black hover:bg-neutral-200 hover:scale-105 active:scale-95 transition-all shadow-lg hover:shadow-white/20">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
              </svg>
              Upload
            </button>
            <input type="file" id="uploadFileInput" class="hidden" multiple />
          </div>
        </div>

        <!-- Navigation & Search Bar -->
        <div
          class="mb-4 flex flex-col gap-4 md:flex-row md:items-center md:justify-between rounded-xl border border-neutral-900 bg-neutral-950 p-3 animate-scale-in delay-100">
          <!-- Breadcrumbs -->
          <div class="flex items-center gap-2 overflow-x-auto text-sm font-medium text-neutral-400 px-2 scrollbar-hide">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="h-4 w-4 shrink-0">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
            </svg>
            <a href="?path=/" class="hover:text-white transition-colors">/talon/<%= server.id %></a>
            <% const pathParts=path.split('/').filter(Boolean); let accumulatedPath='' ; %>
              <% pathParts.forEach((part, index)=> { accumulatedPath += '/' + part; %>
                <span class="text-neutral-600">/</span>
                <% if (index < pathParts.length - 1) { %>
                  <a href="?path=<%= encodeURIComponent(accumulatedPath) %>"
                    class="hover:text-white transition-colors truncate max-w-[150px]">
                    <%= part %>
                  </a>
                  <% } else { %>
                    <span class="text-white font-bold truncate max-w-[150px]">
                      <%= part %>
                    </span>
                    <% } %>
                      <% }) %>
          </div>

          <!-- Search -->
          <div class="relative w-full md:w-64">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-neutral-500">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <input id="searchInput" type="text" placeholder="Search files..."
              class="w-full rounded-lg border border-neutral-800 bg-neutral-900 py-2 pl-9 pr-4 text-sm text-white placeholder-neutral-500 outline-none focus:border-neutral-600 focus:ring-1 focus:ring-neutral-600 transition-all focus:scale-[1.02]" />
          </div>
        </div>

        <!-- Files List -->
        <div class="overflow-hidden rounded-2xl border border-neutral-900 bg-neutral-950 animate-scale-in delay-200">
          <table class="w-full text-left text-sm">
            <thead class="border-b border-neutral-900 bg-neutral-900/50 text-neutral-400">
              <tr>
                <th class="w-10 px-4 py-3">
                  <div class="flex items-center">
                    <input id="selectAllCheckbox" type="checkbox"
                      class="h-4 w-4 appearance-none rounded border border-neutral-700 bg-neutral-800 text-white checked:bg-white checked:border-white checked:bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwb2x5bGluZSBwb2ludHM9IjIwIDYgOSAxNyA0IDEyIj48L3BvbHlsaW5lPjwvc3ZnPg==')] checked:bg-center checked:bg-no-repeat transition-all cursor-pointer focus:ring-0 focus:ring-offset-0" />
                  </div>
                </th>
                <th class="px-4 py-3 font-medium">Name</th>
                <th class="px-4 py-3 font-medium">Size</th>
                <th class="px-4 py-3 font-medium text-right">Modified</th>
                <th class="w-10 px-4 py-3"></th>
              </tr>
            </thead>
            <tbody id="filesTbody" class="divide-y divide-neutral-900">
              
              <% const sortedFiles=files.sort((a,b)=> (a.type === 'folder' && b.type !== 'folder') ? -1 : (a.type !==
                'folder' && b.type === 'folder') ? 1 : 0);
                sortedFiles.forEach((file, index) => {
                const isFolder = file.type === 'folder';
                const isJar = file.name.toLowerCase().endsWith('.jar');
                %>
                <!-- Staggered Row Animation -->
                <tr class="file-row group hover:bg-neutral-900/50 transition-colors animate-fade-in-up"
                  style="animation-delay: <%= Math.min(index * 30, 300) %>ms;" data-name="<%= file.name %>"
                  data-type="<%= file.type %>" data-path="<%= path === '/' ? '' : path + '/' %><%= file.name %>">
                  <td class="px-4 py-3">
                    <div class="flex items-center">
                      <input type="checkbox"
                        class="row-checkbox h-4 w-4 appearance-none rounded border border-neutral-700 bg-neutral-800 text-white checked:bg-white checked:border-white checked:bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwb2x5bGluZSBwb2ludHM9IjIwIDYgOSAxNyA0IDEyIj48L3BvbHlsaW5lPjwvc3ZnPg==')] checked:bg-center checked:bg-no-repeat transition-all cursor-pointer focus:ring-0 focus:ring-offset-0" />
                    </div>
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex items-center gap-3">
                      <% if (isFolder) { %>
                        <svg class="h-5 w-5 text-indigo-400 group-hover:scale-110 transition-transform"
                          viewBox="0 0 20 20" fill="currentColor">
                          <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                        </svg>
                        <% } else { %>
                          <svg class="h-5 w-5 text-neutral-500 group-hover:scale-110 transition-transform"
                            viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                              d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                              clip-rule="evenodd" />
                          </svg>
                          <% } %>
                            <% if (isFolder) { %>
                              <a href="?path=<%= encodeURIComponent((path === '/' ? '' : path + '/') + file.name) %>"
                                class="file-name font-medium text-white hover:underline decoration-neutral-500 underline-offset-4">
                                <%= file.name %>
                              </a>
                              <% } else { %>
                                <% if(isJar) { %>
                                  <span class="file-name text-neutral-400 cursor-not-allowed">
                                    <%= file.name %>
                                  </span>
                                  <% } else { %>
                                    <a href="#"
                                      class="open-editor file-name text-neutral-300 hover:text-white transition-colors"
                                      data-path="<%= (path === '/' ? '' : path + '/') + file.name %>">
                                      <%= file.name %>
                                    </a>
                                    <% } %>
                                      <% } %>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm text-neutral-400 font-mono">
                    <%= formatSize(file.size) %>
                  </td>
                  <td class="px-4 py-3 text-right text-sm text-neutral-500">
                    <%= new Date(file.createdAt).toLocaleDateString() %>
                  </td>
                  <td class="px-4 py-3 text-right relative">
                    <button
                      class="dropdownBtn p-1 text-neutral-500 hover:text-white transition-colors hover:scale-110 active:scale-95">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="h-5 w-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                      </svg>
                    </button>
                    <!-- Dropdown Menu -->
                    <div
                      class="dropdownMenu absolute right-8 top-0 z-50 hidden min-w-[140px] flex-col rounded-xl border border-neutral-800 bg-neutral-900 p-1 shadow-xl transition-all scale-95 opacity-0">
                      <button
                        class="renameBtn w-full rounded-lg px-3 py-1.5 text-left text-sm text-neutral-300 hover:bg-neutral-800 hover:text-white transition-colors"
                        data-type="<%= file.type %>" data-name="<%= file.name %>"
                        data-path="<%= (path === '/' ? '' : path + '/') + file.name %>">
                        Rename
                      </button>
                      <form method="POST"
                        action="/server/files/<%= server.id %>/<%= file.type %>/delete?location=<%= encodeURIComponent((path === '/' ? '' : path + '/') + file.name) %>"
                        onsubmit="return confirm('Delete <%= file.name %>?');">
                        <button type="submit"
                          class="w-full rounded-lg px-3 py-1.5 text-left text-sm text-red-500 hover:bg-red-900/20 hover:text-red-400 transition-colors">
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                <% }) %>

                  <tr id="noResultsRow" class="hidden">
                    <td colspan="5" class="py-12 text-center text-neutral-500 italic">No files match your search.</td>
                  </tr>
            </tbody>
          </table>
        </div>

      </div>
    </main>

    <!-- Floating Action Bar -->
    <div id="actionBar"
      class="fixed bottom-8 left-1/2 z-40 flex -translate-x-1/2 translate-y-20 items-center gap-4 rounded-2xl border border-neutral-800 bg-neutral-900/90 px-6 py-3 shadow-2xl backdrop-blur-md transition-all duration-300 opacity-0 pointer-events-none">
      <div class="flex items-center gap-3 border-r border-neutral-800 pr-4">
        <span id="actionSelectedCount" class="text-sm font-bold text-white">0 selected</span>
        <button id="clearSelectionBtn" class="text-xs text-neutral-400 hover:text-white">Clear</button>
      </div>
      <button id="deleteSelectedBtn"
        class="flex items-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-sm font-bold text-white hover:bg-red-700 transition-colors shadow-lg shadow-red-900/20">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
          class="h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
        </svg>
        Delete Selected
      </button>
    </div>


    <!-- Modals -->

    <!-- Create/Rename Modal -->
    <div id="modalOverlay"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
      <div id="modalPanel"
        class="w-full max-w-md transform rounded-2xl border border-neutral-900 bg-black p-6 shadow-2xl transition-all scale-95 opacity-0">
        <h2 id="modalTitle" class="text-lg font-bold text-white">New File</h2>
        <div class="mt-4 space-y-4">
          <input id="modalInput" type="text" placeholder="Name"
            class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2.5 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all" />
          <textarea id="modalContent"
            class="hidden h-32 w-full rounded-lg border border-neutral-800 bg-neutral-900 p-3 text-sm text-white outline-none focus:border-white"></textarea>
          <div class="flex justify-end gap-3 pt-2">
            <button id="modalCancel"
              class="rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2 text-sm font-bold text-neutral-300 hover:bg-neutral-800">Cancel</button>
            <button id="modalConfirm"
              class="rounded-lg bg-white px-4 py-2 text-sm font-bold text-black hover:bg-neutral-200">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Editor Modal (Fullscreen) -->
    <div id="editorModalOverlay" class="fixed inset-0 z-[60] hidden bg-black/90 backdrop-blur-md transition-opacity">
      <div id="editorModal"
        class="flex h-full w-full flex-col bg-[#1e1e1e] transition-transform scale-95 opacity-0 duration-200">
        <!-- Editor Header -->
        <div class="flex h-12 items-center justify-between border-b border-[#333] bg-[#252526] px-4">
          <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="h-5 w-5 text-neutral-400">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
            <span id="editorFilename" class="text-sm font-medium text-neutral-200">filename.txt</span>
            <span id="editorStatus" class="ml-2 text-xs text-neutral-500">Ready</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="editorModalDownload" class="p-1.5 text-neutral-400 hover:text-white transition-colors"
              title="Download">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-5 w-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M7.5 12L12 16.5m0 0L16.5 12M12 16.5V3" />
              </svg>
            </button>
            <button id="editorModalClose"
              class="rounded-md border border-[#444] bg-[#333] px-3 py-1.5 text-xs font-bold text-neutral-300 hover:bg-[#444] transition-colors">Close</button>
            <button id="editorModalSave"
              class="flex items-center gap-1.5 rounded-md bg-indigo-600 px-4 py-1.5 text-xs font-bold text-white hover:bg-indigo-500 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-3.5 w-3.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0120.25 6v12A2.25 2.25 0 0118 20.25H6A2.25 2.25 0 013.75 18V6A2.25 2.25 0 016 3.75h1.5m9 0h-9" />
              </svg>
              Save (Ctrl+S)
            </button>
          </div>
        </div>
        <!-- Editor Content -->
        <div id="modalEditorContainer" class="flex-1 bg-[#1e1e1e]"></div>
        <!-- Footer -->
        <div class="flex h-6 items-center justify-end bg-[#007acc] px-4 text-xs text-white">
          <span id="editorLanguage">Plain Text</span>
        </div>
      </div>
    </div>

    <!-- Upload Progress Modal -->
    <div id="uploadModal"
      class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-black/80 backdrop-blur-sm">
      <div class="w-full max-w-sm rounded-2xl border border-neutral-900 bg-black p-6 text-center shadow-2xl">
        <h3 class="mb-4 text-lg font-bold text-white">Uploading Files...</h3>
        <div class="h-2 w-full overflow-hidden rounded-full bg-neutral-800">
          <div id="uploadBar" class="h-full w-0 bg-indigo-500 transition-all duration-300"></div>
        </div>
        <p id="uploadStatus" class="mt-4 text-sm text-neutral-400">Preparing...</p>
      </div>
    </div>

    <!-- Delete Progress Modal -->
    <div id="deleteProgressModal"
      class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-black/80 backdrop-blur-sm">
      <div class="w-full max-w-sm rounded-2xl border border-neutral-900 bg-black p-6 shadow-2xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-white">Deleting Files</h3>
          <button id="deleteProgressClose" class="text-xs text-neutral-500 hover:text-white">Close</button>
        </div>
        <p id="deleteProgressCurrent" class="text-sm text-neutral-400 mb-2 truncate">Starting...</p>
        <div class="h-2 w-full overflow-hidden rounded-full bg-neutral-800">
          <div id="deleteProgressBar" class="h-full w-0 bg-red-500 transition-all duration-300"></div>
        </div>
        <div class="mt-2 flex justify-between text-xs text-neutral-500">
          <span id="deleteProgressLabel">0/0</span>
          <button id="deleteProgressCancel" class="text-red-500 hover:underline">Cancel</button>
        </div>
      </div>
    </div>


    <!-- SCRIPTS -->
    <script>
      // Utility
      function escapeHtml(s) { return String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" })[m]); }

      // --- Filter Logic ---
      (function () {
        const searchInput = document.getElementById("searchInput");
        const table = document.getElementById("filesTbody");
        const rows = Array.from(table.querySelectorAll("tr.file-row"));
        const noResults = document.getElementById("noResultsRow");

        searchInput.addEventListener("input", (e) => {
          const query = e.target.value.toLowerCase();
          let hasResults = false;

          rows.forEach(row => {
            const name = row.dataset.name.toLowerCase();
            if (name.includes(query)) {
              row.classList.remove("hidden");
              // Highlight Logic (Simplified)
              const nameEl = row.querySelector(".file-name");
              if (query) {
                const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                nameEl.innerHTML = row.dataset.name.replace(regex, "<mark>$1</mark>");
              } else {
                nameEl.textContent = row.dataset.name;
              }
              hasResults = true;
            } else {
              row.classList.add("hidden");
            }
          });

          if (!hasResults) noResults.classList.remove("hidden");
          else noResults.classList.add("hidden");
        });
      })();

      // --- Selection Logic ---
      const actionBar = document.getElementById("actionBar");
      const checkAll = document.getElementById("selectAllCheckbox");
      const checks = document.querySelectorAll(".row-checkbox");
      const selectedCountLabel = document.getElementById("actionSelectedCount");

      function updateSelection() {
        const selected = document.querySelectorAll(".row-checkbox:checked");
        const count = selected.length;

        selectedCountLabel.textContent = `${count} selected`;

        if (count > 0) {
          actionBar.classList.remove("translate-y-20", "opacity-0", "pointer-events-none");
          actionBar.classList.add("translate-y-0", "opacity-100", "pointer-events-auto");
        } else {
          actionBar.classList.add("translate-y-20", "opacity-0", "pointer-events-none");
          actionBar.classList.remove("translate-y-0", "opacity-100", "pointer-events-auto");
        }
      }

      checkAll.onclick = (e) => {
        checks.forEach(c => {
          if (!c.closest('tr').classList.contains('hidden')) c.checked = e.target.checked;
        });
        updateSelection();
      };

      checks.forEach(c => c.onclick = updateSelection);
      document.getElementById("clearSelectionBtn").onclick = () => {
        checks.forEach(c => c.checked = false);
        checkAll.checked = false;
        updateSelection();
      };

      // --- Dropdowns ---
      document.querySelectorAll(".dropdownBtn").forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          // close others
          document.querySelectorAll(".dropdownMenu").forEach(m => {
            if (m !== btn.nextElementSibling) m.classList.add("hidden", "scale-95", "opacity-0");
          });

          const menu = btn.nextElementSibling;
          if (menu.classList.contains("hidden")) {
            menu.classList.remove("hidden");
            setTimeout(() => menu.classList.remove("scale-95", "opacity-0"), 10);
          } else {
            menu.classList.add("scale-95", "opacity-0");
            setTimeout(() => menu.classList.add("hidden"), 100);
          }
        };
      });
      document.onclick = () => {
        document.querySelectorAll(".dropdownMenu").forEach(m => m.classList.add("hidden", "scale-95", "opacity-0"));
      };

      // --- Modals (Create/Rename) ---
      const modalOverlay = document.getElementById("modalOverlay");
      const modalPanel = document.getElementById("modalPanel");
      const modalTitle = document.getElementById("modalTitle");
      const modalInput = document.getElementById("modalInput");
      const modalContent = document.getElementById("modalContent");
      const modalConfirm = document.getElementById("modalConfirm");
      const modalCancel = document.getElementById("modalCancel");

      let modalAction = null; // 'newFile', 'newFolder', 'rename'
      let renameTarget = null;

      function openModal(action, target = null) {
        modalAction = action;
        renameTarget = target;
        modalInput.value = "";
        modalContent.classList.add("hidden");
        modalContent.value = "";

        if (action === 'newFile') {
          modalTitle.textContent = "New File";
          modalContent.classList.remove("hidden");
        } else if (action === 'newFolder') {
          modalTitle.textContent = "New Folder";
        } else if (action === 'rename') {
          modalTitle.textContent = "Rename Item";
          modalInput.value = target.name;
        }

        modalOverlay.classList.remove("hidden", "flex"); // reset flex
        modalOverlay.classList.add("flex");
        setTimeout(() => {
          modalPanel.classList.remove("scale-95", "opacity-0");
          modalPanel.classList.add("scale-100", "opacity-100");
        }, 10);
        modalInput.focus();
      }

      function closeModal() {
        modalPanel.classList.remove("scale-100", "opacity-100");
        modalPanel.classList.add("scale-95", "opacity-0");
        setTimeout(() => modalOverlay.classList.add("hidden"), 200);
      }

      modalCancel.onclick = closeModal;
      document.getElementById("newFileBtn").onclick = () => openModal('newFile');
      document.getElementById("newFolderBtn").onclick = () => openModal('newFolder');

      document.querySelectorAll(".renameBtn").forEach(btn => {
        btn.onclick = () => openModal('rename', { name: btn.dataset.name, path: btn.dataset.path, type: btn.dataset.type });
      });

      modalConfirm.onclick = () => {
        const name = modalInput.value.trim();
        if (!name) return;

        const form = document.createElement("form");
        form.method = "POST";

        if (modalAction === 'rename') {
          form.action = `/server/files/<%= server.id %>/${renameTarget.type}/rename`;
          form.innerHTML = `<input type="hidden" name="location" value="${renameTarget.path}"><input type="hidden" name="newName" value="${name}">`;
        } else {
          const type = modalAction === 'newFile' ? 'new-file' : 'new-folder';
          form.action = `/server/files/<%= server.id %>/${type}?path=<%= encodeURIComponent(path) %>`;
          form.innerHTML = `<input type="hidden" name="filename" value="${name}">`;
          if (modalAction === 'newFile') form.innerHTML += `<input type="hidden" name="content" value="${modalContent.value}">`;
        }

        document.body.appendChild(form);
        form.submit();
      };

      // --- Monaco Editor --- 
      let monacoLoaded = false;
      let editorInstance = null;
      let currentEditPath = null;

      const editorModal = document.getElementById("editorModal");
      const editorOverlay = document.getElementById("editorModalOverlay");
      const editorStatus = document.getElementById("editorStatus");
      const editorLanguage = document.getElementById("editorLanguage");

      async function loadMonaco() {
        if (monacoLoaded) return;
        return new Promise((resolve) => {
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js';
          script.onload = () => {
            require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' } });
            require(['vs/editor/editor.main'], () => {
              monacoLoaded = true;
              resolve();
            });
          };
          document.body.appendChild(script);
        });
      }
      // Preload
      setTimeout(loadMonaco, 1000);

      document.querySelectorAll(".open-editor").forEach(btn => {
        btn.onclick = async (e) => {
          e.preventDefault();
          const path = btn.dataset.path;
          currentEditPath = path;
          const filename = path.split('/').pop();
          document.getElementById("editorFilename").textContent = filename;

          editorOverlay.classList.remove("hidden");
          editorOverlay.classList.add("flex"); // Ensure flex
          setTimeout(() => {
            editorModal.classList.remove("scale-95", "opacity-0");
            editorModal.classList.add("scale-100", "opacity-100");
          }, 10);

          editorStatus.textContent = "Loading...";
          await loadMonaco();

          const res = await fetch(`/server/files/<%= server.id %>/raw?location=${encodeURIComponent(path)}`);
          const content = await res.text();

          const ext = filename.split('.').pop();
          const langMap = { js: 'javascript', ts: 'typescript', html: 'html', css: 'css', json: 'json', py: 'python', md: 'markdown' };
          const lang = langMap[ext] || 'plaintext';
          editorLanguage.textContent = lang;

          if (editorInstance) {
            const model = monaco.editor.createModel(content, lang);
            editorInstance.setModel(model);
          } else {
            editorInstance = monaco.editor.create(document.getElementById("modalEditorContainer"), {
              value: content,
              language: lang,
              theme: 'vs-dark',
              automaticLayout: true,
              minimap: { enabled: false }
            });
          }
          editorStatus.textContent = "Ready";
        };
      });

      document.getElementById("editorModalClose").onclick = () => {
        editorModal.classList.remove("scale-100", "opacity-100");
        editorModal.classList.add("scale-95", "opacity-0");
        setTimeout(() => editorOverlay.classList.add("hidden"), 200);
      };

      document.getElementById("editorModalSave").onclick = async () => {
        if (!editorInstance) return;

        const saveBtn = document.getElementById("editorModalSave");
        const originalContent = saveBtn.innerHTML;
        const originalClasses = saveBtn.className; // Keep original styling

        // Saving State
        editorStatus.textContent = "Saving...";
        saveBtn.disabled = true;
        saveBtn.innerHTML = `<svg class="animate-spin h-3.5 w-3.5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg> Saving...`;

        const content = editorInstance.getValue();
        const filename = currentEditPath.split('/').pop();
        const dir = currentEditPath.split('/').slice(0, -1).join('/');

        try {
          await fetch(`/server/files/<%= server.id %>/new-file?path=${dir || '/'}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, content })
          });

          // Success State
          editorStatus.textContent = "Saved";
          saveBtn.className = "flex items-center gap-1.5 rounded-md bg-emerald-600 px-4 py-1.5 text-xs font-bold text-white transition-all shadow-lg shadow-emerald-900/20";
          saveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-3.5 w-3.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg> Saved!`;

          // Revert after delay
          setTimeout(() => {
            editorStatus.textContent = "Ready";
            saveBtn.className = originalClasses;
            saveBtn.innerHTML = originalContent;
            saveBtn.disabled = false;
          }, 2000);

        } catch (e) {
          console.error(e);
          alert("Save failed");
          editorStatus.textContent = "Error";
          // Revert immediately on error so user can retry
          saveBtn.className = originalClasses;
          saveBtn.innerHTML = originalContent;
          saveBtn.disabled = false;
        }
      };

      // --- Upload & Delete Queues (Simplified for UX, keeping logic minimal) ---
      const uploadInput = document.getElementById("uploadFileInput");
      uploadInput.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;

        document.getElementById("uploadModal").classList.remove("hidden");
        document.getElementById("uploadModal").classList.add("flex");
        const bar = document.getElementById("uploadBar");

        for (let i = 0; i < files.length; i++) {
          document.getElementById("uploadStatus").textContent = `Uploading ${files[i].name} (${i + 1}/${files.length})...`;
          const formData = new FormData();
          formData.append("file", files[i]);

          await fetch(`/server/files/<%= server.id %>/upload?path=<%= encodeURIComponent(path) %>`, {
            method: "POST",
            body: formData
          });
          bar.style.width = `${((i + 1) / files.length) * 100}%`;
        }
        location.reload();
      };
      document.getElementById("uploadFileBtn").onclick = () => uploadInput.click();

      let cancelDelete = false;

      const closeDeleteModal = () => {
        const modal = document.getElementById("deleteProgressModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      };
      document.getElementById("deleteProgressClose").onclick = () => {
        cancelDelete = true;
        closeDeleteModal();
      };

      document.getElementById("deleteProgressCancel").onclick = () => {
        cancelDelete = true;
      };

      document.getElementById("deleteSelectedBtn").onclick = async () => {
        const selected = Array.from(document.querySelectorAll(".row-checkbox:checked"))
          .map(cb => ({
            path: cb.closest('tr').dataset.path,
            type: cb.closest('tr').dataset.type
          }));

        if (!selected.length) return;
        if (!confirm(`Delete ${selected.length} items?`)) return;

        cancelDelete = false;

        const modal = document.getElementById("deleteProgressModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");

        const bar = document.getElementById("deleteProgressBar");
        const current = document.getElementById("deleteProgressCurrent");
        const label = document.getElementById("deleteProgressLabel");

        for (let i = 0; i < selected.length; i++) {
          if (cancelDelete) break;

          current.textContent = selected[i].path;
          label.textContent = `${i + 1}/${selected.length}`;
          bar.style.width = `${((i + 1) / selected.length) * 100}%`;

          await fetch(
            `/server/files/<%= server.id %>/${selected[i].type}/delete?location=${encodeURIComponent(selected[i].path)}`,
            { method: "POST" }
          );
        }

        closeDeleteModal();

        if (!cancelDelete) {
          location.reload();
        }
      };


    </script>
</body>

</html>