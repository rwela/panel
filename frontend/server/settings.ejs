<!DOCTYPE html>
<html lang="en" class="h-full bg-black text-white font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= name %> - <%= server.name %> Settings
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #000;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    .tab-btn[data-state="active"] {
      @apply bg-white text-black;
    }

    .tab-btn[data-state="inactive"] {
      @apply text-neutral-400 hover:text-white hover:bg-neutral-900;
    }
  </style>
</head>

<body class="flex h-full w-full overflow-hidden">

  <%- include('../components/sidebar', { name: name, user: user }) %>

    <main class="relative flex-1 overflow-y-auto bg-black">
      <div class="mx-auto max-w-5xl px-6 py-12 md:px-12">

        <!-- Header -->
        <div class="mb-12">
          <h1 class="text-3xl font-bold tracking-tight text-white md:text-4xl">Server Configuration</h1>
          <p class="mt-2 text-neutral-400">Manage environment variables, subusers, and advanced settings.</p>
        </div>

        <!-- Notifications -->
        <% if (req.query.rs==='true' ) { %>
          <div
            class="mb-6 flex items-center gap-3 rounded-xl border border-emerald-900/50 bg-emerald-950/20 px-4 py-3 text-sm text-emerald-200">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="h-5 w-5 text-emerald-500">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Reinstallation initiated successfully.
          </div>
          <% } else if (req.query.rs==='false' ) { %>
            <div
              class="mb-6 flex items-center gap-3 rounded-xl border border-red-900/50 bg-red-950/20 px-4 py-3 text-sm text-red-200">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-5 w-5 text-red-500">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
              </svg>
              Reinstallation failed.
            </div>
            <% } %>

              <% if (req.query.env==='saved' ) { %>
                <div
                  class="mb-6 flex items-center gap-3 rounded-xl border border-indigo-900/50 bg-indigo-950/20 px-4 py-3 text-sm text-indigo-200">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="h-5 w-5 text-indigo-500">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Variables saved successfully.
                </div>
                <% } %>

                  <!-- Tabs Navigation -->
                  <div class="mb-8 flex flex-wrap gap-2 border-b border-neutral-900 pb-2">
                    <button class="tab-btn rounded-lg px-4 py-2 text-sm font-bold transition-all" data-target="general"
                      data-state="active">General</button>
                    <button class="tab-btn rounded-lg px-4 py-2 text-sm font-bold transition-all" data-target="subusers"
                      data-state="inactive">Subusers</button>
                    <button class="tab-btn rounded-lg px-4 py-2 text-sm font-bold transition-all" data-target="ftp"
                      data-state="inactive">FTP</button>
                    <button
                      class="tab-btn rounded-lg px-4 py-2 text-sm font-bold text-red-500 hover:bg-red-900/10 transition-all"
                      data-target="danger" data-state="inactive">Danger Zone</button>
                  </div>

                  <!-- Tab Content Area -->
                  <div class="space-y-8">

                    <!-- GENERAL -->
                    <div id="tab-general" class="tab-pane space-y-8">

                      <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                        <!-- Rename -->
                        <div class="rounded-2xl border border-neutral-900 bg-neutral-950 p-6">
                          <h2 class="mb-4 text-lg font-bold text-white">Rename Server</h2>
                          <form action="/server/settings/<%= server.id %>/rename" method="POST" class="flex gap-3">
                            <input type="text" name="newName" placeholder="<%= server.name %>"
                              class="flex-1 rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2.5 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all"
                              required />
                            <button type="submit"
                              class="rounded-lg bg-white px-4 py-2.5 text-sm font-bold text-black transition-transform active:scale-95 hover:bg-neutral-200">Rename</button>
                          </form>
                        </div>

                        <!-- Metadata -->
                        <div class="rounded-2xl border border-neutral-900 bg-neutral-950 p-6">
                          <h2 class="mb-4 text-lg font-bold text-white">Metadata</h2>
                          <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                              <span class="text-neutral-500">Node</span>
                              <span class="font-mono text-white">
                                <%= server.node.name %>
                              </span>
                            </div>
                            <div class="flex justify-between">
                              <span class="text-neutral-500">Container ID</span>
                              <span class="font-mono text-white">
                                <%= server.idt %>
                              </span>
                            </div>
                            <div class="flex justify-between">
                              <span class="text-neutral-500">Internal UUID</span>
                              <span class="font-mono text-white truncate max-w-[150px]">
                                <%= server.id %>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>

              

                    </div>

                    <!-- SUBUSERS -->
                    <div id="tab-subusers" class="tab-pane hidden space-y-6">
                      <div class="rounded-2xl border border-neutral-900 bg-neutral-950 p-6">
                        <div class="mb-6 flex items-center justify-between">
                          <div>
                            <h2 class="text-lg font-bold text-white">Manage Access</h2>
                            <p class="text-sm text-neutral-500">Allow other users to access this server.</p>
                          </div>

                          <% if (user && (user.id===server.ownerId || user.admin)) { %>
                            <form method="POST" action="/server/settings/<%= server.id %>/subuser/add"
                              class="flex items-center gap-2">
                              <input type="email" name="email" placeholder="User Email"
                                class="w-64 rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2 text-sm text-white outline-none focus:border-white transition-all"
                                required />
                              <button type="submit"
                                class="rounded-lg bg-white px-4 py-2 text-sm font-bold text-black hover:bg-neutral-200">Add
                                User</button>
                            </form>
                            <% } %>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                          <% if (server.subusers && server.subusers.length> 0) { %>
                            <% server.subusers.forEach(sub=> { %>
                              <div
                                class="flex items-center justify-between rounded-xl border border-neutral-900 bg-neutral-900/30 p-4 transition-colors hover:border-neutral-800">
                                <div class="flex items-center gap-4">
                                  <div
                                    class="flex h-10 w-10 items-center justify-center rounded-lg bg-neutral-800 text-sm font-bold text-neutral-400">
                                    <%= sub.email.substring(0,2).toUpperCase() %>
                                  </div>
                                  <div>
                                    <p class="font-bold text-white">
                                      <%= sub.email %>
                                    </p>
                                    <% if (sub.id===server.ownerId) { %>
                                      <p class="text-xs text-neutral-500">Owner - Full Access</p>
                                      <% } else { %>
                                        <p class="text-xs text-neutral-500">Subuser</p>
                                        <% } %>
                                  </div>
                                </div>
                                <% if (sub.id !==server.ownerId && (user.id===server.ownerId || user.admin)) { %>
                                  <form method="POST" action="/server/settings/<%= server.id %>/subuser/remove">
                                    <input type="hidden" name="subuserId" value="<%= sub.id %>" />
                                    <button
                                      class="rounded-lg border border-red-900/30 bg-red-900/10 px-3 py-1.5 text-xs font-bold text-red-500 hover:bg-red-900/20 transition-colors">Revoke</button>
                                  </form>
                                  <% } else if (sub.id===server.ownerId) { %>
                                    <span
                                      class="rounded-lg bg-amber-900/20 px-3 py-1.5 text-xs font-bold text-amber-500 border border-amber-900/50">Owner</span>
                                    <% } %>
                              </div>
                              <% }) %>
                                <% } else { %>
                                  <div
                                    class="rounded-xl border border-dashed border-neutral-800 bg-neutral-900/30 p-8 text-center text-neutral-500">
                                    No subusers have been added.
                                  </div>
                                  <% } %>
                        </div>
                      </div>
                    </div>
                    <!-- FTP -->
                    <div id="tab-ftp" class="tab-pane hidden space-y-6">
                      <div class="rounded-2xl border border-neutral-900 bg-neutral-950 p-6">
                        <h2 class="mb-4 text-lg font-bold text-white">FTP Access</h2>
                        <p class="mb-6 text-sm text-neutral-500">Use the credentials below to access your server via
                          FTP.</p>

                        <div class="space-y-4">
                          <!-- Host -->
                          <div class="flex justify-between items-center">
                            <div>
                              <div class="text-sm text-neutral-500">FTP Host</div>
                              <div class="font-mono text-white select-all" id="ftp-host">ftp://<%= server.node.ip %>:<%= server.ftp.port || 3001 %>
                              </div>
                            </div>
                          </div>

                          <!-- Username -->
                          <div class="flex justify-between items-center">
                            <div>
                              <div class="text-sm text-neutral-500">FTP Username</div>
                              <div class="font-mono text-white select-all" id="ftp-user">
                                <%= server.ftp.username %>
                              </div>
                            </div>
                          </div>

                          <!-- Password -->
                          <div class="flex justify-between items-center">
                            <div class="flex-1 min-w-0">
                              <div class="text-sm text-neutral-500">FTP Password</div>
                              <div class="flex items-center gap-3">
                                <input id="ftp-pass" type="password" readonly
                                  class="font-mono text-white bg-transparent border border-neutral-800 rounded px-3 py-2 text-sm w-64 truncate"
                                  value="<%= server.ftp.password %>" aria-label="FTP password" />
                                <button id="toggle-pass" type="button"
                                  class="rounded px-2 py-1 text-xs bg-neutral-900 border border-neutral-800 hover:bg-neutral-800"
                                  aria-label="Show password">Show</button>
                              </div>
                            </div>

                            <!-- Connect button -->
                            <div>
                              <button id="ftp-connect"
                                class="inline-block rounded px-4 py-2 text-sm font-semibold bg-white text-black hover:bg-neutral-200">
                                Connect
                              </button>
                            </div>
                          </div>
                        </div>

                        <!-- Tooltip / fallback -->
                        <div id="ftp-tooltip" class="mt-3 text-sm text-neutral-400 hidden break-words font-mono">
                          Copy this command if your browser can't open FTP:
                        </div>
                      </div>
                    </div>

                    <script>
                      (function () {
                        const passInput = document.getElementById("ftp-pass");
                        const toggleBtn = document.getElementById("toggle-pass");
                        const connectBtn = document.getElementById("ftp-connect");
                        const tooltip = document.getElementById("ftp-tooltip");

                        const host = "<%= server.node.ip %>";
                        const port = "<%= server.ftp.port || 3001 %>";
                        const user = "<%= server.ftp.username %>";
                        const pass = "<%= server.ftp.password %>";

                        toggleBtn.addEventListener("click", function () {
                          const isMasked = passInput.type !== "text";
                          passInput.type = isMasked ? "text" : "password";
                          this.textContent = isMasked ? "Hide" : "Show";
                        });

                        connectBtn.addEventListener("click", function () {
                          const ftpUrl = `ftp://${user}:${pass}@${host}:${port}`;
                          let newWindow;
                          try {
                            newWindow = window.open(ftpUrl, "_blank");
                          } catch { }
                          // if browser can't open FTP, show fallback command
                          if (!newWindow || newWindow.closed || typeof newWindow.closed === "undefined") {
                            tooltip.innerHTML = `
          <strong>Browser cannot open FTP directly.</strong><br>
          Use this in your terminal:<br>
          <code>ftp -p -n ${host} ${port}</code><br>
          Username: <code>${user}</code> | Password: <code>${pass}</code>
        `;
                            tooltip.classList.remove("hidden");
                          }
                        });
                      })();
                    </script>


                    <!-- DANGER -->
                    <div id="tab-danger" class="tab-pane hidden space-y-6">
                      <div class="rounded-2xl border border-red-900/30 bg-red-950/10 p-6">
                        <h2 class="text-lg font-bold text-red-500">Danger Zone</h2>
                        <p class="mb-6 text-sm text-red-200/70">These actions are destructive and cannot be undone.</p>

                        <div
                          class="flex items-center justify-between rounded-xl border border-red-900/30 bg-red-950/20 p-4">
                          <div>
                            <h3 class="font-bold text-white">Reinstall Server</h3>
                            <p class="text-sm text-neutral-400">Wipe configuration and re-run installation scripts.</p>
                          </div>
                          <button onclick="openReinstallModal()"
                            class="rounded-lg bg-red-600 px-4 py-2 text-sm font-bold text-white hover:bg-red-700 transition-colors">
                            Reinstall
                          </button>
                        </div>
                      </div>
                    </div>

                  </div>

      </div>
    </main>

    <!-- Reinstall Modal -->
    <div id="reinstall-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
      <div id="reinstall-panel"
        class="w-full max-w-md transform rounded-2xl border border-neutral-900 bg-black p-6 shadow-2xl transition-all scale-95 opacity-0">
        <h2 class="text-lg font-bold text-white">Confirm Reinstall</h2>
        <p class="mt-2 text-sm text-neutral-400">
          Are you sure you want to reinstall this server? This will stop the server and may overwrite configuration
          files. Data loss is possible.
        </p>
        <div class="mt-6 flex justify-end gap-3">
          <button onclick="closeReinstallModal()"
            class="rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2 text-sm font-bold text-neutral-300 hover:bg-neutral-800">Cancel</button>
          <form action="/server/settings/reinstall/<%= server.id %>" method="POST">
            <button type="submit"
              class="rounded-lg bg-red-600 px-4 py-2 text-sm font-bold text-white hover:bg-red-700">Yes,
              Reinstall</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Tab Logic
      const tabs = document.querySelectorAll('.tab-btn');
      const panes = document.querySelectorAll('.tab-pane');

      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.disabled) return;
          const target = btn.dataset.target;

          // Update Buttons
          tabs.forEach(b => b.setAttribute('data-state', 'inactive'));
          btn.setAttribute('data-state', 'active');

          // Update Panes
          panes.forEach(p => {
            if (p.id === `tab-${target}`) {
              p.classList.remove('hidden');
              // slight fade in
              p.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 200, fill: 'forwards' });
            } else {
              p.classList.add('hidden');
            }
          });
        });
      });

      // Reinstall Modal
      const rModal = document.getElementById("reinstall-modal");
      const rPanel = document.getElementById("reinstall-panel");

      function openReinstallModal() {
        rModal.classList.remove("hidden");
        rModal.classList.add("flex");
        void rModal.offsetWidth;
        rPanel.classList.remove("scale-95", "opacity-0");
        rPanel.classList.add("scale-100", "opacity-100");
      }

      function closeReinstallModal() {
        rPanel.classList.remove("scale-100", "opacity-100");
        rPanel.classList.add("scale-95", "opacity-0");
        setTimeout(() => {
          rModal.classList.add("hidden");
          rModal.classList.remove("flex");
        }, 200);
      }
    </script>

</body>

</html>