<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-space-grotesk">

<head>
    <meta charset="UTF-8" />
    <title>
        <%= name %> - API Keys
    </title>
    <link rel="stylesheet" href="/assets/tailwind.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="min-h-screen flex">
    <%- include('../../components/sidebar', { name, user }) %>

        <main class="flex-1 p-8 overflow-auto">
            <div class="max-w-6xl mx-auto space-y-6">
                <!-- Header -->
                <div class="bg-neutral-950 border border-neutral-900 p-6 rounded-md flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold flex items-center gap-2">
                            <i data-lucide="key" class="w-6 h-6"></i> API Keys
                        </h1>
                        <p class="text-gray-400">Manage all deployment and user API keys</p>
                    </div>
                    <button id="createApiKeyBtn" 
                        class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-xl font-medium">
                        + Create API Key
                    </button>
                </div>


            <!-- API Keys Table -->
            <div class="bg-neutral-900/20 border border-neutral-900 rounded-md overflow-auto">
                <table class="min-w-full divide-y divide-neutral-800">
                    <thead class="bg-neutral-950">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-100">Name</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-100">Preview</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-100">Permissions</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-100">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-neutral-800 bg-neutral-950">
                      <% if (apikeys && apikeys.length > 0) { %>
                        <% apikeys.forEach(key => { %>
                          <tr class="hover:bg-neutral-900/50 transition-colors">
                            <td class="px-4 py-3">
                              <div class="flex items-center gap-3">
                                <i data-lucide="key" class="w-5 h-5 text-gray-100"></i>
                                <div>
                                  <div class="font-semibold text-gray-100"><%= key.name || 'Unnamed' %></div>
                                  <div class="text-xs text-neutral-400"><%= key.createdAt ? new Date(key.createdAt).toLocaleString() : '' %></div>
                                </div>
                              </div>
                            </td>

                            <td class="px-4 py-3">
                              <span class="ml-2 px-2 py-0.5 text-xs font-semibold text-gray-100 bg-neutral-800 rounded-full">
                                <%= key.preview %>
                              </span>
                            </td>

                            <td class="px-4 py-3">
                              <div class="flex flex-wrap gap-2">
                                <% Object.keys(key.perms || {}).forEach(perm => { %>
                                  <% if (key.perms[perm]) { %>
                                    <span class="px-2 py-0.5 text-xs font-semibold bg-green-600 rounded-full"><%= perm %></span>
                                  <% } %>
                                <% }) %>
                              </div>
                            </td>

                            <td class="px-4 py-3 text-right">
                              <div class="inline-flex gap-2 items-center">
                                <button data-action="edit" data-id="<%= key.id %>"
                                  class="px-3 py-1 text-xs font-semibold rounded-lg bg-blue-600 hover:bg-blue-700">
                                  Edit
                                </button>
                                <button data-action="delete" data-id="<%= key.id %>"
                                  class="px-3 py-1 text-xs font-semibold rounded-lg bg-red-600 hover:bg-red-700">
                                  Delete
                                </button>
                              </div>
                            </td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="4" class="px-4 py-6 text-neutral-500 italic text-center">No API keys found.</td>
                        </tr>
                      <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Editor-style Create/Edit Modal (unchanged except IDs remain) -->
    <div id="apiKeyModalOverlay"
        class="fixed inset-0 bg-black bg-neutral-950/50 backdrop-blur-sm hidden flex items-center justify-center z-60">
        <div id="apiKeyModal" role="dialog" aria-modal="true" aria-labelledby="apiKeyModalTitle"
            class="relative z-10 w-[95%] max-w-3xl mx-4 rounded-md bg-neutral-950 border border-neutral-900 text-neutral-100 shadow-xl ring-1 ring-black/10 overflow-hidden transform transition-all duration-200 ease-out scale-95 opacity-0">

            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-3 border-b border-neutral-800">
                <div class="flex items-center gap-3">
                    <h3 id="apiKeyModalTitle" class="text-lg font-semibold">Create API Key</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button id="apiKeyModalClose"
                        class="px-3 py-1.5 rounded-md text-sm hover:bg-neutral-800">Close</button>
                    <button id="apiKeyModalSave"
                        class="px-4 py-1.5 rounded-lg text-sm bg-indigo-600 hover:bg-indigo-700 text-white flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Save
                    </button>
                </div>
            </div>

            <!-- Content (form) -->
            <form id="apiKeyForm" class="px-4 py-4 grid gap-4">
                <input type="hidden" name="id" id="keyId" />
                <div>
                    <label class="block mb-1 text-gray-400 text-sm">Name</label>
                    <input type="text" name="name" id="keyName"
                        class="w-full px-3 py-2 rounded-lg bg-neutral-800 text-gray-100 focus:outline-none"
                        placeholder="API Key Name">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <% const perms=['nodes','servers','users','settings','images']; %>
                        <% perms.forEach(perm=> { %>
                            <label class="flex items-center gap-2 text-gray-400">
                                <input type="checkbox" name="<%= perm %>" id="perm_<%= perm %>"
                                    class="accent-indigo-600" />
                                <%= perm.charAt(0).toUpperCase() + perm.slice(1) %>
                            </label>
                            <% }) %>
                </div>
            </form>

            <!-- Footer -->
            <div
                class="px-4 py-2 border-t border-neutral-800 flex items-center justify-between text-sm text-neutral-400">
                <div id="apiKeyStatus">Ready</div>
            </div>
        </div>
    </div>

    <!-- Token Reveal Modal (unchanged) -->
    <div id="tokenModalOverlay"
        class="fixed inset-0 bg-black bg-neutral-950/60 backdrop-blur-sm hidden flex items-center justify-center z-70">
        <div id="tokenModal"
            class="relative z-20 w-[95%] max-w-xl mx-4 rounded-md bg-neutral-950 border border-neutral-900 text-neutral-100 shadow-xl ring-1 ring-black/10 overflow-hidden transform transition-all duration-200 ease-out scale-95 opacity-0">
            <div class="px-4 py-3 border-b border-neutral-800 flex items-start justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold">API Key Created</h3>
                    <p class="text-sm text-neutral-400 mt-1">Copy this token now â€” it will not be shown again.</p>
                </div>
                <button id="tokenModalClose"
                    class="px-3 py-1.5 rounded-md text-sm hover:bg-neutral-800">Close</button>
            </div>

            <div class="p-4 space-y-3">
                <div class="bg-neutral-950 border border-neutral-800 rounded-md p-3">
                    <label class="text-xs text-neutral-400">Token</label>
                    <div class="mt-2 flex gap-2 items-center">
                        <input id="revealedToken" readonly
                            class="flex-1 bg-transparent border border-neutral-800 px-3 py-2 rounded-md text-sm text-gray-100" />
                        <button id="copyTokenBtn"
                            class="px-3 py-2 rounded-md text-sm bg-indigo-600 hover:bg-indigo-700">Copy</button>
                    </div>
                </div>

                <div class="rounded-md p-3 border border-red-700 bg-red-900/30 text-sm text-red-200">
                    <strong class="block">Important:</strong>
                    <p class="mt-1">This token will <u>not</u> be displayed again. If you lose it you must delete the key
                        and create a new one.</p>
                </div>

                <div class="flex justify-end gap-2">
                    <button id="ackCopiedBtn" class="px-4 py-2 rounded-lg bg-neutral-800 hover:bg-neutral-700">I
                        copied it</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize lucide icons after DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // --- elements ---
            const overlay = document.getElementById('apiKeyModalOverlay');
            const modal = document.getElementById('apiKeyModal');
            const closeBtn = document.getElementById('apiKeyModalClose');
            const saveBtn = document.getElementById('apiKeyModalSave');
            const modalTitle = document.getElementById('apiKeyModalTitle');
            const keyIdInput = document.getElementById('keyId');
            const keyNameInput = document.getElementById('keyName');
            const apiKeyForm = document.getElementById('apiKeyForm');
            const statusEl = document.getElementById('apiKeyStatus');

            const tokenOverlay = document.getElementById('tokenModalOverlay');
            const tokenModal = document.getElementById('tokenModal');
            const revealedTokenInput = document.getElementById('revealedToken');
            const copyTokenBtn = document.getElementById('copyTokenBtn');
            const tokenCloseBtn = document.getElementById('tokenModalClose');
            const ackCopiedBtn = document.getElementById('ackCopiedBtn');

            const createBtn = document.getElementById('createApiKeyBtn');

            const PERMS = ['nodes', 'servers', 'users', 'settings', 'images'];

            // Utility: show/hide editor modal
            function openEditorModal() {
                overlay.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0', 'scale-95'), 10);
            }
            function closeEditorModal() {
                modal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => overlay.classList.add('hidden'), 200);
            }

            // Utility: show/hide token modal
            function openTokenModal() {
                tokenOverlay.classList.remove('hidden');
                setTimeout(() => tokenModal.classList.remove('opacity-0', 'scale-95'), 10);
            }
            function closeTokenModal() {
                tokenModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => tokenOverlay.classList.add('hidden'), 200);
            }

            // Create mode
            function showCreateModal() {
                modalTitle.textContent = 'Create API Key';
                keyIdInput.value = '';
                keyNameInput.value = '';
                PERMS.forEach(p => document.getElementById(`perm_${p}`).checked = false);
                statusEl.textContent = 'Ready';
                openEditorModal();
            }

            // Edit mode: populate fields
            function showEditModal(id) {
                const apikeysData = <%- JSON.stringify(apikeys) %>;
                const key = apikeysData.find(k => k.id === id);
                if (!key) return alert('Key not found');

                modalTitle.textContent = 'Edit API Key';
                keyIdInput.value = key.id;
                keyNameInput.value = key.name || '';
                const permsObj = key.perms || {};
                PERMS.forEach(p => {
                    document.getElementById(`perm_${p}`).checked = !!permsObj[p];
                });
                statusEl.textContent = 'Ready';
                openEditorModal();
            }

            // Close handlers
            closeBtn.addEventListener('click', closeEditorModal);
            overlay.addEventListener('click', e => { if (e.target === overlay) closeEditorModal(); });

            tokenCloseBtn.addEventListener('click', () => {
                if (!revealedTokenInput.value) { closeTokenModal(); return; }
                if (!tokenWasCopied) {
                    if (!confirm('You have not copied the token. It will not be shown again. Close anyway?')) return;
                }
                closeTokenModal();
            });

            tokenOverlay.addEventListener('click', e => {
                if (e.target === tokenOverlay) tokenCloseBtn.click();
            });

            // Copy support with fallback
            let tokenWasCopied = false;
            async function copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    tokenWasCopied = true;
                    return true;
                } catch (err) {
                    // fallback
                    try {
                        revealedTokenInput.select();
                        document.execCommand('copy');
                        tokenWasCopied = true;
                        return true;
                    } catch (e) {
                        console.error('Copy failed', e);
                        return false;
                    }
                }
            }

            copyTokenBtn.addEventListener('click', async () => {
                const text = revealedTokenInput.value || '';
                if (!text) return;
                const ok = await copyToClipboard(text);
                if (ok) {
                    copyTokenBtn.textContent = 'Copied';
                    copyTokenBtn.classList.add('opacity-80');
                    setTimeout(() => copyTokenBtn.textContent = 'Copy', 1500);
                } else {
                    alert('Copy failed. Please select and copy manually.');
                }
            });

            ackCopiedBtn.addEventListener('click', () => {
                if (!tokenWasCopied) {
                    if (!confirm('Are you sure you copied the token? If you close it will NOT be shown again.')) return;
                }
                closeTokenModal();
                location.reload();
            });

            // Form submit (create/edit)
            apiKeyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                // trigger save button's handler
                saveBtn.click();
            });

            // Save button handler (supports create and edit)
            saveBtn.addEventListener('click', async () => {
                const id = keyIdInput.value;
                const payload = {
                    name: keyNameInput.value.trim()
                };
                PERMS.forEach(p => payload[p] = document.getElementById(`perm_${p}`).checked);
                if (id) payload.id = id;

                statusEl.textContent = 'Saving...';
                saveBtn.disabled = true;

                try {
                    const url = id ? '/admin/apikeys/edit' : '/admin/apikeys/new';
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const txt = await res.text().catch(() => null);
                        throw new Error(txt || 'Save failed');
                    }

                    const data = await res.json();

                    // If created, backend returns token -> show reveal modal
                    if (!id && data && data.token) {
                        // show token reveal modal with warning
                        revealedTokenInput.value = data.token;
                        tokenWasCopied = false;
                        closeEditorModal();
                        openTokenModal();
                    } else {
                        // edit or without token -> reload to reflect changes
                        location.reload();
                    }
                } catch (err) {
                    console.error(err);
                    alert('Failed to save API key: ' + (err.message || 'unknown'));
                    statusEl.textContent = 'Error';
                } finally {
                    saveBtn.disabled = false;
                }
            });

            // Delete API key (uses query param style)
            async function deleteApiKey(id) {
                if (!confirm('Are you sure you want to delete this API key?')) return;
                try {
                    const res = await fetch(`/admin/apikeys/delete?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Delete failed');
                    location.reload();
                } catch (err) {
                    alert('Failed to delete API key');
                    console.error(err);
                }
            }

            // expose to window just in case other scripts call it
            window.deleteApiKey = deleteApiKey;
            window.showEditModal = showEditModal;

            // Event delegation for edit/delete and create button
            document.addEventListener('click', (e) => {
                const del = e.target.closest('[data-action="delete"]');
                if (del) {
                    const id = del.dataset.id;
                    deleteApiKey(id);
                    return;
                }
                const edt = e.target.closest('[data-action="edit"]');
                if (edt) {
                    showEditModal(edt.dataset.id);
                    return;
                }
            });

            // wire create button
            createBtn.addEventListener('click', showCreateModal);
        });
    </script>

</body>
</html>