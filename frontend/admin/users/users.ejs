<!DOCTYPE html>
<html lang="en" class="h-full bg-black text-white font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= name %> - Users
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #000;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }
  </style>
</head>

<body class="flex h-full w-full overflow-hidden">

  <%- include('../../components/sidebar', { name, user }) %>

    <main class="relative flex-1 overflow-y-auto bg-black">
      <div class="mx-auto max-w-7xl px-6 py-12 md:px-12 animate-fade-in-up">

        <!-- Header -->
        <div class="mb-12 flex flex-col justify-between gap-6 md:flex-row md:items-end">
          <div>
            <h1 class="text-3xl font-bold tracking-tight text-white md:text-4xl">Users</h1>
            <p class="mt-2 text-neutral-400">Manage registered users and permissions.</p>
          </div>
          <div class="flex items-center gap-4">
            <!-- Search Input -->
            <div class="relative group">
              <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor"
                  class="h-5 w-5 text-neutral-500 group-focus-within:text-white transition-colors">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
              </div>
              <input type="text" id="searchInput" placeholder="Search users..."
                class="block w-full rounded-xl border border-neutral-800 bg-neutral-900/50 py-2.5 pl-11 pr-4 text-sm text-white placeholder-neutral-500 outline-none ring-0 transition-all focus:border-neutral-700 focus:bg-neutral-900 focus:ring-1 focus:ring-neutral-700 md:w-64" />
            </div>

            <button onclick="openCreateModal()"
              class="flex items-center gap-2 rounded-xl bg-white px-5 py-2.5 text-sm font-bold text-black transition-transform active:scale-95 hover:bg-neutral-200 hover:scale-105">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-5 w-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM3.75 19.5a6.96 6.96 0 006.138-3.963 12.022 12.022 0 00.524 6.487 7.06 7.06 0 01-6.662-2.525z" />
              </svg>
              Create User
            </button>
          </div>
        </div>

        <!-- Users Table -->
        <div class="overflow-hidden rounded-2xl border border-neutral-900 bg-neutral-950 shadow-2xl">
          <table class="w-full text-left text-sm">
            <thead class="border-b border-neutral-900 bg-neutral-900/50 text-neutral-400">
              <tr>
                <th class="px-6 py-4 font-medium">User</th>
                <th class="px-6 py-4 font-medium">Role</th>
                <th class="px-6 py-4 font-medium">Servers</th>
                <th class="px-6 py-4 text-right font-medium">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-900" id="usersTableBody">
              <% if (users && users.length> 0) { %>
                <% users.forEach((u, index)=> { %>
                  <tr class="group hover:bg-neutral-900/40 transition-colors user-row animate-fade-in-up"
                    style="animation-delay: <%= Math.min(index * 50, 500) %>ms;"
                    data-username="<%= u.username.toLowerCase() %>" data-email="<%= u.email.toLowerCase() %>">
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-4">
                        <img
                          src="https://api.dicebear.com/9.x/notionists-neutral/svg?seed=<%= u.username %>&backgroundColor=transparent"
                          alt="Avatar"
                          class="h-10 w-10 rounded-lg bg-neutral-900 object-cover p-1 transition-transform group-hover:scale-110">
                        <div>
                          <div class="font-bold text-white">
                            <%= u.username %>
                          </div>
                          <div class="text-xs text-neutral-500">
                            <%= u.email %>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <% if (u.admin) { %>
                        <span
                          class="inline-flex items-center gap-1.5 rounded-full bg-indigo-500/10 px-2.5 py-1 text-xs font-bold text-indigo-400 border border-indigo-500/20">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                            class="w-3 h-3">
                            <path fill-rule="evenodd"
                              d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z"
                              clip-rule="evenodd" />
                          </svg>
                          Admin
                        </span>
                        <% } else { %>
                          <span
                            class="inline-flex items-center rounded-full bg-neutral-800 px-2.5 py-1 text-xs font-medium text-neutral-400 border border-neutral-700">
                            User
                          </span>
                          <% } %>
                    </td>
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-2 text-neutral-400">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="h-5 w-5 text-neutral-500">
                          <rect width="20" height="8" x="2" y="2" rx="2" ry="2" />
                          <rect width="20" height="8" x="2" y="14" rx="2" ry="2" />
                          <line x1="6" x2="6.01" y1="6" y2="6" />
                          <line x1="6" x2="6.01" y1="18" y2="18" />
                        </svg>
                        <span class="font-mono text-white">
                          <%= u.servers?.length || 0 %>
                        </span>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="flex items-center justify-end gap-2">
                        <a href="/admin/user/<%= u.id %>"
                          class="group/btn relative flex items-center justify-center rounded-lg bg-neutral-900 border border-neutral-800 p-2 text-neutral-400 hover:bg-white hover:text-black transition-all hover:scale-110 active:scale-95"
                          title="View Profile">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                            <path d="M2 21a8 8 0 0 1 13.292-6" />
                            <circle cx="10" cy="8" r="5" />
                            <path d="M19 16v6" />
                            <path d="M22 19h-6" />
                          </svg>
                        </a>
                        <a href="/admin/user/<%= u.id %>/edit"
                          class="group/btn relative flex items-center justify-center rounded-lg bg-neutral-900 border border-neutral-800 p-2 text-neutral-400 hover:bg-neutral-800 hover:text-white transition-all hover:scale-110 active:scale-95"
                          title="Edit User">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                            <path d="M12 20h9" />
                            <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z" />
                          </svg>
                        </a>
                      </div>
                    </td>
                  </tr>
                  <% }) %>
                    <% } else { %>
                      <tr>
                        <td colspan="4" class="px-6 py-24 text-center">
                          <div class="flex flex-col items-center justify-center">
                            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-neutral-900">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="h-6 w-6 text-neutral-500">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                              </svg>
                            </div>
                            <h3 class="text-sm font-bold text-white">No Users Found</h3>
                            <p class="mt-1 text-xs text-neutral-500">There are no registered users at the moment.</p>
                          </div>
                        </td>
                      </tr>
                      <% } %>
            </tbody>
          </table>

          <!-- Empty State for Search (Hidden by default) -->
          <div id="noSearchResults" class="hidden flex-col items-center justify-center py-24 text-center">
            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-neutral-900">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="h-6 w-6 text-neutral-500">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
              </svg>
            </div>
            <h3 class="text-sm font-bold text-white">No Matches Found</h3>
            <p class="mt-1 text-xs text-neutral-500">Try adjusting your search terms.</p>
          </div>
        </div>

      </div>
    </main>

    <!-- Create User Modal -->
    <div id="createModal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
      <div id="modalContent"
        class="w-full max-w-md transform rounded-2xl border border-neutral-900 bg-black p-6 shadow-2xl transition-all scale-95 opacity-0">

        <div class="mb-6 flex items-center justify-between">
          <h2 class="text-lg font-bold text-white">Create New User</h2>
          <button onclick="closeCreateModal()" class="text-neutral-500 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="h-5 w-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-neutral-500">Username</label>
            <input id="u-username" placeholder="johndoe"
              class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2.5 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all" />
          </div>

          <div>
            <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-neutral-500">Email
              Address</label>
            <input id="u-email" type="email" placeholder="john@example.com"
              class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2.5 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all" />
          </div>

          <div>
            <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-neutral-500">Password</label>
            <input id="u-password" type="password" placeholder="••••••••"
              class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2.5 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all" />
          </div>

          <div class="flex items-center gap-3 rounded-lg border border-neutral-800 bg-neutral-900/50 p-3">
            <input type="checkbox" id="u-admin"
              class="h-5 w-5 rounded border-neutral-700 bg-neutral-800 text-white focus:ring-0 checked:bg-white checked:text-black">
            <label for="u-admin" class="text-sm font-medium text-white cursor-pointer select-none">Administrator
              Access</label>
          </div>
        </div>

        <div class="mt-8 grid grid-cols-2 gap-3">
          <button onclick="closeCreateModal()"
            class="rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2.5 text-sm font-bold text-neutral-300 transition-colors hover:bg-neutral-800">Cancel</button>
          <button onclick="createUser()"
            class="rounded-lg bg-white px-4 py-2.5 text-sm font-bold text-black transition-transform active:scale-95 hover:bg-neutral-200">Create
            User</button>
        </div>

      </div>
    </div>

    <script>
      // Search Functionality
      document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        const rows = document.querySelectorAll('.user-row');
        const noResults = document.getElementById('noSearchResults');
        const tableBody = document.getElementById('usersTableBody');

        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase().trim();
          let hasVisible = false;

          rows.forEach(row => {
            const username = row.dataset.username || '';
            const email = row.dataset.email || '';

            if (username.includes(term) || email.includes(term)) {
              row.style.display = '';
              hasVisible = true;
            } else {
              row.style.display = 'none';
            }
          });

          // Toggle Empty State
          if (!hasVisible && rows.length > 0) {
            noResults.classList.remove('hidden');
            noResults.classList.add('flex');
            // Hide header if no results? optional style choice. keeping header visible.
          } else {
            noResults.classList.add('hidden');
            noResults.classList.remove('flex');
          }
        });
      });

      const modal = document.getElementById("createModal");
      const modalContent = document.getElementById("modalContent");

      function openCreateModal() {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        // Trigger reflow
        void modal.offsetWidth;
        modalContent.classList.remove("scale-95", "opacity-0");
        modalContent.classList.add("scale-100", "opacity-100");
      }

      function closeCreateModal() {
        modalContent.classList.remove("scale-100", "opacity-100");
        modalContent.classList.add("scale-95", "opacity-0");
        setTimeout(() => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }, 200);
      }

      async function createUser() {
        const username = document.getElementById("u-username").value;
        const email = document.getElementById("u-email").value;
        const password = document.getElementById("u-password").value;
        const admin = document.getElementById("u-admin").checked;

        if (!username || !email || !password) return alert("All fields are required");

        const res = await fetch("/admin/users/new", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, email, password, admin })
        });

        if (res.ok) location.reload();
        else alert("Failed to create user");
      }
    </script>
</body>

</html>