<!DOCTYPE html>
<html lang="en" class="h-full bg-black text-white font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= name %> - Servers
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #000;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }
  </style>
</head>

<body class="flex h-full w-full overflow-hidden">
  <%- include('../../components/sidebar', { name, user }) %>

    <main class="relative flex-1 overflow-y-auto bg-black">
      <div class="mx-auto max-w-7xl px-6 py-12 md:px-12 animate-fade-in-up">

        <!-- Header -->
        <div class="mb-12 flex flex-col justify-between gap-6 md:flex-row md:items-end">
          <div>
            <h1 class="text-3xl font-bold tracking-tight text-white md:text-4xl">Servers</h1>
            <p class="mt-2 text-neutral-400">View and manage all user servers.</p>
          </div>
          <div class="flex items-center gap-4">
            <!-- Search Input -->
            <div class="relative group">
              <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="h-5 w-5 text-neutral-500 group-focus-within:text-white transition-colors">
                  <circle cx="11" cy="11" r="8" />
                  <path d="m21 21-4.3-4.3" />
                </svg>
              </div>
              <input type="text" id="searchInput" placeholder="Search by User, Email or ID..."
                class="block w-full rounded-xl border border-neutral-800 bg-neutral-900/50 py-2.5 pl-11 pr-4 text-sm text-white placeholder-neutral-500 outline-none ring-0 transition-all focus:border-neutral-700 focus:bg-neutral-900 focus:ring-1 focus:ring-neutral-700 md:w-72" />
            </div>

            <a href="/admin/servers/new"
              class="flex items-center gap-2 rounded-xl bg-white px-5 py-2.5 text-sm font-bold text-black transition-transform active:scale-95 hover:bg-neutral-200 hover:scale-105">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                <path d="M5 12h14" />
                <path d="M12 5v14" />
              </svg>
              Create Server
            </a>
          </div>
        </div>

        <!-- Servers Table -->
        <div class="overflow-hidden rounded-2xl border border-neutral-900 bg-neutral-950 shadow-2xl">
          <table class="w-full text-left text-sm">
            <thead class="border-b border-neutral-900 bg-neutral-900/50 text-neutral-400">
              <tr>
                <th class="px-6 py-4 font-medium">Server</th>
                <th class="px-6 py-4 font-medium">Owner</th>
                <th class="px-6 py-4 font-medium">Status</th>
                <th class="px-6 py-4 font-medium">Node</th>
                <th class="px-6 py-4 text-right font-medium">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-900" id="serversTableBody">
              <% if (servers && servers.length> 0) { %>
                <% servers.forEach((server, index)=> {
                  const owner = users.find(u => u.id === server.userId);
                  const ownerName = owner ? owner.username.toLowerCase() : 'unknown';
                  const ownerEmail = owner ? owner.email.toLowerCase() : '';
                  %>
                  <tr class="group hover:bg-neutral-900/40 transition-colors server-row animate-fade-in-up"
                    style="animation-delay: <%= Math.min(index * 50, 500) %>ms;"
                    data-server-name="<%= server.name.toLowerCase() %>" data-server-id="<%= server.id.toLowerCase() %>"
                    data-owner-name="<%= ownerName %>" data-owner-email="<%= ownerEmail %>">

                    <!-- Server Name & ID -->
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-4">
                        <div
                          class="flex h-10 w-10 items-center justify-center rounded-lg bg-neutral-900 text-neutral-400 group-hover:bg-white group-hover:text-black transition-all">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                            <rect width="20" height="8" x="2" y="2" rx="2" ry="2" />
                            <rect width="20" height="8" x="2" y="14" rx="2" ry="2" />
                            <line x1="6" x2="6.01" y1="6" y2="6" />
                            <line x1="6" x2="6.01" y1="18" y2="18" />
                          </svg>
                        </div>
                        <div>
                          <div class="font-bold text-white">
                            <%= server.name %>
                          </div>
                          <div class="font-mono text-xs text-neutral-500" title="Server ID">
                            <%= server.id.substring(0, 8) %>...
                          </div>
                        </div>
                      </div>
                    </td>

                    <!-- Owner -->
                    <td class="px-6 py-4">
                      <% if (owner) { %>
                        <div class="flex items-center gap-3">
                          <img
                            src="https://api.dicebear.com/9.x/notionists-neutral/svg?seed=<%= owner.username %>&backgroundColor=transparent"
                            alt="Avatar" class="h-8 w-8 rounded-lg bg-neutral-900 object-cover p-0.5">
                          <div class="flex flex-col">
                            <span class="text-white font-medium">
                              <%= owner.username %>
                            </span>
                            <span class="text-xs text-neutral-500">
                              <%= owner.email %>
                            </span>
                          </div>
                        </div>
                        <% } else { %>
                          <span class="text-neutral-500 italic">Unknown Owner</span>
                          <% } %>
                    </td>

                    <!-- Status -->
                    <td class="px-6 py-4">
                      <% if (server.suspended) { %>
                        <span
                          class="inline-flex items-center gap-1.5 rounded-full bg-red-500/10 px-2.5 py-1 text-xs font-bold text-red-500 border border-red-500/20 animate-pulse">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3 w-3">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" x2="12" y1="8" y2="12" />
                            <line x1="12" x2="12.01" y1="16" y2="16" />
                          </svg>
                          Suspended
                        </span>
                        <% } else { %>
                          <span
                            class="inline-flex items-center gap-1.5 rounded-full bg-emerald-500/10 px-2.5 py-1 text-xs font-bold text-emerald-500 border border-emerald-500/20">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                              class="h-3 w-3">
                              <polyline points="20 6 9 17 4 12" />
                            </svg>
                            Active
                          </span>
                          <% } %>
                    </td>

                    <!-- Node Info -->
                    <td class="px-6 py-4">
                      <div>
                        <div class="text-sm font-medium text-white">
                          <%= server.node?.name || 'Unknown' %>
                        </div>
                        <div class="font-mono text-xs text-neutral-500">
                          <%= server.node?.ip %>:<%= server.port %>
                        </div>
                      </div>
                    </td>

                    <!-- Actions -->
                    <td class="px-6 py-4 text-right">
                      <div class="flex items-center justify-end gap-2">
                        <a href="/admin/server/edit/<%= server.id %>"
                          class="group/btn relative flex items-center justify-center rounded-lg bg-neutral-900 border border-neutral-800 p-2 text-neutral-400 hover:bg-neutral-800 hover:text-white transition-all hover:scale-110 active:scale-95"
                          title="Edit Server">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                            <path d="M12 20h9" />
                            <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z" />
                          </svg>
                        </a>

                        <button onclick="toggleSuspend('<%= server.id %>', <%= server.suspended %>)"
                          class="group/btn relative flex items-center justify-center rounded-lg bg-neutral-900 border border-neutral-800 p-2 text-neutral-400 hover:bg-neutral-800 hover:text-white transition-all hover:scale-110 active:scale-95"
                          title="<%= server.suspended ? 'Unsuspend' : 'Suspend' %>">
                          <% if (server.suspended) { %>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                              class="h-4 w-4 text-emerald-500">
                              <polygon points="5 3 19 12 5 21 5 3" />
                              <line x1="5" x2="19" y1="3" y2="21" />
                            </svg>
                            <% } else { %>
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                class="h-4 w-4 text-yellow-500">
                                <rect x="6" y="4" width="4" height="16" rx="1" />
                                <rect x="14" y="4" width="4" height="16" rx="1" />
                              </svg>
                              <% } %>
                        </button>

                        <button onclick="deleteServer('<%= server.id %>')"
                          class="group/btn relative flex items-center justify-center rounded-lg bg-red-500/10 border border-red-500/20 p-2 text-red-500 hover:bg-red-500 hover:text-white transition-all hover:scale-110 active:scale-95"
                          title="Delete Server">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                            <path d="M3 6h18" />
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                            <line x1="10" x2="10" y1="11" y2="17" />
                            <line x1="14" x2="14" y1="11" y2="17" />
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <% }) %>
                    <% } else { %>
                      <tr>
                        <td colspan="5" class="px-6 py-24 text-center">
                          <div class="flex flex-col items-center justify-center">
                            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-neutral-900">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                class="h-6 w-6 text-neutral-500">
                                <rect width="20" height="8" x="2" y="2" rx="2" ry="2" />
                                <rect width="20" height="8" x="2" y="14" rx="2" ry="2" />
                                <line x1="6" x2="6.01" y1="6" y2="6" />
                                <line x1="6" x2="6.01" y1="18" y2="18" />
                              </svg>
                            </div>
                            <h3 class="text-sm font-bold text-white">No Servers Found</h3>
                            <p class="mt-1 text-xs text-neutral-500">No servers have been created yet.</p>
                          </div>
                        </td>
                      </tr>
                      <% } %>
            </tbody>
          </table>

          <!-- Empty State for Search -->
          <div id="noSearchResults" class="hidden flex-col items-center justify-center py-24 text-center">
            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-neutral-900">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-neutral-500">
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.3-4.3" />
              </svg>
            </div>
            <h3 class="text-sm font-bold text-white">No Matches Found</h3>
            <p class="mt-1 text-xs text-neutral-500">Try adjusting your search terms.</p>
          </div>
        </div>

      </div>
    </main>

    <script>
      // Search Functionality
      document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        const rows = document.querySelectorAll('.server-row');
        const noResults = document.getElementById('noSearchResults');

        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase().trim();
          let hasVisible = false;

          rows.forEach(row => {
            const name = row.dataset.serverName || '';
            const id = row.dataset.serverId || '';
            const ownerName = row.dataset.ownerName || '';
            const ownerEmail = row.dataset.ownerEmail || '';

            if (name.includes(term) || id.includes(term) || ownerName.includes(term) || ownerEmail.includes(term)) {
              row.style.display = '';
              hasVisible = true;
            } else {
              row.style.display = 'none';
            }
          });

          if (!hasVisible && rows.length > 0) {
            noResults.classList.remove('hidden');
            noResults.classList.add('flex');
          } else {
            noResults.classList.add('hidden');
            noResults.classList.remove('flex');
          }
        });
      });

      async function deleteServer(id) {
        if (!confirm("Are you sure you want to delete this server?")) return;
        const res = await fetch(`/admin/servers/delete/${id}`, {
          method: "DELETE",
        });
        if (res.ok) location.reload();
        else alert("Failed to delete server");
      }

      async function toggleSuspend(id, currentlySuspended) {
        const action = currentlySuspended ? "unsuspend" : "suspend";
        const res = await fetch(`/admin/servers/${action}/${id}`, {
          method: "POST",
        });
        if (res.ok) location.reload();
        else alert(`Failed to ${action} server`);
      }
    </script>

</body>

</html>