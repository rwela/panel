<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-space-grotesk">
  <head>
    <meta charset="UTF-8" />
    <title><%= name %> - Servers</title>
    <link rel="stylesheet" href="/assets/tailwind.css">
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="min-h-screen flex">
    <%- include('../../components/sidebar', { name, user }) %>

    <main class="flex-1 p-8 overflow-auto">
      <div class="max-w-6xl mx-auto space-y-6">
        <div
          class="bg-neutral-950 border border-neutral-900 p-6 rounded-md flex justify-between items-center"
        >
         <div>
  <h1 class="text-3xl font-bold flex items-center gap-2">
    <i data-lucide="server" class="w-6 h-6"></i> Servers
  </h1>
  <p class="text-gray-400">Manage all user servers</p>
</div>

          <a
            href="/admin/servers/new"
            class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-xl font-medium"
          >
            + Create Server
          </a>
        </div>
<div class="bg-neutral-950 border border-neutral-900 rounded-lg overflow-hidden">
  <table class="w-full table-auto text-left border-collapse">
    <thead class="text-neutral-400 uppercase text-xs border-b border-neutral-800">
      <tr>
        <th class="px-4 py-2">Name</th>
        <th class="px-4 py-2">Owner</th>
        <th class="px-4 py-2">Node</th>
        <th class="px-4 py-2">IP</th>
        <th class="px-4 py-2 text-right">Status / Actions</th>
      </tr>
    </thead>

    <tbody>
      <% if (servers && servers.length > 0) { %>
        <% servers.forEach(server => { 
             const owner = users.find(u => u.id === server.userId);
        %>
          <tr onclick="window.location.href='/admin/server/<%= server.id %>'"class="cursor-pointer border-b border-neutral-800 hover:bg-neutral-900/50 transition-colors">
            
            <!-- Name -->
            <td class="px-4 py-3 font-semibold text-gray-100 flex items-center gap-2">
              <i data-lucide="server" class="w-5 h-5"></i>
              <%= server.name %>

              <% if (server.suspended) { %>
                <span class="ml-2 px-2 py-0.5 text-xs font-semibold text-red-100 bg-red-600 rounded-full">
                  Suspended
                </span>
              <% } %>
            </td>

            <!-- Owner -->
            <td class="px-4 py-3 text-gray-400">
              <%= owner ? owner.username : 'Unknown' %>
            </td>

            <!-- Node -->
            <td class="px-4 py-3 text-gray-400">
              <%= server.node?.name || 'Unknown' %>
            </td>

            <!-- IP -->
            <td class="px-4 py-3 text-gray-400">
              <%= server.node?.ip %>:<%= server.port %>
            </td>

            <!-- Actions -->
            <td class="px-4 py-3 text-right flex justify-end gap-2">

              <!-- Suspend / Unsuspend -->
              <button
                onclick="toggleSuspend('<%= server.id %>', <%= server.suspended %>)"
                class="px-3 py-1 text-xs font-semibold rounded-lg
                  <%= server.suspended
                    ? 'bg-yellow-600 hover:bg-yellow-700'
                    : 'bg-green-600 hover:bg-green-700' %>">
                <%= server.suspended ? 'Unsuspend' : 'Suspend' %>
              </button>

              <!-- Edit -->
              <a
                href="/admin/server/edit/<%= server.id %>"
                class="px-3 py-1 text-xs font-semibold rounded-lg bg-blue-600 hover:bg-blue-700">
                Edit
              </a>

              <!-- Delete -->
              <button
                onclick="deleteServer('<%= server.id %>')"
                class="px-3 py-1 text-xs font-semibold rounded-lg bg-red-600 hover:bg-red-700">
                Delete
              </button>

            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="5" class="px-4 py-6 text-neutral-500 italic text-center">
            No servers found.
          </td>
        </tr>
      <% } %>
    </tbody>
  </table>
  <div class="flex items-center justify-between px-4 py-3 text-sm text-gray-400 border-t border-neutral-900">
  <span id="serversPaginationInfo"></span>

  <div class="flex gap-2">
    <button
      id="serversPrevPage"
      class="px-3 py-1 rounded-xl bg-neutral-800 hover:bg-neutral-700 disabled:opacity-50"
    >
      Prev
    </button>

    <button
      id="serversNextPage"
      class="px-3 py-1 rounded-xl bg-neutral-800 hover:bg-neutral-700 disabled:opacity-50"
    >
      Next
    </button>
  </div>
</div>

</div>
<script>
  const serversRowsPerPage = 8;
  const serversTableBody = document.querySelector("table tbody");
  const serversRows = Array.from(serversTableBody.querySelectorAll("tr"))
    .filter(row => !row.textContent.includes("No servers found"));

  let serversCurrentPage = 1;
  const serversTotalPages = Math.ceil(serversRows.length / serversRowsPerPage);

  const serversInfo = document.getElementById("serversPaginationInfo");
  const serversPrev = document.getElementById("serversPrevPage");
  const serversNext = document.getElementById("serversNextPage");

  function renderServersPage() {
    const start = (serversCurrentPage - 1) * serversRowsPerPage;
    const end = start + serversRowsPerPage;

    serversRows.forEach((row, index) => {
      row.style.display = index >= start && index < end ? "" : "none";
    });

    serversInfo.textContent = `Page ${serversCurrentPage} of ${serversTotalPages || 1}`;
    serversPrev.disabled = serversCurrentPage === 1;
    serversNext.disabled = serversCurrentPage === serversTotalPages;
  }

  serversPrev.onclick = () => {
    if (serversCurrentPage > 1) {
      serversCurrentPage--;
      renderServersPage();
    }
  };

  serversNext.onclick = () => {
    if (serversCurrentPage < serversTotalPages) {
      serversCurrentPage++;
      renderServersPage();
    }
  };

  renderServersPage();
</script>


      </div>
    </main>

    <script>
      lucide.createIcons();

      async function deleteServer(id) {
        if (!confirm("Are you sure you want to delete this server?")) return;
        const res = await fetch(`/admin/servers/delete/${id}`, {
          method: "DELETE",
        });
        if (res.ok) location.reload();
        else alert("Failed to delete server");
      }
      async function toggleSuspend(id, currentlySuspended) {
        const action = currentlySuspended ? "unsuspend" : "suspend";
        const res = await fetch(`/admin/servers/${action}/${id}`, {
          method: "POST",
        });
        if (res.ok) location.reload();
        else alert(`Failed to ${action} server`);
      }
       function goToServer(id) {
    window.location.href = `/admin/server/${id}`;
  }
    </script>
  </body>
</html>
