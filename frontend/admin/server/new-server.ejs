<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-space-grotesk">
<head>
  <meta charset="UTF-8" />
  <title><%= name %> - New Server</title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="flex h-screen">

  <!-- Sidebar -->
  <%- include('../../components/sidebar', { name, user }) %>

  <!-- Main Content -->
  <main class="flex-1 overflow-auto p-8 flex flex-col gap-6">
    <h1 class="text-3xl font-bold">ðŸ–¥ Create New Server</h1>
    <div class="bg-neutral-950 border border-neutral-800 rounded-md p-6 space-y-6">

    <!-- User and Node Selects -->
    <div class="flex flex-col md:flex-row gap-4 w-full">
      <select id="user" class="flex-1 p-3 rounded-xl bg-neutral-950 border border-neutral-800">
        <option value="">Select User</option>
        <% users.forEach(u => { %>
          <option value="<%= u.id %>"><%= u.username %></option>
        <% }) %>
      </select>

      <select id="node" class="flex-1 p-3 rounded-xl bg-neutral-950 border border-neutral-800" onchange="loadAllocations()">
        <option value="">Select Node</option>
        <% nodes.forEach(n => { %>
          <option value="<%= n.id %>" data-allocations="<%= encodeURIComponent(JSON.stringify(n.allocations || [])) %>">
            <%= n.name %> (<%= n.ip %>:<%= n.port %>)
          </option>
        <% }) %>
      </select>

      <select id="allocation" class="flex-1 p-3 rounded-xl bg-neutral-950 border border-neutral-800">
        <option value="">Select Allocation</option>
      </select>
    </div>

    <!-- Image Select -->
    <select id="image" class="p-3 rounded-xl bg-neutral-950 border border-neutral-800" onchange="loadImageEnv()">
      <option value="">Select Image</option>
      <% images.forEach(i => { %>
        <option value="<%= i.id %>" data-env="<%= encodeURIComponent(JSON.stringify(i.envs || {})) %>">
          <%= i.name %>
        </option>
      <% }) %>
    </select>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 w-full">
      <input id="name" placeholder="Server Name" class="p-3 rounded-xl bg-neutral-950 border border-neutral-800" />
      <input id="ram" placeholder="RAM (MB)" type="number" class="p-3 rounded-xl bg-neutral-950 border border-neutral-800" />
      <input id="core" placeholder="CPU Cores" type="number" class="p-3 rounded-xl bg-neutral-950 border border-neutral-800" />
      <input id="disk" placeholder="Disk (GB)" type="number" class="p-3 rounded-xl bg-neutral-950 border border-neutral-800" />
    </div>

    <div class="space-y-2">
      <label class="text-sm text-gray-400">Environment Variables</label>
      <div id="envList" class="space-y-2"></div>
    </div>

    <!-- Create Button -->
    <div class="flex justify-start">
      <button onclick="createServer()" id="createBtn" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-xl">
        Create
      </button>
    </div>
    </div>
  </main>
<!-- Modal at the bottom of body -->
  <div id="creating-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-neutral-950/80 backdrop-blur-sm opacity-0 transition-opacity duration-200" id="creating-overlay"></div>
    <div id="creating-panel" class="border border-neutral-900 relative z-10 max-w-md w-full mx-4 rounded-md bg-neutral-950 text-gray-100 shadow-xl ring-1 ring-black/10 overflow-hidden p-6 flex items-center gap-4 transform scale-95 opacity-0 transition-all duration-200">
      <i data-lucide="loader" class="w-6 h-6 animate-spin text-indigo-500"></i>
      <div>
        <h2 class="text-lg font-semibold">Creating Server</h2>
        <p class="text-sm text-neutral-300">Please waitâ€¦</p>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const creatingModal = document.getElementById("creating-modal");
  const creatingOverlay = document.getElementById("creating-overlay");
  const creatingPanel = document.getElementById("creating-panel");

  function showCreatingModal() {
    creatingModal.classList.remove("hidden");

    requestAnimationFrame(() => {
      creatingOverlay.classList.remove("opacity-0");
      creatingPanel.classList.remove("scale-95", "opacity-0");
      creatingPanel.classList.add("scale-100", "opacity-100");
    });
  }

  function hideCreatingModal() {
    creatingOverlay.classList.add("opacity-0");
    creatingPanel.classList.add("scale-95", "opacity-0");
    creatingPanel.classList.remove("scale-100", "opacity-100");

    setTimeout(() => {
      creatingModal.classList.add("hidden");
    }, 200); // matches transition duration
  }
    function loadAllocations() {
      const nodeSelect = document.getElementById("node");
      const allocSelect = document.getElementById("allocation");
      allocSelect.innerHTML = '<option value="">Select Allocation</option>';
      const nodeOption = nodeSelect.options[nodeSelect.selectedIndex];
      if (!nodeOption) return;

      const rawAlloc = nodeOption.dataset.allocations;
      const allocations = rawAlloc ? JSON.parse(decodeURIComponent(rawAlloc)) : [];
      allocations.forEach((a) => {
        if (a.allocationOwnedto?.serverId) return;
        const option = document.createElement("option");
        option.value = a.id;
        option.textContent = `${a.ip}:${a.port}`;
        allocSelect.appendChild(option);
      });
    }

    function loadImageEnv() {
      const select = document.getElementById("image");
      const option = select.options[select.selectedIndex];
      const raw = option.dataset.env;
      const envs = raw ? JSON.parse(decodeURIComponent(raw)) : {};
      const envList = document.getElementById("envList");
      envList.innerHTML = "";
      Object.entries(envs).forEach(([key, value]) => {
        const row = document.createElement("div");
        row.className = "flex gap-2";
        row.innerHTML = `
          <input value="${key}" disabled class="w-1/2 p-2 rounded-xl bg-neutral-900 border border-neutral-800 text-gray-400" />
          <input value="${value}" data-key="${key}" class="w-1/2 p-2 rounded-xl bg-neutral-950 border border-neutral-800" />
        `;
        envList.appendChild(row);
      });
    }

    function collectEnv() {
      const env = {};
      document.querySelectorAll("#envList input[data-key]").forEach(input => {
        env[input.dataset.key] = input.value;
      });
      return env;
    }

 async function createServer() {
    const btn = document.getElementById("createBtn");
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = "Creatingâ€¦";

    showCreatingModal();

    try {
      const res = await axios.post("/admin/servers/new", {
        userId: document.getElementById("user").value,
        nodeId: document.getElementById("node").value,
        allocationId: document.getElementById("allocation").value,
        imageId: document.getElementById("image").value,
        name: document.getElementById("name").value,
        ram: parseInt(document.getElementById("ram").value),
        core: parseInt(document.getElementById("core").value),
        disk: parseInt(document.getElementById("disk").value),
        env: collectEnv(),
      });

      if (res.data.success) {
        window.location.href = "/admin/servers";
      } else {
        throw new Error("Server creation failed");
        hideCreatingModal();
      }
    } catch (err) {
      alert("Failed to create server");
      console.error(err);
      btn.disabled = false;
      btn.textContent = originalText;
      hideCreatingModal();
    }
  }

    lucide.createIcons();
  </script>
</body>
</html>
