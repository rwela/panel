<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-space-grotesk">
  <head>
    <meta charset="UTF-8" />
    <title><%= name %> - Edit Server</title>
    <link rel="stylesheet" href="/assets/tailwind.css">
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="min-h-screen flex">
    <%- include('../../components/sidebar', { name, user }) %>

    <main class="flex-1 p-8 overflow-auto">
      <div class="max-w-xl mx-auto space-y-6">
        <h1 class="text-3xl font-bold mb-4">ðŸ–¥ Edit Server: <%= server.name %></h1>

        <div class="bg-neutral-900 border border-neutral-800 rounded-md p-6 space-y-4">
          <!-- Select User -->
          <select
            id="user"
            class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800"
          >
            <% users.forEach(u => { %>
            <option value="<%= u.id %>" <%= u.id === server.userId ? "selected" : "" %>>
              <%= u.username %>
            </option>
            <% }) %>
          </select>

          <!-- Select Node -->
          <select
            id="node"
            class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800"
          >
            <% nodes.forEach(n => { %>
            <option value="<%= n.id %>" <%= n.name === server.node.name ? "selected" : "" %>>
              <%= n.name %> (<%= n.ip %>:<%= n.port %>)
            </option>
            <% }) %>
          </select>

          <!-- Select Image -->
          <select
            id="image"
            class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800"
            onchange="loadImageEnv()"
          >
            <% images.forEach(i => { %>
            <option
              value="<%= i.id %>"
              data-env="<%= encodeURIComponent(JSON.stringify(i.envs || {})) %>"
              <%= i.id === server.imageId ? "selected" : "" %>
            >
              <%= i.name %>
            </option>
            <% }) %>
          </select>

          <!-- Server Info -->
          <input
            id="name"
            placeholder="Server Name"
            value="<%= server.name %>"
            class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800"
          />
          <input
            id="ram"
            placeholder="RAM (MB)"
            type="number"
            value="<%= server.ram %>"
            class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800"
          />
          <input
            id="core"
            placeholder="CPU Cores"
            type="number"
            value="<%= server.core %>"
            class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800"
          />
          <input
            id="disk"
            placeholder="Disk (GB)"
            type="number"
            value="<%= server.disk %>"
            class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800"
          />
          <!--input
            id="port"
            placeholder="Port"
            type="number"
            value="<%= server.port %>"
            class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800"
          /--->

          <!-- ENV Editor -->
          <div class="space-y-2">
            <label class="text-sm text-gray-400">Environment Variables</label>
            <div id="envList" class="space-y-2"></div>
          </div>

          <div class="flex justify-end">
            <button
              onclick="editServer()"
              id="editBtn"
              class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-xl"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const serverEnv = <%- JSON.stringify(server.env || {}) %>;

      function loadImageEnv() {
        const select = document.getElementById("image");
        const option = select.options[select.selectedIndex];
        const raw = option.dataset.env;
        const envs = raw ? JSON.parse(decodeURIComponent(raw)) : {};

        const envList = document.getElementById("envList");
        envList.innerHTML = "";

        // Merge current server env with image defaults
        const mergedEnv = { ...envs, ...serverEnv };

        Object.entries(mergedEnv).forEach(([key, value]) => {
          const row = document.createElement("div");
          row.className = "flex gap-2";

          row.innerHTML = `
            <input
              value="${key}"
              disabled
              class="w-1/2 p-2 rounded-xl bg-neutral-900 border border-neutral-800 text-gray-400"
            />
            <input
              value="${value}"
              data-key="${key}"
              class="w-1/2 p-2 rounded-xl bg-neutral-950 border border-neutral-800"
            />
          `;

          envList.appendChild(row);
        });
      }

      function collectEnv() {
        const env = {};
        document
          .querySelectorAll("#envList input[data-key]")
          .forEach((input) => {
            env[input.dataset.key] = input.value;
          });
        return env;
      }

      async function editServer() {
        const btn = document.getElementById("editBtn");
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = "Savingâ€¦";

        const serverId = "<%= server.id %>";

        try {
          const res = await axios.post(`/admin/edit/${serverId}`, {
            userId: document.getElementById("user").value,
            nodeId: document.getElementById("node").value,
            imageId: document.getElementById("image").value,
            name: document.getElementById("name").value,
            ram: parseInt(document.getElementById("ram").value),
            core: parseInt(document.getElementById("core").value),
            disk: parseInt(document.getElementById("disk").value),
       //     port: parseInt(document.getElementById("port").value),
            env: collectEnv()
          });

          if (res.data.success) {
            window.location.href = "/admin/servers";
          } else {
            throw new Error("Server update failed");
          }
        } catch (err) {
          alert("Failed to update server");
          console.error(err);
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      loadImageEnv();
      lucide.createIcons();
    </script>
  </body>
</html>
