<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-space-grotesk">

<head>
  <meta charset="UTF-8">
  <title>
    <%= name %> - New Image
  </title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="/assets/tailwind.css">
</head>

<body class="min-h-screen flex">
  <%- include('../../components/sidebar', { name, user }) %>

    <main class="flex-1 flex items-center justify-center p-10 overflow-auto">
      <div class="w-full max-w-5xl">

        <!-- HEADER -->
        <div class="mb-10 border border-neutral-800 rounded-md p-6 bg-neutral-950">
          <h1 class="text-4xl font-bold tracking-tight">Create Image</h1>
          <p class="text-gray-400 mt-2">
            Configure image metadata, variables, and features.
          </p>
        </div>

        <!-- GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

          <!-- IMAGE INFO (FULL WIDTH) -->
          <section class="lg:col-span-2 border border-neutral-800 rounded-md p-6 space-y-4">
            <h2 class="text-lg font-semibold">Image Information</h2>

            <input id="dockerImage" placeholder="Docker Image (e.g. ubuntu:latest)"
              class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800">

            <input id="name" placeholder="Image Name"
              class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800">

            <input id="description" placeholder="Description (optional)"
              class="w-full p-3 rounded-xl bg-neutral-950 border border-neutral-800">
          </section>

          <!-- ENVS (LEFT) -->
          <section class="border border-neutral-800 rounded-md p-6 space-y-4">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-semibold">Environment Variables</h2>
              <button onclick="addEnv()"
                class="px-3 py-1 text-sm rounded-lg border border-neutral-800 hover:border-neutral-700">
                + Add
              </button>
            </div>

            <div id="envsContainer" class="space-y-2"></div>
          </section>

          <!-- FEATURES (RIGHT) -->
          <section class="border border-neutral-800 rounded-md p-6 space-y-4">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-semibold">Features</h2>
              <button onclick="addFeature()"
                class="px-3 py-1 text-sm rounded-lg border border-neutral-800 hover:border-neutral-700">
                + Add
              </button>
            </div>

            <div id="featuresContainer" class="space-y-2"></div>
          </section>

          <!-- FILES (FULL WIDTH) -->
          <section class="lg:col-span-2 border border-neutral-800 rounded-md p-6 space-y-4">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-semibold">Files</h2>
              <button onclick="addFile()"
                class="px-3 py-1 text-sm rounded-lg border border-neutral-800 hover:border-neutral-700">
                + Add
              </button>
            </div>

            <div id="filesContainer" class="space-y-2"></div>
          </section>

        </div>

        <!-- ACTIONS -->
        <div class="flex justify-end gap-3 mt-10">
          <a href="/admin/images" class="px-5 py-2 rounded-xl border border-neutral-800 hover:border-neutral-700">
            Cancel
          </a>

          <button onclick="createImage()" class="px-6 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 font-medium">
            Create Image
          </button>
        </div>

      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      lucide.createIcons();
      let featureCount = 0;
      let envCount = 0;
      let fileCount = 0;
      function addEnv(key = '', value = '') {
        const div = document.createElement('div');
        div.className = "relative flex-1"; 
        div.innerHTML = `
     <input placeholder="Key" value="" class="w-full p-2 rounded-xl bg-neutral-950 border border-neutral-800 pr-8">
  <input placeholder="Value" value="" class="w-full p-2 rounded-xl bg-neutral-950 border border-neutral-800 pr-8">
  <button onclick="this.parentNode.remove()"
    class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500">
    ✕
  </button>

  `;
        envsContainer.appendChild(div);
      }

      function addFile(filename = '', url = '') {
        const div = document.createElement('div');
        div.className = 'flex gap-2 items-center'; // added items-center
        div.innerHTML = `
    <input placeholder="Filename" value="${filename}"
      class="flex-1 p-2 rounded-xl bg-neutral-950 border border-neutral-800">
    <input placeholder="URL" value="${url}"
      class="flex-1 p-2 rounded-xl bg-neutral-950 border border-neutral-800">
    <button onclick="this.parentNode.remove()"
      class="px-3 py-2 rounded-xl border border-neutral-800 hover:border-neutral-700">
      ✕
    </button>
  `;
        filesContainer.appendChild(div);
      }

      function addFeature(value = '') {
        const div = document.createElement('div');
        div.className = 'flex gap-2 items-center'; // added items-center
        div.innerHTML = `
    <input placeholder="Feature (e.g. eula)" value="${value}"
      class="flex-1 p-2 rounded-xl bg-neutral-950 border border-neutral-800">
    <button onclick="this.parentNode.remove()"
      class="px-3 py-2 rounded-xl border border-neutral-800 hover:border-neutral-700">
      ✕
    </button>
  `;
        featuresContainer.appendChild(div);
      }


      async function createImage() {
        try {
          // Collect ENVs
          const envs = {};
          document.querySelectorAll('#envsContainer > div').forEach(div => {
            const [keyInput, valueInput] = div.querySelectorAll('input');
            if (keyInput.value) envs[keyInput.value] = valueInput.value;
          });

          // Collect Files
          const files = [];
          document.querySelectorAll('#filesContainer > div').forEach(div => {
            const [filenameInput, urlInput] = div.querySelectorAll('input');
            if (filenameInput.value && urlInput.value) files.push({ filename: filenameInput.value, url: urlInput.value });
          });

          const features = [];
          document.querySelectorAll('#featuresContainer input').forEach(input => {
            if (input.value.trim()) features.push(input.value.trim());
          });

          const res = await axios.post('/admin/images/new', {
            dockerImage: document.getElementById('dockerImage').value,
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            envs,
            files,
            features
          });

          if (res.data.success) window.location.href = '/admin/images';
        } catch (err) {
          alert("Failed to create image. Check your inputs.");
          console.error(err);
        }
      }
    </script>
</body>

</html>